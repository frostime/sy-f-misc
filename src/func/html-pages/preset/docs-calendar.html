<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ€æºæ—¥å† - Bulmaç‰ˆ</title>

    <link rel="stylesheet" href="https://cdn.staticfile.org/bulma/0.9.4/css/bulma.min.css">
    <script src="https://cdn.staticfile.org/fullcalendar/6.1.10/index.global.min.js"></script>

    <style>
        /* === æ˜æš—æ¨¡å¼å˜é‡é…ç½® === */
        :root {
            --calendar-bg: #ffffff;
            --calendar-text: #363636;
            --calendar-border: #dbdbdb;
            --calendar-hover: #f5f5f5;
            --calendar-today: #eff5fb;
            --modal-bg: #ffffff;
            --input-bg: #ffffff;
            --list-hover: #f5f5f5;
            --shadow-color: rgba(10, 10, 10, 0.1);
        }

        /* æš—è‰²æ¨¡å¼å˜é‡ */
        body.dark-mode {
            --calendar-bg: #1a1a1a;
            --calendar-text: #e0e0e0;
            --calendar-border: #404040;
            --calendar-hover: #2a2a2a;
            --calendar-today: #1e3a5f;
            --modal-bg: #242424;
            --input-bg: #2a2a2a;
            --list-hover: #2a2a2a;
            --shadow-color: rgba(0, 0, 0, 0.5);
        }

        /* === åŸºç¡€å¸ƒå±€ === */
        body {
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-color: var(--calendar-bg);
            color: var(--calendar-text);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* === æ—¥å†å®¹å™¨ === */
        #calendar-container {
            flex: 1;
            padding: 1.5rem;
            position: relative;
            overflow: auto;
        }

        #calendar {
            height: 100%;
            background-color: var(--calendar-bg);
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 8px var(--shadow-color);
            transition: all 0.3s ease;
        }

        /* === FullCalendar æ ·å¼å®šåˆ¶ === */
        .fc {
            color: var(--calendar-text);
        }

        .fc-theme-standard td,
        .fc-theme-standard th {
            border-color: var(--calendar-border);
        }

        .fc-col-header-cell {
            background-color: var(--calendar-bg);
            padding: 0.75rem 0;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        .fc-col-header-cell-cushion,
        .fc-daygrid-day-number {
            color: var(--calendar-text);
            text-decoration: none !important;
        }

        .fc-daygrid-day {
            transition: background-color 0.2s ease;
        }

        .fc-daygrid-day:hover {
            background-color: var(--calendar-hover);
        }

        .fc-daygrid-day-top {
            padding: 0.5rem;
        }

        .fc-daygrid-day-number {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 500;
        }

        .fc-day-today {
            background-color: var(--calendar-today) !important;
        }

        .fc-day-today .fc-daygrid-day-number {
            color: #3273dc;
            font-weight: 700;
        }

        /* å·¥å…·æ æŒ‰é’® */
        .fc-button {
            background-color: #3273dc !important;
            border-color: #3273dc !important;
            transition: all 0.2s ease;
            text-transform: capitalize;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(50, 115, 220, 0.2);
        }

        .fc-button:hover {
            background-color: #2366d1 !important;
            border-color: #2366d1 !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(50, 115, 220, 0.3);
        }

        .fc-button:active,
        .fc-button:focus {
            background-color: #1f5bb7 !important;
            border-color: #1f5bb7 !important;
        }

        .fc-button-active {
            background-color: #1f5bb7 !important;
            border-color: #1f5bb7 !important;
        }

        .fc-toolbar-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--calendar-text);
        }

        /* äº‹ä»¶å—æ ·å¼ */
        .fc-event {
            border: none;
            cursor: pointer;
            border-radius: 4px;
            padding: 2px 4px;
            margin: 1px 2px;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
        }

        .fc-event:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.25);
            opacity: 0.9;
        }

        .fc-event-content-box {
            display: flex;
            align-items: center;
            font-size: 0.85em;
            overflow: hidden;
            white-space: nowrap;
        }

        /* === æ¨¡æ€æ¡†æ ·å¼ === */
        body.dark-mode .modal-card-head,
        body.dark-mode .modal-card-body,
        body.dark-mode .modal-card-foot {
            background-color: var(--modal-bg);
            border-color: var(--calendar-border);
        }

        body.dark-mode .modal-card-title,
        body.dark-mode .title,
        body.dark-mode .subtitle,
        body.dark-mode .content {
            color: var(--calendar-text) !important;
        }

        .modal-card {
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 8px 32px var(--shadow-color);
        }

        .modal-card-head {
            padding: 1.5rem;
            border-bottom: 2px solid var(--calendar-border);
        }

        .modal-card-title {
            font-weight: 700;
        }

        .modal-card-body {
            padding: 1.5rem;
            max-height: 70vh;
            overflow-y: auto;
        }

        /* === è¾“å…¥æ¡†æ ·å¼ === */
        body.dark-mode .input,
        body.dark-mode .select select {
            background-color: var(--input-bg);
            border-color: var(--calendar-border);
            color: var(--calendar-text);
        }

        body.dark-mode .input:focus,
        body.dark-mode .select select:focus {
            border-color: #3273dc;
        }

        .select select {
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .select select:focus {
            box-shadow: 0 0 0 0.125em rgba(50, 115, 220, 0.25);
        }

        /* === æ–‡æ¡£åˆ—è¡¨é¡¹ === */
        .doc-list-item {
            padding: 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            margin-bottom: 0.5rem;
            background-color: var(--calendar-bg);
        }

        .doc-list-item:hover {
            background-color: var(--list-hover);
            border-color: var(--calendar-border);
            transform: translateX(4px);
            box-shadow: 0 2px 8px var(--shadow-color);
        }

        .doc-list-item:last-child {
            margin-bottom: 0;
        }

        /* === åˆ†éš”çº¿ === */
        hr {
            background-color: var(--calendar-border);
            height: 1px;
            margin: 1.5rem 0;
        }

        /* === æŒ‰é’®å¢å¼º === */
        .button.is-primary {
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(50, 115, 220, 0.2);
        }

        .button.is-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(50, 115, 220, 0.3);
        }

        /* === çŠ¶æ€æ  === */
        #status-bar {
            border-radius: 0;
            margin: 0;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* === å°æ ‡é¢˜æ ·å¼ === */
        .section-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            opacity: 0.8;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        /* === æ»šåŠ¨æ¡ç¾åŒ– === */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--calendar-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--calendar-border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #888;
        }

        body.dark-mode ::-webkit-scrollbar-thumb {
            background: #555;
        }

        body.dark-mode ::-webkit-scrollbar-thumb:hover {
            background: #777;
        }
    </style>
</head>

<body>

    <div id="status-bar" class="notification is-danger is-light p-2 is-hidden" style="margin:0; border-radius:0;">
        æ— æ³•åŠ è½½ FullCalendar åº“ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æ›´æ¢ CDNã€‚
    </div>

    <div id='calendar-container'>
        <div id='calendar'></div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-background" onclick="closeModal()"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title is-size-5" id="modal-title">æ—¥æœŸè¯¦æƒ…</p>
                <button class="delete" aria-label="close" onclick="closeModal()"></button>
            </header>

            <section class="modal-card-body">
                <div class="mb-5">
                    <h6 class="section-title title is-6">ğŸ“‘ å½“æ—¥å·²æœ‰æ–‡æ¡£</h6>
                    <div id="doc-list" class="content">
                    </div>
                </div>

                <hr>

                <div>
                    <h6 class="section-title title is-6">ğŸ“ æ–°å»ºæ—¥è®°</h6>
                    <div class="field has-addons">
                        <div class="control is-expanded">
                            <div class="select is-fullwidth">
                                <select id="notebook-select">
                                    <option>åŠ è½½ç¬”è®°æœ¬ä¸­...</option>
                                </select>
                            </div>
                        </div>
                        <div class="control">
                            <button class="button is-primary" id="btn-create">
                                <span>æ–°å»º</span>
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        // --- å…¨å±€å˜é‡ ---
        let calendar = null;
        let notebooksCache = [];
        let boxIdToNameMap = {};
        let currentSelectedDate = null;

        // --- åˆå§‹åŒ–å…¥å£ ---
        window.addEventListener('pluginSdkReady', async () => {
            if (!checkDependencies()) return;

            // åº”ç”¨ä¸»é¢˜æ¨¡å¼
            applyThemeMode();

            // 1. åˆå§‹åŒ–æ•°æ®
            await fetchNotebooks();

            // 2. åˆå§‹åŒ–æ—¥å†
            initCalendar();
        });

        // åº”ç”¨ä¸»é¢˜æ¨¡å¼
        function applyThemeMode() {
            const themeMode = window.pluginSdk?.themeMode || 'light';
            if (themeMode === 'dark') {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
        }

        // ä¾èµ–æ£€æŸ¥
        function checkDependencies() {
            if (typeof FullCalendar === 'undefined') {
                document.getElementById('status-bar').classList.remove('is-hidden');
                return false;
            }
            return true;
        }

        // --- æ ¸å¿ƒé€»è¾‘ ---

        async function fetchNotebooks() {
            try {
                const notebooks = await window.pluginSdk.lsNotebooks();
                notebooksCache = notebooks.filter(nb => !nb.closed);

                // å»ºç«‹æ˜ å°„
                const select = document.getElementById('notebook-select');
                select.innerHTML = '';

                notebooksCache.forEach(nb => {
                    boxIdToNameMap[nb.id] = nb.name;
                    const option = document.createElement('option');
                    option.value = nb.id;
                    option.textContent = nb.name;
                    select.appendChild(option);
                });

                if (notebooksCache.length === 0) {
                    const opt = document.createElement('option');
                    opt.text = "æ— å¯ç”¨ç¬”è®°æœ¬";
                    select.appendChild(opt);
                }
            } catch (e) {
                console.error("è·å–ç¬”è®°æœ¬å¤±è´¥", e);
            }
        }

        function initCalendar() {
            const calendarEl = document.getElementById('calendar');

            calendar = new FullCalendar.Calendar(calendarEl, {
                // è§†å›¾è®¾ç½®
                initialView: 'dayGridMonth',
                locale: 'zh-cn',
                firstDay: 1, // å‘¨ä¸€ä½œä¸ºç¬¬ä¸€å¤©
                height: '100%',

                // é¡¶éƒ¨å·¥å…·æ 
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,dayGridWeek'
                },

                // æ•°æ®æº
                events: fetchEventsSource,

                // äº¤äº’
                dateClick: (info) => openModal(info.date),
                eventClick: (info) => {
                    info.jsEvent.preventDefault();
                    if (info.event.id) window.pluginSdk.openBlock(info.event.id);
                },

                // è‡ªå®šä¹‰æ¸²æŸ“å†…å®¹
                eventContent: function (arg) {
                    const title = arg.event.title;
                    const notebookName = arg.event.extendedProps.notebookName;

                    return {
                        html: `
                        <div class="fc-event-content-box">
                            <span style="color:rgba(255,255,255,0.7); font-size: 0.8em; margin-right:4px;">[${notebookName}]</span>
                            <span class="text-truncate">${title}</span>
                        </div>
                        `
                    }
                }
            });

            calendar.render();
        }

        // æ•°æ®åŠ è½½å™¨ (é€‚é… FullCalendar æ¥å£)
        async function fetchEventsSource(info, successCallback, failureCallback) {
            try {
                const startStr = formatDateToSy(info.start);
                const endStr = formatDateToSy(info.end);

                // æŸ¥è¯¢ï¼šæ–‡æ¡£ç±»å‹ (type='d')
                const sql = `
                    SELECT id, box, name, content, created
                    FROM blocks
                    WHERE type = 'd'
                    AND created >= '${startStr}'
                    AND created < '${endStr}'
                    LIMIT 2000
                `;

                const blocks = await window.pluginSdk.querySQL(sql);

                const events = blocks.map(block => {
                    const color = stringToColor(block.box); // æ ¹æ®ç¬”è®°æœ¬IDç”Ÿæˆé¢œè‰²
                    return {
                        id: block.id,
                        title: block.name || block.content || 'æœªå‘½åæ–‡æ¡£',
                        start: parseSyDate(block.created),
                        allDay: true,
                        backgroundColor: color,
                        borderColor: color,
                        textColor: '#fff', // ä¿è¯äº‹ä»¶æ¡å†…çš„æ–‡å­—åœ¨å½©è‰²èƒŒæ™¯ä¸‹å¯è§
                        extendedProps: {
                            notebookName: boxIdToNameMap[block.box] || 'æœªçŸ¥'
                        }
                    };
                });

                successCallback(events);
            } catch (e) {
                console.error("SQLæŸ¥è¯¢å¤±è´¥", e);
                failureCallback(e);
            }
        }

        // --- æ¨¡æ€æ¡†é€»è¾‘ ---

        async function openModal(date) {
            currentSelectedDate = date;
            const modal = document.getElementById('modal');
            const title = document.getElementById('modal-title');
            const list = document.getElementById('doc-list');

            // è®¾ç½®æ ‡é¢˜
            title.innerText = date.toLocaleDateString('zh-CN', {
                year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'
            });

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            modal.classList.add('is-active');

            // åŠ è½½å½“æ—¥æ–‡æ¡£
            list.innerHTML = '<p class="has-text-grey-light is-size-7">æŸ¥è¯¢ä¸­...</p>';

            const syDatePrefix = formatDateToSy(date).substring(0, 8);
            const sql = `
                SELECT id, box, name, hpath
                FROM blocks
                WHERE type = 'd' AND created LIKE '${syDatePrefix}%'
                ORDER BY created DESC
            `;

            const docs = await window.pluginSdk.querySQL(sql);
            list.innerHTML = '';

            if (docs.length === 0) {
                list.innerHTML = '<p class="has-text-grey-light is-size-7 is-italic">ğŸ“­ è¿™ä¸€å¤©æ²¡æœ‰åˆ›å»ºä»»ä½•æ–‡æ¡£</p>';
            } else {
                docs.forEach(doc => {
                    const nbName = boxIdToNameMap[doc.box] || 'æœªçŸ¥';
                    const el = document.createElement('div');
                    el.className = 'doc-list-item';
                    el.innerHTML = `
                        <div style="font-weight:bold; font-size:0.95em;">${doc.name || 'æœªå‘½å'}</div>
                        <div style="font-size:0.8em; opacity:0.7;">ğŸ““ ${nbName} <span style="margin:0 4px">|</span> ğŸ“‚ ${doc.hpath}</div>
                    `;
                    el.onclick = () => {
                        window.pluginSdk.openBlock(doc.id);
                        // closeModal(); // ä¿æŒæ‰“å¼€ä»¥ä¾¿ç»§ç»­æŸ¥çœ‹
                    };
                    list.appendChild(el);
                });
            }
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('is-active');
            currentSelectedDate = null;
        }

        // --- æŒ‰é’®äº‹ä»¶ ---

        document.getElementById('btn-create').addEventListener('click', async function () {
            if (!currentSelectedDate) return;
            const select = document.getElementById('notebook-select');
            const nbId = select.value;

            if (!nbId) return;

            const btn = this;
            btn.classList.add('is-loading'); // Bulma loading çŠ¶æ€

            try {
                await window.pluginSdk.createDailynote({
                    notebookId: nbId,
                    date: currentSelectedDate
                });

                // åˆ·æ–°æ—¥å†äº‹ä»¶
                calendar.refetchEvents();
                closeModal();
            } catch (e) {
                window.pluginSdk.showMessage("åˆ›å»ºå¤±è´¥: " + e, "error");
            } finally {
                btn.classList.remove('is-loading');
            }
        });

        // --- å·¥å…·å‡½æ•° ---

        function formatDateToSy(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}${m}${d}000000`;
        }

        function parseSyDate(str) {
            if (!str || str.length < 8) return '';
            return `${str.substring(0, 4)}-${str.substring(4, 6)}-${str.substring(6, 8)}`;
        }

        // æ ¹æ®å­—ç¬¦ä¸²ç”Ÿæˆè¾ƒä¸ºç¨³é‡çš„é¢œè‰² (ä¸é‚£ä¹ˆåˆºçœ¼)
        function stringToColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            // ä½¿ç”¨ HSL é¢œè‰²ç©ºé—´ç”Ÿæˆé¢œè‰²ï¼Œä¿è¯äº®åº¦å’Œé¥±å’Œåº¦ä¸€è‡´ï¼Œåªæ”¹å˜è‰²ç›¸
            // H: 0-360 (hashå†³å®š), S: 60-70% (è¾ƒé²œè‰³), L: 40-50% (æ·±è‰²æ¨¡å¼ä¸‹æ¸…æ™°ï¼Œä¸”æ–‡å­—ç™½è‰²å¯è¯»)
            const h = Math.abs(hash) % 360;
            return `hsl(${h}, 65%, 45%)`;
        }

    </script>
</body>

</html>