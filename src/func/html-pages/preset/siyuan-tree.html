<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SiYuan File Viewer</title>
    <style>
        /* ==================== ä¸»é¢˜å˜é‡å®šä¹‰ ==================== */
        /* æ³¨æ„ï¼šæ€æºä¼šè‡ªåŠ¨æ³¨å…¥ styleVar ä¸­çš„ CSS å˜é‡åˆ° :root */

        :root {
            /* å¸ƒå±€å°ºå¯¸ */
            --sidebar-width: 360px;

            /* å­—ä½“å¤§å°è¯­ä¹‰åŒ–å˜é‡ - åŸºäºæ³¨å…¥çš„ --font-size */
            --font-size-normal: calc(max(var(--font-size, 14px), 18px));
            --font-size-small: calc(var(--font-size-normal) * 0.85);
            --font-size-large: calc(var(--font-size-normal) * 1.15);

            /* é¢œè‰²è¯­ä¹‰åŒ–å˜é‡ - å¤ç”¨æ³¨å…¥çš„ä¸»é¢˜é¢œè‰² */
            --bg-sidebar: var(--theme-surface, #f5f5f7);
            --bg-content: var(--theme-background, #ffffff);
            --bg-toolbar: var(--theme-background, #ffffff);

            --text-primary: var(--theme-on-background, #333333);
            --text-secondary: var(--theme-on-surface-light, #666666);

            --accent-color: var(--theme-primary, #d23f31);
            --accent-bg: var(--theme-primary-lightest, #ffe8e6);

            --hover-color: var(--theme-surface-light, #e8e8e8);
            --border-color: var(--theme-surface-lighter, #e0e0e0);

            /* åŠŸèƒ½æ€§é¢œè‰² */
            --loading-text-color: var(--theme-on-surface-light, #999999);
            --error-color: #ff4444;
        }

        /* æš—è‰²ä¸»é¢˜é€‚é… */
        :root[data-theme-mode="dark"] {
            --hover-color: #2a2a2a;
            --border-color: #3d3d3d;
            --accent-bg: #3d2522;
            --loading-text-color: #6e6e6e;
            --error-color: #f48771;
        }

        /* ==================== åŸºç¡€æ ·å¼ ==================== */
        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-family, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif);
            font-size: var(--font-size-normal);
            height: 100vh;
            display: flex;
            color: var(--text-primary);
            overflow: hidden;
            background-color: var(--bg-content);
        }

        /* ä¾§è¾¹æ  */
        #sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        /* æ‹–æ‹½æ¡ */
        #resize-handle {
            width: 4px;
            background-color: transparent;
            cursor: col-resize;
            flex-shrink: 0;
            transition: background-color 0.2s;
            margin-left: -2px;
            /* Overlap border */
            z-index: 10;
        }

        #resize-handle:hover,
        #resize-handle.active {
            background-color: var(--accent-color);
        }

        #toolbar {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 5px;
            background: var(--bg-toolbar);
        }

        #root-path-input {
            flex: 1;
            padding: 4px 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: var(--font-size-small);
            background: var(--bg-content);
            color: var(--text-primary);
        }

        #refresh-btn {
            cursor: pointer;
            padding: 4px 8px;
            background: var(--bg-sidebar);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: var(--font-size-small);
            color: var(--text-primary);
            transition: background-color 0.2s;
        }

        #refresh-btn:hover {
            background: var(--hover-color);
        }

        #tree-root {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        /* æ ‘èŠ‚ç‚¹ */
        .tree-node {
            user-select: none;
        }

        .node-header {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            cursor: pointer;
            font-size: var(--font-size-normal);
            transition: background 0.1s;
        }

        .node-header:hover {
            background-color: var(--hover-color);
        }

        .node-header.active {
            background-color: var(--accent-bg);
            color: var(--accent-color);
        }

        .toggle-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 4px;
            color: var(--text-secondary);
            font-size: var(--font-size-small);
            transition: transform 0.2s;
        }

        .expanded>.node-header>.toggle-icon {
            transform: rotate(90deg);
        }

        .node-icon {
            margin-right: 6px;
            font-size: var(--font-size-normal);
        }

        .node-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        .children-container {
            padding-left: 18px;
            display: none;
        }

        .expanded>.children-container {
            display: block;
        }

        /* å³ä¾§å†…å®¹ */
        #content-view {
            flex: 1;
            background-color: var(--bg-content);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        #content-header {
            padding: 15px 30px;
            border-bottom: 1px solid var(--border-color);
            font-weight: bold;
            font-size: var(--font-size-large);
            display: flex;
            align-items: center;
            flex-shrink: 0;
            padding-right: 60px;
            /* Space for menu */
        }

        #content-body {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        /* æ‚¬æµ®èœå• */
        #floating-menu {
            position: absolute;
            top: 10px;
            right: 20px;
            z-index: 100;
        }

        .menu-btn {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            border: 1px solid transparent;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .menu-btn:hover {
            background-color: var(--hover-color);
            color: var(--text-primary);
        }

        .menu-dropdown {
            position: absolute;
            top: 36px;
            right: 0;
            background: var(--bg-content);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: none;
            min-width: 140px;
            flex-direction: column;
            padding: 4px 0;
        }

        .menu-dropdown.show {
            display: flex;
        }

        .menu-item {
            padding: 8px 16px;
            cursor: pointer;
            text-align: left;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: var(--font-size-small);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .menu-item:hover {
            background-color: var(--hover-color);
        }

        .menu-item:disabled {
            color: var(--text-secondary);
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* ç¼–è¾‘å¼¹çª— */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: var(--bg-content);
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 800px;
            height: 80%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            font-size: var(--font-size-large);
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            flex: 1;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .modal-body textarea {
            width: 100%;
            height: 100%;
            resize: none;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-sidebar);
            color: var(--text-primary);
            font-family: var(--font-family-code, "Consolas", "Monaco", monospace);
            font-size: var(--font-size-normal);
            outline: none;
        }

        .modal-body textarea:focus {
            border-color: var(--accent-color);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn {
            padding: 6px 16px;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid var(--border-color);
            background: var(--bg-content);
            color: var(--text-primary);
            font-size: var(--font-size-normal);
        }

        .btn:hover {
            background-color: var(--hover-color);
        }

        .btn-primary {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .btn-primary:hover {
            opacity: 0.9;
            background: var(--accent-color);
        }

        /* ç®€å•çš„ Markdown/ä»£ç  é¢„è§ˆæ ·å¼ */
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: var(--font-family-code, "Consolas", "Monaco", monospace);
            font-size: var(--font-size-normal);
            color: var(--text-primary);
            margin: 0;
            line-height: 1.6;
        }

        .empty-state {
            color: var(--text-secondary);
            text-align: center;
            margin-top: 20%;
        }

        .loading-text {
            color: var(--loading-text-color);
            font-size: var(--font-size-small);
            padding-left: 24px;
        }

        .error-text {
            color: var(--error-color);
            font-size: var(--font-size-small);
            padding-left: 24px;
        }

        /* Toast æç¤ºæ¡† */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            background: var(--bg-content);
            color: var(--text-primary);
            padding: 12px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-left: 4px solid var(--accent-color);
            min-width: 200px;
            max-width: 400px;
            font-size: var(--font-size-normal);
            animation: slideIn 0.3s ease-out;
            pointer-events: auto;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toast.success {
            border-left-color: var(--success-color, #34a853);
        }

        .toast.error {
            border-left-color: var(--error-color);
        }

        .toast.warning {
            border-left-color: #fbbc04;
        }

        .toast.info {
            border-left-color: var(--accent-color);
        }

        .toast-icon {
            font-size: 18px;
            flex-shrink: 0;
        }

        .toast-message {
            flex: 1;
            word-wrap: break-word;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .toast.hiding {
            animation: slideOut 0.3s ease-out forwards;
        }
    </style>
</head>

<body>

    <div id="sidebar">
        <div id="toolbar">
            <input type="text" id="root-path-input" value="/data" placeholder="Root Path">
            <button id="refresh-btn">Go</button>
        </div>
        <div id="tree-root"></div>
    </div>

    <div id="resize-handle"></div>

    <div id="content-view">
        <div id="floating-menu">
            <button class="menu-btn" id="menu-toggle" title="èœå•">
                <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none"
                    stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="1"></circle>
                    <circle cx="19" cy="12" r="1"></circle>
                    <circle cx="5" cy="12" r="1"></circle>
                </svg>
            </button>
            <div class="menu-dropdown" id="menu-dropdown">
                <button class="menu-item" id="btn-download">
                    <span>ğŸ“¥</span> ä¸‹è½½æ–‡ä»¶
                </button>
                <button class="menu-item" id="btn-copy-text">
                    <span>ğŸ“„</span> å¤åˆ¶æ–‡æœ¬
                </button>
                <button class="menu-item" id="btn-copy-image">
                    <span>ğŸ–¼ï¸</span> å¤åˆ¶å›¾ç‰‡
                </button>
                <div style="height: 1px; background: var(--border-color); margin: 4px 0;"></div>
                <button class="menu-item" id="btn-edit">
                    <span>âœï¸</span> ç¼–è¾‘æ–‡ä»¶
                </button>
            </div>
        </div>

        <div id="content-header" id="doc-title">æœªé€‰æ‹©æ–‡ä»¶</div>
        <div id="content-body">
            <div class="empty-state">ç­‰å¾… SDK åˆå§‹åŒ–...</div>
        </div>
    </div>

    <!-- ç¼–è¾‘å¼¹çª— -->
    <div class="modal-overlay" id="edit-modal">
        <div class="modal">
            <div class="modal-header">
                <span id="modal-title">ç¼–è¾‘æ–‡ä»¶</span>
                <button class="btn" id="btn-close-modal"
                    style="border:none; background:none; font-size:20px; padding:0;">Ã—</button>
            </div>
            <div class="modal-body">
                <textarea id="edit-textarea" spellcheck="false"></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn" id="btn-cancel-edit">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="btn-save-edit">è¦†ç›–</button>
            </div>
        </div>
    </div>

    <!-- Toast å®¹å™¨ -->
    <div id="toast-container"></div>

    <script>
        /* ==================== å·¥å…·å‡½æ•° ==================== */

        /**
         * è§£ææ€æº .sy æ–‡ä»¶è·¯å¾„ï¼Œæå–æ–‡æ¡£ ID å’Œç¬”è®°æœ¬ä¿¡æ¯
         * @param {string} path - æ–‡ä»¶è·¯å¾„ï¼Œå¦‚ "/data/20220112192155-gzmnt6y/20220320150131-kdhgvaj.sy"
         * @returns {{docId: string, notebook: {name: string, id: string, closed: boolean}}}
         */
        const parseSiyanFilePath = (path) => {
            const docPath = path.substring(6, path.length - 3);
            const docId = docPath.split('/').pop();
            const notebookId = docPath.split('/').shift();
            const notebooks = window.pluginSdk.lsNotebooks();
            let notebook = notebooks.find(nb => nb.id === notebookId);
            if (!notebook) {
                notebook = { name: 'æœªçŸ¥ç¬”è®°æœ¬', id: notebookId, closed: true };
            }
            return {
                docId,
                notebook
            }
        }

        /**
         * åº”ç”¨ä¸»é¢˜æ¨¡å¼
         * @param {string} mode - 'light' æˆ– 'dark'
         */
        function applyTheme(mode) {
            document.documentElement.setAttribute('data-theme-mode', mode);
            console.log(`ä¸»é¢˜å·²åˆ‡æ¢è‡³: ${mode}`);
        }

        /**
         * æ˜¾ç¤º Toast æç¤º
         * @param {string} message - æç¤ºæ¶ˆæ¯
         * @param {string} type - ç±»å‹ï¼š'success', 'error', 'warning', 'info'
         * @param {number} duration - æ˜¾ç¤ºæ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰ï¼Œé»˜è®¤ 3000
         */
        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icons = {
                success: 'âœ“',
                error: 'âœ•',
                warning: 'âš ',
                info: 'â„¹'
            };

            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || icons.info}</span>
                <span class="toast-message">${message}</span>
            `;

            container.appendChild(toast);

            // è‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => {
                    container.removeChild(toast);
                }, 300);
            }, duration);
        }

        /* ==================== SiYuan å®¢æˆ·ç«¯å°è£… ==================== */

        /**
         * SiYuan API å®¢æˆ·ç«¯ï¼Œå°è£…å¸¸ç”¨çš„æ–‡ä»¶å’Œæ•°æ®æ“ä½œ
         */
        class SiYuanClient {
            /**
             * åˆ—å‡ºæŒ‡å®šè·¯å¾„ä¸‹çš„æ–‡ä»¶å’Œç›®å½•
             * @param {string} path - ç›®å½•è·¯å¾„
             * @returns {Promise<Array|null>} æ–‡ä»¶/ç›®å½•åˆ—è¡¨ï¼Œå¤±è´¥è¿”å› null
             */
            async list(path) {
                try {
                    const res = await window.pluginSdk.request('/api/file/readDir', { path });
                    if (!res.ok) {
                        throw new Error(`API è¯·æ±‚å¤±è´¥: ${res.msg || 'æœªçŸ¥é”™è¯¯'}`);
                    }

                    return res.data.map(item => ({
                        name: item.name,
                        path: path === '/' ? `/${item.name}` : `${path}/${item.name}`,
                        leaf: !item.isDir,
                        isDir: item.isDir
                    })).sort((a, b) => {
                        // æ–‡ä»¶å¤¹ä¼˜å…ˆï¼Œç„¶åæŒ‰åç§°æ’åº
                        if (a.isDir && !b.isDir) return -1;
                        if (!a.isDir && b.isDir) return 1;
                        return a.name.localeCompare(b.name);
                    });
                } catch (e) {
                    console.error('åˆ—å‡ºæ–‡ä»¶å¤±è´¥:', e);
                    return null;
                }
            }

            /**
             * è·å–æ–‡ä»¶å†…å®¹
             * @param {string} path - æ–‡ä»¶è·¯å¾„
             * @returns {Promise<{name: string, content: string, isHTML?: boolean}>}
             */
            async get(path) {
                try {
                    // ç‰¹æ®Šå¤„ç† .sy æ–‡ä»¶ï¼šè·å–æ–‡æ¡£çš„ Markdown å†…å®¹
                    if (path.endsWith('.sy')) {
                        const conf = parseSiyanFilePath(path);

                        // åªå¤„ç†æ‰“å¼€çš„ç¬”è®°æœ¬
                        if (conf.notebook.closed === false) {
                            const block = await window.pluginSdk.getBlockByID(conf.docId);
                            const markdown = await window.pluginSdk.getMarkdown(conf.docId);

                            const contents = []
                            if (block) {
                                contents.push(`---`);
                                contents.push(`notebook: ${conf.notebook.name}`);
                                contents.push(`hpath: ${block.hpath}`);
                                contents.push('---\n');
                            }
                            contents.push(markdown);
                            return {
                                name: conf.docId + '.sy',
                                content: contents.join('\n')
                            }
                        }
                    }

                    let result = await window.pluginSdk.loadBlob(path);

                    if (!result.ok) {
                        throw new Error(`Failed to load Blob from ${path}`);
                    }

                    let blob = result.data;
                    const fileName = path.split('/').pop();
                    const mimeType = blob.type || '';

                    // åˆ¤æ–­æ–‡ä»¶ç±»å‹ï¼šæ–‡æœ¬
                    if (mimeType.startsWith('text/') ||
                        mimeType === 'application/json' ||
                        mimeType === 'application/javascript' ||
                        mimeType === '' || // æ—  MIME ç±»å‹ï¼Œå°è¯•ä½œä¸ºæ–‡æœ¬
                        /\.(md|txt|json|js|ts|jsx|tsx|css|html|xml|yaml|yml|toml|ini|conf|log|py|java|c|cpp|h|hpp|go|rs|sh|bat)$/i.test(fileName)) {
                        const text = await blob.text();
                        return {
                            name: fileName,
                            content: text
                        };
                    }

                    // åˆ¤æ–­æ–‡ä»¶ç±»å‹ï¼šå›¾ç‰‡
                    if (mimeType.startsWith('image/')) {
                        const objectURL = URL.createObjectURL(blob);
                        return {
                            name: fileName,
                            content: `<img src="${objectURL}" style="max-width: 100%; height: auto; display: block; margin: 0 auto;" alt="${fileName}" />`,
                            isHTML: true
                        };
                    }

                    const formatFileSize = (bytes) => {
                        if (bytes < 1024) return `${bytes} B`;
                        else if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(2)} KB`;
                        else if (bytes < 1024 * 1024 * 1024) return `${(bytes / (1024 * 1024)).toFixed(2)} MB`;
                        else return `${(bytes / (1024 * 1024 * 1024)).toFixed(2)} GB`;
                    }

                    // å…¶ä»–äºŒè¿›åˆ¶ç±»å‹
                    return {
                        name: fileName,
                        content: `[äºŒè¿›åˆ¶æ–‡ä»¶: ${fileName}]\nç±»å‹: ${mimeType || 'æœªçŸ¥'}\nå¤§å°: ${blob.size} å­—èŠ‚ (${formatFileSize(blob.size)}) \n\næ­¤æ–‡ä»¶ç±»å‹æš‚ä¸æ”¯æŒé¢„è§ˆã€‚`
                    };
                } catch (e) {
                    console.error('è¯»å–æ–‡ä»¶å¤±è´¥:', e);
                    return {
                        name: "é”™è¯¯",
                        content: `æ— æ³•è¯»å–æ–‡ä»¶å†…å®¹\n\né”™è¯¯ä¿¡æ¯: ${e.message}\n\nè¯·æ£€æŸ¥ï¼š\n- æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®\n- æ–‡ä»¶æ˜¯å¦å­˜åœ¨\n- æ˜¯å¦æœ‰è®¿é—®æƒé™`
                    };
                }
            }

            /**
             * åŠ è½½é…ç½®
             * @returns {Promise<{rootPath: string, lastOpenFile: string|null}>}
             */
            async loadSettings() {
                try {
                    const config = await window.pluginSdk.loadConfig();
                    return config || { rootPath: '/data', lastOpenFile: null };
                } catch (e) {
                    console.error('åŠ è½½é…ç½®å¤±è´¥:', e);
                    return { rootPath: '/data', lastOpenFile: null };
                }
            }

            /**
             * ä¿å­˜é…ç½®
             * @param {Object} settings - é…ç½®å¯¹è±¡
             */
            async saveSettings(settings) {
                try {
                    await window.pluginSdk.saveConfig(settings);
                } catch (e) {
                    console.error('ä¿å­˜é…ç½®å¤±è´¥:', e);
                }
            }

            /**
             * ä¿å­˜æ–‡ä»¶å†…å®¹
             * @param {string} path - æ–‡ä»¶è·¯å¾„
             * @param {string|Blob} content - æ–‡ä»¶å†…å®¹
             */
            async save(path, content) {
                try {
                    let blob;
                    if (typeof content === 'string') {
                        blob = new Blob([content], { type: 'text/plain' });
                    } else {
                        blob = content;
                    }

                    // ä½¿ç”¨ saveBlob æ›´æ–°æ–‡ä»¶
                    // æ³¨æ„ï¼šè¿™é‡Œå‡è®¾ pluginSdk æä¾›äº† saveBlob æ–¹æ³•ï¼Œæˆ–è€…æˆ‘ä»¬éœ€è¦é€šè¿‡ request ä¸Šä¼ 
                    // æ ¹æ®ç”¨æˆ·æŒ‡ç¤º "ä½¿ç”¨ saveBlob æ›´æ–°ç›¸åº”çš„æ–‡ä»¶"
                    if (window.pluginSdk.saveBlob) {
                        await window.pluginSdk.saveBlob(path, blob);
                    } else {
                        throw new Error('æ— æ³•ä¿å­˜æ–‡ä»¶ï¼šsaveBlob æ–¹æ³•ä¸å¯ç”¨');
                    }
                    return true;
                } catch (e) {
                    console.error('ä¿å­˜æ–‡ä»¶å¤±è´¥:', e);
                    throw e;
                }
            }
        }

        /* ==================== åº”ç”¨çŠ¶æ€å’Œ DOM å¼•ç”¨ ==================== */

        const client = new SiYuanClient();
        const dom = {
            sidebar: document.getElementById('tree-root'),
            contentHeader: document.getElementById('content-header'),
            contentBody: document.getElementById('content-body'),
            rootInput: document.getElementById('root-path-input'),
            refreshBtn: document.getElementById('refresh-btn'),
            // Menu
            menuToggle: document.getElementById('menu-toggle'),
            menuDropdown: document.getElementById('menu-dropdown'),
            btnDownload: document.getElementById('btn-download'),
            btnCopyText: document.getElementById('btn-copy-text'),
            btnCopyImage: document.getElementById('btn-copy-image'),
            btnEdit: document.getElementById('btn-edit'),
            // Modal
            editModal: document.getElementById('edit-modal'),
            modalTitle: document.getElementById('modal-title'),
            editTextarea: document.getElementById('edit-textarea'),
            btnCancelEdit: document.getElementById('btn-cancel-edit'),
            btnSaveEdit: document.getElementById('btn-save-edit'),
            btnCloseModal: document.getElementById('btn-close-modal'),
            // Resize
            resizeHandle: document.getElementById('resize-handle'),
            app: document.body
        };
        let appState = { rootPath: '/data', lastOpenFile: null };

        /* ==================== ä¸»åˆå§‹åŒ–å‡½æ•° ==================== */

        /**
         * åº”ç”¨åˆå§‹åŒ–
         * åœ¨ pluginSdk å°±ç»ªåè°ƒç”¨
         */
        async function init() {
            try {
                // 1. åº”ç”¨ä¸»é¢˜
                const themeMode = window.pluginSdk.themeMode || 'light';
                applyTheme(themeMode);
                console.log('åˆå§‹ä¸»é¢˜æ¨¡å¼:', themeMode);

                // 2. æ¸…é™¤åŠ è½½æç¤º
                dom.contentBody.innerHTML = '<div class="empty-state">è¯·ä»å·¦ä¾§é€‰æ‹©æ–‡ä»¶ä»¥æŸ¥çœ‹å†…å®¹</div>';

                // 3. åŠ è½½é…ç½®
                const config = await client.loadSettings();
                if (config.rootPath) appState.rootPath = config.rootPath;
                if (config.lastOpenFile) appState.lastOpenFile = config.lastOpenFile;

                dom.rootInput.value = appState.rootPath;

                // 4. æ¸²æŸ“æ–‡ä»¶æ ‘
                await renderLevel(appState.rootPath, dom.sidebar);

                // 5. æ¢å¤ä¸Šæ¬¡æ‰“å¼€çš„æ–‡ä»¶
                if (appState.lastOpenFile) {
                    await loadContent(appState.lastOpenFile);
                }

                // 6. ç»‘å®šäº‹ä»¶
                dom.refreshBtn.onclick = async () => {
                    const newRoot = dom.rootInput.value.trim();
                    if (!newRoot) {
                        showToast('è·¯å¾„ä¸èƒ½ä¸ºç©º', 'warning');
                        return;
                    }
                    appState.rootPath = newRoot;
                    await client.saveSettings({ ...appState, rootPath: newRoot });
                    dom.sidebar.innerHTML = '';
                    await renderLevel(newRoot, dom.sidebar);
                };

                // æ”¯æŒå›è½¦é”®åˆ·æ–°
                dom.rootInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        dom.refreshBtn.click();
                    }
                });

                // åˆå§‹åŒ–æ–°åŠŸèƒ½
                initResizeHandle();
                initMenu();
                initEditModal();

                console.log('âœ“ åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
            } catch (e) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', e);
                dom.contentBody.innerHTML = `<div class="empty-state" style="color: var(--error-color);">åˆå§‹åŒ–å¤±è´¥: ${e.message}</div>`;
            }
        }

        /* ==================== æ–°åŠŸèƒ½å®ç° ==================== */

        // 1. ä¾§è¾¹æ æ‹–æ‹½è°ƒæ•´å®½åº¦
        function initResizeHandle() {
            let isResizing = false;

            dom.resizeHandle.addEventListener('mousedown', (e) => {
                isResizing = true;
                dom.resizeHandle.classList.add('active');
                document.body.style.cursor = 'col-resize';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;

                // é™åˆ¶æœ€å°å®½åº¦ 200pxï¼Œæœ€å¤§å®½åº¦ 600px
                let newWidth = e.clientX;
                if (newWidth < 200) newWidth = 200;
                if (newWidth > 600) newWidth = 600;

                document.documentElement.style.setProperty('--sidebar-width', `${newWidth}px`);
            });

            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    dom.resizeHandle.classList.remove('active');
                    document.body.style.cursor = '';
                }
            });
        }

        // 2. æ‚¬æµ®èœå•é€»è¾‘
        function initMenu() {
            // åˆ‡æ¢èœå•æ˜¾ç¤º
            dom.menuToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                dom.menuDropdown.classList.toggle('show');
                updateMenuState();
            });

            // ç‚¹å‡»å¤–éƒ¨å…³é—­èœå•
            document.addEventListener('click', () => {
                dom.menuDropdown.classList.remove('show');
            });

            // é˜»æ­¢èœå•å†…éƒ¨ç‚¹å‡»å…³é—­
            dom.menuDropdown.addEventListener('click', (e) => {
                e.stopPropagation();
            });

            // ç»‘å®šåŠŸèƒ½æŒ‰é’®
            dom.btnDownload.addEventListener('click', handleDownload);
            dom.btnCopyText.addEventListener('click', handleCopyText);
            dom.btnCopyImage.addEventListener('click', handleCopyImage);
            dom.btnEdit.addEventListener('click', handleEdit);
        }

        function updateMenuState() {
            const path = appState.lastOpenFile;
            if (!path) {
                disableAllMenu();
                return;
            }

            const isImage = /\.(png|jpg|jpeg|gif|bmp|svg|webp)$/i.test(path);
            const isEditableText = isEditableFile(path);

            // åªæœ‰æ˜ç¡®çš„æ–‡æœ¬æ–‡ä»¶å…è®¸ç¼–è¾‘
            dom.btnEdit.disabled = !isEditableText;

            // å›¾ç‰‡åªèƒ½å¤åˆ¶å›¾ç‰‡ï¼Œä¸èƒ½å¤åˆ¶æ–‡æœ¬
            dom.btnCopyText.disabled = isImage;
            dom.btnCopyImage.disabled = !isImage;

            // ä¸‹è½½æ€»æ˜¯å¯ç”¨
            dom.btnDownload.disabled = false;
        }

        function disableAllMenu() {
            dom.btnDownload.disabled = true;
            dom.btnCopyText.disabled = true;
            dom.btnCopyImage.disabled = true;
            dom.btnEdit.disabled = true;
        }

        async function handleDownload() {
            const path = appState.lastOpenFile;
            if (!path) return;

            try {
                // ç›´æ¥è·å–åŸå§‹æ–‡ä»¶ Blob è¿›è¡Œä¸‹è½½ï¼Œç¡®ä¿ä¸‹è½½çš„æ˜¯æºæ–‡ä»¶ï¼ˆç‰¹åˆ«æ˜¯ .sy æ–‡ä»¶ï¼‰
                const res = await window.pluginSdk.loadBlob(path);
                if (!res.ok) throw new Error('è¯»å–æ–‡ä»¶å¤±è´¥');

                const blob = res.data;
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = path.split('/').pop();
                a.click();
                URL.revokeObjectURL(url);

                showToast('æ–‡ä»¶å·²ä¸‹è½½', 'success');
                dom.menuDropdown.classList.remove('show');
            } catch (e) {
                showToast('ä¸‹è½½å¤±è´¥: ' + e.message, 'error');
            }
        }

        async function handleCopyText() {
            const path = appState.lastOpenFile;
            if (!path) return;

            try {
                const res = await client.get(path);
                if (res.isHTML) {
                    showToast('å½“å‰æ–‡ä»¶ä¸æ˜¯çº¯æ–‡æœ¬ï¼Œæ— æ³•å¤åˆ¶æ–‡æœ¬', 'warning');
                    return;
                }
                await navigator.clipboard.writeText(res.content);
                showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                dom.menuDropdown.classList.remove('show');
            } catch (e) {
                showToast('å¤åˆ¶å¤±è´¥: ' + e.message, 'error');
            }
        }

        async function handleCopyImage() {
            const path = appState.lastOpenFile;
            if (!path) return;

            try {
                const blobRes = await window.pluginSdk.loadBlob(path);
                if (!blobRes.ok) throw new Error('åŠ è½½å›¾ç‰‡å¤±è´¥');

                const blob = blobRes.data;
                if (!blob.type.startsWith('image/')) {
                    showToast('å½“å‰æ–‡ä»¶ä¸æ˜¯å›¾ç‰‡', 'error');
                    return;
                }

                // å°†å›¾ç‰‡è½¬æ¢ä¸º PNG æ ¼å¼ï¼ˆClipboard API é€šå¸¸åªæ”¯æŒ PNGï¼‰
                const img = new Image();
                const objectURL = URL.createObjectURL(blob);

                await new Promise((resolve, reject) => {
                    img.onload = resolve;
                    img.onerror = reject;
                    img.src = objectURL;
                });

                // ä½¿ç”¨ Canvas è½¬æ¢ä¸º PNG
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);

                URL.revokeObjectURL(objectURL);

                // è½¬æ¢ä¸º PNG Blob
                const pngBlob = await new Promise(resolve => {
                    canvas.toBlob(resolve, 'image/png');
                });

                await navigator.clipboard.write([
                    new ClipboardItem({
                        'image/png': pngBlob
                    })
                ]);

                showToast('å›¾ç‰‡å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                // window.pluginSdk.showMessage('å›¾ç‰‡å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'info');
                dom.menuDropdown.classList.remove('show');
            } catch (e) {
                console.error('å¤åˆ¶å›¾ç‰‡å¤±è´¥:', e);
                showToast('å¤åˆ¶å›¾ç‰‡å¤±è´¥: ' + e.message, 'error');
                // window.pluginSdk.showMessage('å¤åˆ¶å›¾ç‰‡å¤±è´¥: ' + e.message, 'error');
            }
        }

        // 3. ç¼–è¾‘åŠŸèƒ½å®ç°
        function initEditModal() {
            const closeModal = () => {
                dom.editModal.classList.remove('show');
            };

            dom.btnCancelEdit.addEventListener('click', closeModal);
            dom.btnCloseModal.addEventListener('click', closeModal);

            dom.btnSaveEdit.addEventListener('click', async () => {
                const path = appState.lastOpenFile;
                const content = dom.editTextarea.value;

                const doSave = async () => {
                    try {
                        dom.btnSaveEdit.disabled = true;
                        dom.btnSaveEdit.textContent = 'ä¿å­˜ä¸­...';

                        await client.save(path, content);

                        // åˆ·æ–°æ˜¾ç¤º
                        await loadContent(path);
                        closeModal();
                        showToast('ä¿å­˜æˆåŠŸ', 'success');
                    } catch (e) {
                        showToast('ä¿å­˜å¤±è´¥: ' + e.message, 'error');
                    } finally {
                        dom.btnSaveEdit.disabled = false;
                        dom.btnSaveEdit.textContent = 'è¦†ç›–';
                    }
                };

                // JSON æ£€æŸ¥
                if (path.endsWith('.json')) {
                    try {
                        JSON.parse(content);
                    } catch (e) {
                        window.pluginSdk.confirm('å¼ºåˆ¶ä¿å­˜', 'JSON æ ¼å¼æ ¡éªŒå¤±è´¥ï¼Œæ˜¯å¦å¼ºåˆ¶ä¿å­˜ï¼Ÿ\né”™è¯¯: ' + e.message, () => {
                            doSave();
                        });
                        return;
                    }
                }

                doSave();
            });
        }

        /**
         * åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å…è®¸ç¼–è¾‘ï¼ˆç™½åå•æ–¹æ¡ˆï¼‰
         * @param {string} path - æ–‡ä»¶è·¯å¾„
         * @returns {boolean}
         */
        function isEditableFile(path) {
            // ç»å¯¹ç¦æ­¢ç¼–è¾‘ .sy æ–‡ä»¶
            if (path.endsWith('.sy')) {
                return false;
            }

            const fname = path.split('/').pop();
            if (['indexignore', 'syncignore', 'refsearchignore', 'searchignore'].includes(fname)) {
                return true;
            }

            // ç™½åå•ï¼šæ˜ç¡®å…è®¸ç¼–è¾‘çš„æ–‡æœ¬æ–‡ä»¶åç¼€
            const editableExtensions = /\.(txt|md|json|js|ts|jsx|tsx|css|scss|less|html|xml|svg|yaml|yml|toml|ini|conf|log|py|java|c|cpp|h|hpp|go|rs|sh|bat|ps1|rb|php|sql|r|swift|kt|scala|lua|vim|gitignore|env|properties)$/i;

            return editableExtensions.test(path);
        }

        async function handleEdit() {
            const path = appState.lastOpenFile;
            if (!path) return;

            // ç™½åå•æ£€æŸ¥
            if (!isEditableFile(path)) {
                if (path.endsWith('.sy')) {
                    showToast('å®‰å…¨è­¦å‘Šï¼šç»å¯¹ç¦æ­¢ç¼–è¾‘ .sy æ–‡ä»¶ï¼', 'error', 4000);
                } else {
                    showToast('æ­¤æ–‡ä»¶ç±»å‹ä¸æ”¯æŒç¼–è¾‘ã€‚ä»…æ”¯æŒç¼–è¾‘çº¯æ–‡æœ¬æ–‡ä»¶ï¼ˆå¦‚ .txt, .md, .json, .js, .py ç­‰ï¼‰', 'warning', 4000);
                }
                return;
            }

            try {
                // åŠ è½½æ–‡ä»¶å†…å®¹å‰ï¼Œå†æ¬¡é€šè¿‡ blob type ç¡®è®¤æ˜¯æ–‡æœ¬æ–‡ä»¶
                const blobRes = await window.pluginSdk.loadBlob(path);
                if (!blobRes.ok) throw new Error('è¯»å–æ–‡ä»¶å¤±è´¥');

                const blob = blobRes.data;
                const mimeType = blob.type || '';

                // å¦‚æœ MIME ç±»å‹æ˜ç¡®ä¸æ˜¯æ–‡æœ¬ï¼Œæ‹’ç»ç¼–è¾‘
                if (mimeType && !mimeType.startsWith('text/') &&
                    mimeType !== 'application/json' &&
                    mimeType !== 'application/javascript' &&
                    mimeType !== 'application/xml') {
                    showToast('æ–‡ä»¶ç±»å‹æ£€æŸ¥å¤±è´¥ï¼šæ­¤æ–‡ä»¶ä¸æ˜¯çº¯æ–‡æœ¬æ ¼å¼ï¼Œæ— æ³•ç¼–è¾‘', 'error', 4000);
                    return;
                }

                // è¯»å–æ–‡æœ¬å†…å®¹
                const content = await blob.text();
                const fileName = path.split('/').pop();

                dom.modalTitle.textContent = `ç¼–è¾‘: ${fileName}`;
                dom.editTextarea.value = content;
                dom.editModal.classList.add('show');
                dom.menuDropdown.classList.remove('show');
            } catch (e) {
                showToast('æ‰“å¼€ç¼–è¾‘å™¨å¤±è´¥: ' + e.message, 'error');
            }
        }

        /* ==================== UI æ¸²æŸ“é€»è¾‘ ==================== */

        /**
         * æ¸²æŸ“æŒ‡å®šè·¯å¾„çš„æ–‡ä»¶æ ‘å±‚çº§
         * @param {string} path - ç›®å½•è·¯å¾„
         * @param {HTMLElement} container - å®¹å™¨å…ƒç´ 
         */
        async function renderLevel(path, container) {
            container.innerHTML = '<div class="loading-text">åŠ è½½ä¸­...</div>';
            const nodes = await client.list(path);
            container.innerHTML = '';

            if (!nodes) {
                container.innerHTML = '<div class="error-text">åŠ è½½å¤±è´¥ï¼šæ— æ³•è¯»å–ç›®å½•</div>';
                return;
            }
            if (nodes.length === 0) {
                container.innerHTML = '<div class="loading-text">ç©ºç›®å½•</div>';
                return;
            }

            nodes.forEach(node => {
                container.appendChild(createNodeElement(node));
            });
        }

        /**
         * åˆ›å»ºæ ‘èŠ‚ç‚¹å…ƒç´ 
         * @param {Object} node - èŠ‚ç‚¹æ•°æ®
         * @returns {HTMLElement}
         */
        function createNodeElement(node) {
            const wrapper = document.createElement('div');
            wrapper.className = 'tree-node';

            const header = document.createElement('div');
            header.className = 'node-header';

            const toggleIcon = document.createElement('div');
            toggleIcon.className = 'toggle-icon';
            if (!node.leaf) {
                toggleIcon.textContent = 'â–¶';
                toggleIcon.onclick = (e) => {
                    e.stopPropagation();
                    toggleFolder(wrapper, node.path);
                };
            }
            header.appendChild(toggleIcon);

            const typeIcon = document.createElement('span');
            typeIcon.className = 'node-icon';
            typeIcon.textContent = node.leaf ? 'ğŸ“„' : 'ğŸ“';
            header.appendChild(typeIcon);

            const nameSpan = document.createElement('span');
            nameSpan.className = 'node-name';
            nameSpan.textContent = node.name;
            header.appendChild(nameSpan);

            header.onclick = () => {
                if (!node.leaf) {
                    toggleFolder(wrapper, node.path);
                } else {
                    handleFileClick(node.path, header);
                }
            };

            wrapper.appendChild(header);

            if (!node.leaf) {
                const childrenBox = document.createElement('div');
                childrenBox.className = 'children-container';
                wrapper.appendChild(childrenBox);
            }

            return wrapper;
        }

        /**
         * åˆ‡æ¢æ–‡ä»¶å¤¹å±•å¼€/æŠ˜å çŠ¶æ€
         * @param {HTMLElement} wrapper - èŠ‚ç‚¹åŒ…è£…å…ƒç´ 
         * @param {string} path - æ–‡ä»¶å¤¹è·¯å¾„
         */
        async function toggleFolder(wrapper, path) {
            const childrenContainer = wrapper.querySelector('.children-container');
            if (!childrenContainer) return;

            if (wrapper.classList.contains('expanded')) {
                wrapper.classList.remove('expanded');
            } else {
                wrapper.classList.add('expanded');
                if (childrenContainer.children.length === 0) {
                    await renderLevel(path, childrenContainer);
                }
            }
        }

        /**
         * å¤„ç†æ–‡ä»¶ç‚¹å‡»äº‹ä»¶
         * @param {string} path - æ–‡ä»¶è·¯å¾„
         * @param {HTMLElement} headerEl - èŠ‚ç‚¹å¤´éƒ¨å…ƒç´ 
         */
        async function handleFileClick(path, headerEl) {
            // æ›´æ–°æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.node-header').forEach(h => h.classList.remove('active'));
            headerEl.classList.add('active');

            // ä¿å­˜æœ€åæ‰“å¼€çš„æ–‡ä»¶
            appState.lastOpenFile = path;
            client.saveSettings({ ...appState, lastOpenFile: path });

            // åŠ è½½å†…å®¹
            await loadContent(path);
        }

        /**
         * åŠ è½½å¹¶æ˜¾ç¤ºæ–‡ä»¶å†…å®¹
         * @param {string} path - æ–‡ä»¶è·¯å¾„
         */
        async function loadContent(path) {
            try {
                dom.contentBody.innerHTML = '<div class="loading-text" style="margin-top:20px">æ­£åœ¨è¯»å–æ–‡ä»¶...</div>';
                dom.contentHeader.textContent = path.split('/').pop();

                const result = await client.get(path);

                if (result.isHTML) {
                    // HTML å†…å®¹ï¼ˆå¦‚å›¾ç‰‡ï¼‰ç›´æ¥æ˜¾ç¤º
                    dom.contentBody.innerHTML = result.content;
                } else {
                    // æ–‡æœ¬å†…å®¹éœ€è¦ HTML è½¬ä¹‰
                    const safeContent = result.content
                        .replace(/&/g, "&amp;")
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;");
                    dom.contentBody.innerHTML = `<pre>${safeContent}</pre>`;
                }
            } catch (e) {
                console.error('åŠ è½½å†…å®¹å¤±è´¥:', e);
                dom.contentBody.innerHTML = `<div class="empty-state" style="color: var(--error-color);">åŠ è½½å¤±è´¥: ${e.message}</div>`;
            }
        }

        /* ==================== å…¥å£ç‚¹ ==================== */

        /**
         * SDK å°±ç»ªäº‹ä»¶ç›‘å¬
         * æ€æºä¼šåœ¨æ³¨å…¥ pluginSdk åè§¦å‘æ­¤äº‹ä»¶
         */
        window.addEventListener('pluginSdkReady', () => {
            console.log('âœ“ pluginSdk å·²å°±ç»ª');
            console.log('- ä¸»é¢˜æ¨¡å¼:', window.pluginSdk.themeMode);
            console.log('- æ ·å¼å˜é‡:', window.pluginSdk.styleVar);
            init();
        });

    </script>
</body>

</html>