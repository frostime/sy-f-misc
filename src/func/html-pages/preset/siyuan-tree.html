<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SiYuan File Viewer</title>
    <style>
        /* ==================== ä¸»é¢˜å˜é‡å®šä¹‰ ==================== */
        /* æ³¨æ„ï¼šæ€æºä¼šè‡ªåŠ¨æ³¨å…¥ styleVar ä¸­çš„ CSS å˜é‡åˆ° :root */

        :root {
            /* å¸ƒå±€å°ºå¯¸ */
            --sidebar-width: 320px;

            /* å­—ä½“å¤§å°è¯­ä¹‰åŒ–å˜é‡ - åŸºäºæ³¨å…¥çš„ --font-size */
            --font-size-normal: var(--font-size, 14px);
            --font-size-small: calc(var(--font-size-normal) * 0.86);
            --font-size-large: calc(var(--font-size-normal) * 1.3);

            /* é¢œè‰²è¯­ä¹‰åŒ–å˜é‡ - å¤ç”¨æ³¨å…¥çš„ä¸»é¢˜é¢œè‰² */
            --bg-sidebar: var(--theme-surface, #f5f5f7);
            --bg-content: var(--theme-background, #ffffff);
            --bg-toolbar: var(--theme-background, #ffffff);

            --text-primary: var(--theme-on-background, #333333);
            --text-secondary: var(--theme-on-surface-light, #666666);

            --accent-color: var(--theme-primary, #d23f31);
            --accent-bg: var(--theme-primary-lightest, #ffe8e6);

            --hover-color: var(--theme-surface-light, #e8e8e8);
            --border-color: var(--theme-surface-lighter, #e0e0e0);

            /* åŠŸèƒ½æ€§é¢œè‰² */
            --loading-text-color: var(--theme-on-surface-light, #999999);
            --error-color: #ff4444;
        }

        /* æš—è‰²ä¸»é¢˜é€‚é… */
        :root[data-theme-mode="dark"] {
            --hover-color: #2a2a2a;
            --border-color: #3d3d3d;
            --accent-bg: #3d2522;
            --loading-text-color: #6e6e6e;
            --error-color: #f48771;
        }

        /* ==================== åŸºç¡€æ ·å¼ ==================== */
        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-family, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif);
            font-size: var(--font-size-normal);
            height: 100vh;
            display: flex;
            color: var(--text-primary);
            overflow: hidden;
            background-color: var(--bg-content);
        }

        /* ä¾§è¾¹æ  */
        #sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        #toolbar {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 5px;
            background: var(--bg-toolbar);
        }

        #root-path-input {
            flex: 1;
            padding: 4px 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: var(--font-size-small);
            background: var(--bg-content);
            color: var(--text-primary);
        }

        #refresh-btn {
            cursor: pointer;
            padding: 4px 8px;
            background: var(--bg-sidebar);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: var(--font-size-small);
            color: var(--text-primary);
            transition: background-color 0.2s;
        }

        #refresh-btn:hover {
            background: var(--hover-color);
        }

        #tree-root {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        /* æ ‘èŠ‚ç‚¹ */
        .tree-node {
            user-select: none;
        }

        .node-header {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            cursor: pointer;
            font-size: var(--font-size-normal);
            transition: background 0.1s;
        }

        .node-header:hover {
            background-color: var(--hover-color);
        }

        .node-header.active {
            background-color: var(--accent-bg);
            color: var(--accent-color);
        }

        .toggle-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 4px;
            color: var(--text-secondary);
            font-size: var(--font-size-small);
            transition: transform 0.2s;
        }

        .expanded>.node-header>.toggle-icon {
            transform: rotate(90deg);
        }

        .node-icon {
            margin-right: 6px;
            font-size: var(--font-size-normal);
        }

        .node-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        .children-container {
            padding-left: 18px;
            display: none;
        }

        .expanded>.children-container {
            display: block;
        }

        /* å³ä¾§å†…å®¹ */
        #content-view {
            flex: 1;
            background-color: var(--bg-content);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #content-header {
            padding: 15px 30px;
            border-bottom: 1px solid var(--border-color);
            font-weight: bold;
            font-size: var(--font-size-large);
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }

        #content-body {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        /* ç®€å•çš„ Markdown/ä»£ç  é¢„è§ˆæ ·å¼ */
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: var(--font-family-code, "Consolas", "Monaco", monospace);
            font-size: var(--font-size-normal);
            color: var(--text-primary);
            margin: 0;
            line-height: 1.6;
        }

        .empty-state {
            color: var(--text-secondary);
            text-align: center;
            margin-top: 20%;
        }

        .loading-text {
            color: var(--loading-text-color);
            font-size: var(--font-size-small);
            padding-left: 24px;
        }

        .error-text {
            color: var(--error-color);
            font-size: var(--font-size-small);
            padding-left: 24px;
        }
    </style>
</head>

<body>

    <div id="sidebar">
        <div id="toolbar">
            <input type="text" id="root-path-input" value="/data" placeholder="Root Path">
            <button id="refresh-btn">Go</button>
        </div>
        <div id="tree-root"></div>
    </div>

    <div id="content-view">
        <div id="content-header" id="doc-title">æœªé€‰æ‹©æ–‡ä»¶</div>
        <div id="content-body">
            <div class="empty-state">ç­‰å¾… SDK åˆå§‹åŒ–...</div>
        </div>
    </div>

    <script>
        /* ==================== å·¥å…·å‡½æ•° ==================== */

        /**
         * è§£ææ€æº .sy æ–‡ä»¶è·¯å¾„ï¼Œæå–æ–‡æ¡£ ID å’Œç¬”è®°æœ¬ä¿¡æ¯
         * @param {string} path - æ–‡ä»¶è·¯å¾„ï¼Œå¦‚ "/data/20220112192155-gzmnt6y/20220320150131-kdhgvaj.sy"
         * @returns {{docId: string, notebook: {name: string, id: string, closed: boolean}}}
         */
        const parseSiyanFilePath = (path) => {
            const docPath = path.substring(6, path.length - 3);
            const docId = docPath.split('/').pop();
            const notebookId = docPath.split('/').shift();
            const notebooks = window.pluginSdk.lsNotebooks();
            let notebook = notebooks.find(nb => nb.id === notebookId);
            if (!notebook) {
                notebook = { name: 'æœªçŸ¥ç¬”è®°æœ¬', id: notebookId, closed: true };
            }
            return {
                docId,
                notebook
            }
        }

        /**
         * åº”ç”¨ä¸»é¢˜æ¨¡å¼
         * @param {string} mode - 'light' æˆ– 'dark'
         */
        function applyTheme(mode) {
            document.documentElement.setAttribute('data-theme-mode', mode);
            console.log(`ä¸»é¢˜å·²åˆ‡æ¢è‡³: ${mode}`);
        }

        /* ==================== SiYuan å®¢æˆ·ç«¯å°è£… ==================== */

        /**
         * SiYuan API å®¢æˆ·ç«¯ï¼Œå°è£…å¸¸ç”¨çš„æ–‡ä»¶å’Œæ•°æ®æ“ä½œ
         */
        class SiYuanClient {
            /**
             * åˆ—å‡ºæŒ‡å®šè·¯å¾„ä¸‹çš„æ–‡ä»¶å’Œç›®å½•
             * @param {string} path - ç›®å½•è·¯å¾„
             * @returns {Promise<Array|null>} æ–‡ä»¶/ç›®å½•åˆ—è¡¨ï¼Œå¤±è´¥è¿”å› null
             */
            async list(path) {
                try {
                    const res = await window.pluginSdk.request('/api/file/readDir', { path });
                    if (!res.ok) {
                        throw new Error(`API è¯·æ±‚å¤±è´¥: ${res.msg || 'æœªçŸ¥é”™è¯¯'}`);
                    }

                    return res.data.map(item => ({
                        name: item.name,
                        path: path === '/' ? `/${item.name}` : `${path}/${item.name}`,
                        leaf: !item.isDir,
                        isDir: item.isDir
                    })).sort((a, b) => {
                        // æ–‡ä»¶å¤¹ä¼˜å…ˆï¼Œç„¶åæŒ‰åç§°æ’åº
                        if (a.isDir && !b.isDir) return -1;
                        if (!a.isDir && b.isDir) return 1;
                        return a.name.localeCompare(b.name);
                    });
                } catch (e) {
                    console.error('åˆ—å‡ºæ–‡ä»¶å¤±è´¥:', e);
                    return null;
                }
            }

            /**
             * è·å–æ–‡ä»¶å†…å®¹
             * @param {string} path - æ–‡ä»¶è·¯å¾„
             * @returns {Promise<{name: string, content: string, isHTML?: boolean}>}
             */
            async get(path) {
                try {
                    // ç‰¹æ®Šå¤„ç† .sy æ–‡ä»¶ï¼šè·å–æ–‡æ¡£çš„ Markdown å†…å®¹
                    if (path.endsWith('.sy')) {
                        const conf = parseSiyanFilePath(path);

                        // åªå¤„ç†æ‰“å¼€çš„ç¬”è®°æœ¬
                        if (conf.notebook.closed === false) {
                            const block = await window.pluginSdk.getBlockByID(conf.docId);
                            const markdown = await window.pluginSdk.getMarkdown(conf.docId);

                            const contents = []
                            if (block) {
                                contents.push(`---`);
                                contents.push(`notebook: ${conf.notebook.name}`);
                                contents.push(`hpath: ${block.hpath}`);
                                contents.push('---\n');
                            }
                            contents.push(markdown);
                            return {
                                name: conf.docId + '.sy',
                                content: contents.join('\n')
                            }
                        }
                    }

                    let result = await window.pluginSdk.loadBlob(path);

                    if (!result.ok) {
                        throw new Error(`Failed to load Blob from ${path}`);
                    }

                    let blob = result.data;
                    const fileName = path.split('/').pop();
                    const mimeType = blob.type || '';

                    // åˆ¤æ–­æ–‡ä»¶ç±»å‹ï¼šæ–‡æœ¬
                    if (mimeType.startsWith('text/') ||
                        mimeType === 'application/json' ||
                        mimeType === 'application/javascript' ||
                        mimeType === '' || // æ—  MIME ç±»å‹ï¼Œå°è¯•ä½œä¸ºæ–‡æœ¬
                        /\.(md|txt|json|js|ts|jsx|tsx|css|html|xml|yaml|yml|toml|ini|conf|log|py|java|c|cpp|h|hpp|go|rs|sh|bat)$/i.test(fileName)) {
                        const text = await blob.text();
                        return {
                            name: fileName,
                            content: text
                        };
                    }

                    // åˆ¤æ–­æ–‡ä»¶ç±»å‹ï¼šå›¾ç‰‡
                    if (mimeType.startsWith('image/')) {
                        const objectURL = URL.createObjectURL(blob);
                        return {
                            name: fileName,
                            content: `<img src="${objectURL}" style="max-width: 100%; height: auto; display: block; margin: 0 auto;" alt="${fileName}" />`,
                            isHTML: true
                        };
                    }

                    const formatFileSize = (bytes) => {
                        if (bytes < 1024) return `${bytes} B`;
                        else if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(2)} KB`;
                        else if (bytes < 1024 * 1024 * 1024) return `${(bytes / (1024 * 1024)).toFixed(2)} MB`;
                        else return `${(bytes / (1024 * 1024 * 1024)).toFixed(2)} GB`;
                    }

                    // å…¶ä»–äºŒè¿›åˆ¶ç±»å‹
                    return {
                        name: fileName,
                        content: `[äºŒè¿›åˆ¶æ–‡ä»¶: ${fileName}]\nç±»å‹: ${mimeType || 'æœªçŸ¥'}\nå¤§å°: ${blob.size} å­—èŠ‚ (${formatFileSize(blob.size)}) \n\næ­¤æ–‡ä»¶ç±»å‹æš‚ä¸æ”¯æŒé¢„è§ˆã€‚`
                    };
                } catch (e) {
                    console.error('è¯»å–æ–‡ä»¶å¤±è´¥:', e);
                    return {
                        name: "é”™è¯¯",
                        content: `æ— æ³•è¯»å–æ–‡ä»¶å†…å®¹\n\né”™è¯¯ä¿¡æ¯: ${e.message}\n\nè¯·æ£€æŸ¥ï¼š\n- æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®\n- æ–‡ä»¶æ˜¯å¦å­˜åœ¨\n- æ˜¯å¦æœ‰è®¿é—®æƒé™`
                    };
                }
            }

            /**
             * åŠ è½½é…ç½®
             * @returns {Promise<{rootPath: string, lastOpenFile: string|null}>}
             */
            async loadSettings() {
                try {
                    const config = await window.pluginSdk.loadConfig();
                    return config || { rootPath: '/data', lastOpenFile: null };
                } catch (e) {
                    console.error('åŠ è½½é…ç½®å¤±è´¥:', e);
                    return { rootPath: '/data', lastOpenFile: null };
                }
            }

            /**
             * ä¿å­˜é…ç½®
             * @param {Object} settings - é…ç½®å¯¹è±¡
             */
            async saveSettings(settings) {
                try {
                    await window.pluginSdk.saveConfig(settings);
                } catch (e) {
                    console.error('ä¿å­˜é…ç½®å¤±è´¥:', e);
                }
            }
        }

        /* ==================== åº”ç”¨çŠ¶æ€å’Œ DOM å¼•ç”¨ ==================== */

        const client = new SiYuanClient();
        const dom = {
            sidebar: document.getElementById('tree-root'),
            contentHeader: document.getElementById('content-header'),
            contentBody: document.getElementById('content-body'),
            rootInput: document.getElementById('root-path-input'),
            refreshBtn: document.getElementById('refresh-btn')
        };
        let appState = { rootPath: '/data', lastOpenFile: null };

        /* ==================== ä¸»åˆå§‹åŒ–å‡½æ•° ==================== */

        /**
         * åº”ç”¨åˆå§‹åŒ–
         * åœ¨ pluginSdk å°±ç»ªåè°ƒç”¨
         */
        async function init() {
            try {
                // 1. åº”ç”¨ä¸»é¢˜
                const themeMode = window.pluginSdk.themeMode || 'light';
                applyTheme(themeMode);
                console.log('åˆå§‹ä¸»é¢˜æ¨¡å¼:', themeMode);

                // 2. æ¸…é™¤åŠ è½½æç¤º
                dom.contentBody.innerHTML = '<div class="empty-state">è¯·ä»å·¦ä¾§é€‰æ‹©æ–‡ä»¶ä»¥æŸ¥çœ‹å†…å®¹</div>';

                // 3. åŠ è½½é…ç½®
                const config = await client.loadSettings();
                if (config.rootPath) appState.rootPath = config.rootPath;
                if (config.lastOpenFile) appState.lastOpenFile = config.lastOpenFile;

                dom.rootInput.value = appState.rootPath;

                // 4. æ¸²æŸ“æ–‡ä»¶æ ‘
                await renderLevel(appState.rootPath, dom.sidebar);

                // 5. æ¢å¤ä¸Šæ¬¡æ‰“å¼€çš„æ–‡ä»¶
                if (appState.lastOpenFile) {
                    await loadContent(appState.lastOpenFile);
                }

                // 6. ç»‘å®šäº‹ä»¶
                dom.refreshBtn.onclick = async () => {
                    const newRoot = dom.rootInput.value.trim();
                    if (!newRoot) {
                        alert('è·¯å¾„ä¸èƒ½ä¸ºç©º');
                        return;
                    }
                    appState.rootPath = newRoot;
                    await client.saveSettings({ ...appState, rootPath: newRoot });
                    dom.sidebar.innerHTML = '';
                    await renderLevel(newRoot, dom.sidebar);
                };

                // æ”¯æŒå›è½¦é”®åˆ·æ–°
                dom.rootInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        dom.refreshBtn.click();
                    }
                });

                console.log('âœ“ åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
            } catch (e) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', e);
                dom.contentBody.innerHTML = `<div class="empty-state" style="color: var(--error-color);">åˆå§‹åŒ–å¤±è´¥: ${e.message}</div>`;
            }
        }

        /* ==================== UI æ¸²æŸ“é€»è¾‘ ==================== */

        /**
         * æ¸²æŸ“æŒ‡å®šè·¯å¾„çš„æ–‡ä»¶æ ‘å±‚çº§
         * @param {string} path - ç›®å½•è·¯å¾„
         * @param {HTMLElement} container - å®¹å™¨å…ƒç´ 
         */
        async function renderLevel(path, container) {
            container.innerHTML = '<div class="loading-text">åŠ è½½ä¸­...</div>';
            const nodes = await client.list(path);
            container.innerHTML = '';

            if (!nodes) {
                container.innerHTML = '<div class="error-text">åŠ è½½å¤±è´¥ï¼šæ— æ³•è¯»å–ç›®å½•</div>';
                return;
            }
            if (nodes.length === 0) {
                container.innerHTML = '<div class="loading-text">ç©ºç›®å½•</div>';
                return;
            }

            nodes.forEach(node => {
                container.appendChild(createNodeElement(node));
            });
        }

        /**
         * åˆ›å»ºæ ‘èŠ‚ç‚¹å…ƒç´ 
         * @param {Object} node - èŠ‚ç‚¹æ•°æ®
         * @returns {HTMLElement}
         */
        function createNodeElement(node) {
            const wrapper = document.createElement('div');
            wrapper.className = 'tree-node';

            const header = document.createElement('div');
            header.className = 'node-header';

            const toggleIcon = document.createElement('div');
            toggleIcon.className = 'toggle-icon';
            if (!node.leaf) {
                toggleIcon.textContent = 'â–¶';
                toggleIcon.onclick = (e) => {
                    e.stopPropagation();
                    toggleFolder(wrapper, node.path);
                };
            }
            header.appendChild(toggleIcon);

            const typeIcon = document.createElement('span');
            typeIcon.className = 'node-icon';
            typeIcon.textContent = node.leaf ? 'ğŸ“„' : 'ğŸ“';
            header.appendChild(typeIcon);

            const nameSpan = document.createElement('span');
            nameSpan.className = 'node-name';
            nameSpan.textContent = node.name;
            header.appendChild(nameSpan);

            header.onclick = () => {
                if (!node.leaf) {
                    toggleFolder(wrapper, node.path);
                } else {
                    handleFileClick(node.path, header);
                }
            };

            wrapper.appendChild(header);

            if (!node.leaf) {
                const childrenBox = document.createElement('div');
                childrenBox.className = 'children-container';
                wrapper.appendChild(childrenBox);
            }

            return wrapper;
        }

        /**
         * åˆ‡æ¢æ–‡ä»¶å¤¹å±•å¼€/æŠ˜å çŠ¶æ€
         * @param {HTMLElement} wrapper - èŠ‚ç‚¹åŒ…è£…å…ƒç´ 
         * @param {string} path - æ–‡ä»¶å¤¹è·¯å¾„
         */
        async function toggleFolder(wrapper, path) {
            const childrenContainer = wrapper.querySelector('.children-container');
            if (!childrenContainer) return;

            if (wrapper.classList.contains('expanded')) {
                wrapper.classList.remove('expanded');
            } else {
                wrapper.classList.add('expanded');
                if (childrenContainer.children.length === 0) {
                    await renderLevel(path, childrenContainer);
                }
            }
        }

        /**
         * å¤„ç†æ–‡ä»¶ç‚¹å‡»äº‹ä»¶
         * @param {string} path - æ–‡ä»¶è·¯å¾„
         * @param {HTMLElement} headerEl - èŠ‚ç‚¹å¤´éƒ¨å…ƒç´ 
         */
        async function handleFileClick(path, headerEl) {
            // æ›´æ–°æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.node-header').forEach(h => h.classList.remove('active'));
            headerEl.classList.add('active');

            // ä¿å­˜æœ€åæ‰“å¼€çš„æ–‡ä»¶
            appState.lastOpenFile = path;
            client.saveSettings({ ...appState, lastOpenFile: path });

            // åŠ è½½å†…å®¹
            await loadContent(path);
        }

        /**
         * åŠ è½½å¹¶æ˜¾ç¤ºæ–‡ä»¶å†…å®¹
         * @param {string} path - æ–‡ä»¶è·¯å¾„
         */
        async function loadContent(path) {
            try {
                dom.contentBody.innerHTML = '<div class="loading-text" style="margin-top:20px">æ­£åœ¨è¯»å–æ–‡ä»¶...</div>';
                dom.contentHeader.textContent = path.split('/').pop();

                const result = await client.get(path);

                if (result.isHTML) {
                    // HTML å†…å®¹ï¼ˆå¦‚å›¾ç‰‡ï¼‰ç›´æ¥æ˜¾ç¤º
                    dom.contentBody.innerHTML = result.content;
                } else {
                    // æ–‡æœ¬å†…å®¹éœ€è¦ HTML è½¬ä¹‰
                    const safeContent = result.content
                        .replace(/&/g, "&amp;")
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;");
                    dom.contentBody.innerHTML = `<pre>${safeContent}</pre>`;
                }
            } catch (e) {
                console.error('åŠ è½½å†…å®¹å¤±è´¥:', e);
                dom.contentBody.innerHTML = `<div class="empty-state" style="color: var(--error-color);">åŠ è½½å¤±è´¥: ${e.message}</div>`;
            }
        }

        /* ==================== å…¥å£ç‚¹ ==================== */

        /**
         * SDK å°±ç»ªäº‹ä»¶ç›‘å¬
         * æ€æºä¼šåœ¨æ³¨å…¥ pluginSdk åè§¦å‘æ­¤äº‹ä»¶
         */
        window.addEventListener('pluginSdkReady', () => {
            console.log('âœ“ pluginSdk å·²å°±ç»ª');
            console.log('- ä¸»é¢˜æ¨¡å¼:', window.pluginSdk.themeMode);
            console.log('- æ ·å¼å˜é‡:', window.pluginSdk.styleVar);
            init();
        });

    </script>
</body>

</html>