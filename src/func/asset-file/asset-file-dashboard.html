<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Dashboard</title>
    <link rel="stylesheet" href="/plugins/sy-f-misc/styles/hspa-mini.css">
    <style>
        /* Custom styles extending hspa-mini */
        :root {
            --detail-width: 400px;
        }

        .toolbar-actions {
            flex-wrap: nowrap;
            overflow-x: auto;
        }

        .toolbar-divider {
            width: 1px;
            height: 24px;
            background-color: var(--c-border);
            margin: 0 var(--sp-1);
            flex: none;
        }

        @media (max-width: 600px) {
            .toolbar-divider { display: none; }
        }

        .emoji-icon {
            font-size: 2.25em;
            line-height: 1;
        }

        .select-all {
            user-select: all;
        }

        .hover-surface:hover {
            background-color: var(--c-surface-hover);
        }

        .fs-close-btn {
            position: absolute;
            top: var(--sp-4);
            right: var(--sp-4);
            padding: var(--sp-2);
            cursor: pointer;
            border-radius: var(--radius);
            background-color: rgba(0, 0, 0, 0.5);
            color: #fff;
            transition: background-color var(--transition);
        }

        .fs-close-btn:hover {
            background-color: rgba(0, 0, 0, 0.7);
        }

        .zoom-controls {
            position: absolute;
            left: 50%;
            bottom: var(--sp-8);
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: #fff;
        }

        .btn-on-dark {
            color: #fff;
            border-color: rgba(255, 255, 255, 0.3);
            background-color: transparent;
        }

        .btn-on-dark:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* Detail Panel Drawer */
        #detail-panel {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: var(--detail-width);
            background-color: var(--c-bg);
            border-left: 1px solid var(--c-border);
            transform: translateX(100%);
            transition: transform var(--transition);
            z-index: var(--z-overlay);
            display: flex;
            flex-direction: column;
            box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
        }

        #detail-panel.open {
            transform: translateX(0);
        }

        /* File Thumbnails */
        .file-card-thumb {
            width: 100%;
            height: 140px;
            object-fit: contain;
            border-radius: var(--radius);
            background-color: var(--c-surface);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            color: var(--c-fg-muted);
            overflow: hidden;
        }

        .file-card-thumb img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: var(--radius);
        }

        .file-list-thumb {
            width: 32px;
            height: 32px;
            object-fit: cover;
            border-radius: var(--radius-sm);
            background-color: var(--c-surface);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            color: var(--c-fg-muted);
            flex-shrink: 0;
        }

        .file-list-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: var(--radius-sm);
        }

        /* Selected state */
        .selected-item {
            background-color: var(--c-accent-bg) !important;
            border-color: var(--c-accent) !important;
        }

        /* Preview Box in Detail Panel */
        .preview-box {
            width: 100%;
            height: 200px;
            background-color: var(--c-surface);
            border: 1px solid var(--c-border);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin-bottom: var(--sp-4);
        }

        .preview-box img, .preview-box video {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* Fullscreen Preview */
        #fullscreen-preview {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: var(--z-modal);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #fullscreen-preview.active {
            display: flex;
        }

        #fullscreen-content img.dragging {
            cursor: grabbing;
        }

        #fullscreen-content img {
            cursor: grab;
            max-width: 90vw;
            max-height: 90vh;
        }

        .text-preview {
            background: var(--c-bg);
            color: var(--c-fg);
            padding: 20px;
            border-radius: var(--radius);
            max-width: 80vw;
            max-height: 80vh;
            overflow: auto;
            white-space: pre-wrap;
        }

        /* Drag & Drop Upload Area */
        .upload-area {
            border: 2px dashed var(--c-border);
            border-radius: var(--radius-lg);
            background-color: var(--c-surface);
            transition: all var(--transition);
        }
        .upload-area:hover, .upload-area.drag-over {
            border-color: var(--c-accent);
            background-color: var(--c-accent-bg);
        }

        /* Responsive */
        @media (max-width: 600px) {
            :root { --detail-width: 100%; }
            .toolbar-group { flex-wrap: wrap; }
        }
    </style>
</head>

<body class="page">
    <div class="page-header flex items-center gap-2 overflow-hidden">
        <!-- Toolbar Row 1: Search -->
        <div class="flex items-center gap-2 flex-none" style="width: 300px;">
            <div class="search-box flex-1 relative">
                <input type="text" class="input" id="search-input" placeholder="ÊêúÁ¥¢Êñá‰ª∂...">
            </div>
            <label class="check-row flex-none p-1">
                <input type="checkbox" id="regex-search">
                <span class="text-sm">Ê≠£Âàô</span>
            </label>
        </div>

        <!-- Toolbar Row 2: Actions -->
        <div class="toolbar-actions flex items-center gap-2 flex-1 justify-end">
            <select class="select text-sm" style="width:auto" id="page-size">
                <option value="50">50/È°µ</option>
                <option value="100" selected>100/È°µ</option>
                <option value="200">200/È°µ</option>
                <option value="500">500/È°µ</option>
            </select>

            <select class="select text-sm" style="width:auto" id="type-filter">
                <option value="all">ÊâÄÊúâÁ±ªÂûã</option>
                <option value="image">ÂõæÁâá</option>
                <option value="video">ËßÜÈ¢ë</option>
                <option value="audio">Èü≥È¢ë</option>
                <option value="document">ÊñáÊ°£</option>
                <option value="archive">ÂéãÁº©ÂåÖ</option>
                <option value="other">ÂÖ∂‰ªñ</option>
            </select>

            <select class="select text-sm" style="width:auto" id="sort-by">
                <option value="updated-desc">‰øÆÊîπÊó∂Èó¥‚Üì</option>
                <option value="updated-asc">‰øÆÊîπÊó∂Èó¥‚Üë</option>
                <option value="name-asc">ÂêçÁß∞A-Z</option>
                <option value="name-desc">ÂêçÁß∞Z-A</option>
            </select>

            <div class="toolbar-divider" aria-hidden="true"></div>

            <button class="btn btn-icon" id="view-toggle-btn" title="ÂàáÊç¢ËßÜÂõæ">
                <!-- SVG Icon for Grid/List -->
                <svg class="icon icon-stroke icon-md" id="view-icon-grid" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                <svg class="icon icon-stroke icon-md hidden" id="view-icon-list" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
            </button>
            <button class="btn btn-icon" id="refresh-btn" title="Âà∑Êñ∞">
                <svg class="icon icon-stroke icon-md" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
            </button>
        </div>
    </div>

    <div class="page-body relative overflow-hidden">
        <!-- Main Content -->
        <div id="file-list-container" class="h-full scroll-y p-4">
            <div id="file-list" class="grid grid-auto-fill gap-4">
                <!-- Content handled by JS -->
            </div>
        </div>

        <!-- Detail Panel Drawer -->
        <div id="detail-panel">
            <div class="p-3 border-b flex-between" style="background:var(--c-bg)">
                <span class="text-lg text-bold">Êñá‰ª∂ËØ¶ÊÉÖ</span>
                <button class="btn btn-icon btn-sm" id="close-panel">
                    <svg class="icon icon-stroke icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="flex-1 scroll-y p-4" id="detail-content">
                <!-- Detail Content -->
            </div>
        </div>
    </div>

    <div class="page-footer flex items-center justify-between gap-2 text-nowrap">
        <div class="flex items-center gap-2 flex-1">
            <span class="text-xs text-muted" id="page-info"></span>
        </div>

        <div class="flex items-center justify-center gap-2 flex-none">
            <button class="btn btn-sm" id="prev-page">‰∏ä‰∏ÄÈ°µ</button>
            <div class="flex gap-1" id="page-numbers"></div>
            <button class="btn btn-sm" id="next-page">‰∏ã‰∏ÄÈ°µ</button>
        </div>

        <div class="flex items-center justify-end gap-1 flex-1">
            <input type="number" class="input py-1 px-2 text-center text-sm" style="width: 50px;" id="page-jump" min="1">
            <button class="btn btn-sm" id="jump-btn">Ë∑≥ËΩ¨</button>
        </div>
    </div>

    <!-- Hidden Input -->
    <input type="file" id="file-input" style="display: none;">

    <!-- Replace Dialog -->
    <div id="replace-dialog" class="fixed inset-0 flex-center hidden" style="background-color: rgba(0,0,0,0.5); z-index: var(--z-modal);">
        <div class="rounded-lg shadow-lg max-w-md w-full p-6 flex flex-col gap-4" style="background-color: var(--c-bg);">
            <div class="text-lg text-bold">ÊõøÊç¢Êñá‰ª∂: <span id="replace-filename" class="text-accent"></span></div>

            <div class="upload-area p-8 text-center cursor-pointer flex flex-col items-center gap-2" id="replace-upload-area">
                <div class="emoji-icon">üìÅ</div>
                <div class="text-base">ÁÇπÂáªÊàñÊãñÊîæÊñá‰ª∂Âà∞ËøôÈáå</div>
                <div class="text-xs text-muted">ÊîØÊåÅÂõæÁâáÁ≤òË¥¥ (Ctrl+V)</div>
            </div>

            <div class="hidden" id="replace-preview">
                <div class="flex justify-center mb-2">
                    <img id="replace-preview-img" src="" class="rounded border" style="max-height: 128px;">
                </div>
                <div class="text-xs text-center text-muted" id="replace-preview-info"></div>
            </div>

            <div class="flex justify-end gap-2 mt-2">
                <button class="btn" onclick="app.closeReplaceDialog()">ÂèñÊ∂à</button>
                <button class="btn btn-primary" id="confirm-replace-btn" disabled onclick="app.confirmReplace()">Á°ÆËÆ§ÊõøÊç¢</button>
            </div>
        </div>
    </div>

    <!-- Fullscreen Preview -->
    <div id="fullscreen-preview">
        <div class="fs-close-btn" onclick="app.closeFullscreen()">
            <svg class="icon icon-stroke icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </div>

        <div id="fullscreen-content" class="flex-center w-full h-full p-4"></div>

        <div id="zoom-controls" class="zoom-controls flex items-center gap-2 px-4 py-2 rounded-full hidden">
            <button class="btn btn-icon btn-sm btn-on-dark" onclick="app.imageViewer.zoomOut()">-</button>
            <span class="text-sm text-center" id="zoom-info" style="min-width: 50px;">100%</span>
            <button class="btn btn-icon btn-sm btn-on-dark" onclick="app.imageViewer.zoomIn()">+</button>
            <button class="btn btn-sm btn-on-dark" style="margin-left: var(--sp-2);" onclick="app.imageViewer.resetZoom()">ÈáçÁΩÆ</button>
        </div>
    </div>

    <script>
        /* ==================== Logic ==================== */

        class ImageViewer {
            constructor(imgElement) {
                this.img = imgElement;
                this.scale = 1;
                this.translateX = 0;
                this.translateY = 0;
                this.isDragging = false;
                this.startX = 0;
                this.startY = 0;
                this.minScale = 0.1;
                this.maxScale = 10;
                this.scaleStep = 0.2;
                this.bindEvents();
                this.updateTransform();
            }

            bindEvents() {
                this.wheelHandler = (e) => {
                    e.preventDefault();
                    this.zoom(e.deltaY > 0 ? -this.scaleStep : this.scaleStep);
                };
                this.img.addEventListener('wheel', this.wheelHandler, { passive: false });

                this.mouseDownHandler = (e) => {
                    e.preventDefault();
                    this.isDragging = true;
                    this.startX = e.clientX - this.translateX;
                    this.startY = e.clientY - this.translateY;
                    this.img.classList.add('dragging');
                };
                this.img.addEventListener('mousedown', this.mouseDownHandler);

                this.mouseMoveHandler = (e) => {
                    if (!this.isDragging) return;
                    e.preventDefault();
                    this.translateX = e.clientX - this.startX;
                    this.translateY = e.clientY - this.startY;
                    this.updateTransform();
                };
                document.addEventListener('mousemove', this.mouseMoveHandler);

                this.mouseUpHandler = () => {
                    this.isDragging = false;
                    this.img.classList.remove('dragging');
                };
                document.addEventListener('mouseup', this.mouseUpHandler);
            }

            zoom(delta) {
                this.scale = Math.max(this.minScale, Math.min(this.maxScale, this.scale + delta));
                this.updateTransform();
                this.updateZoomInfo();
            }
            zoomIn() { this.zoom(this.scaleStep); }
            zoomOut() { this.zoom(-this.scaleStep); }
            resetZoom() {
                this.scale = 1; this.translateX = 0; this.translateY = 0;
                this.updateTransform();
                this.updateZoomInfo();
            }
            updateTransform() {
                this.img.style.transform = `translate(${this.translateX}px, ${this.translateY}px) scale(${this.scale})`;
            }
            updateZoomInfo() {
                const el = document.getElementById('zoom-info');
                if (el) el.textContent = `${Math.round(this.scale * 100)}%`;
            }
            destroy() {
                this.img.removeEventListener('wheel', this.wheelHandler);
                this.img.removeEventListener('mousedown', this.mouseDownHandler);
                document.removeEventListener('mousemove', this.mouseMoveHandler);
                document.removeEventListener('mouseup', this.mouseUpHandler);
            }
        }

        class AssetManager {
            constructor() {
                this.assets = [];
                this.filteredAssets = [];
                this.currentView = 'grid';
                this.selectedFile = null;
                this.filterText = '';
                this.typeFilter = 'all';
                this.sortBy = 'updated-desc';
                this.regexSearch = false;
                this.currentPage = 1;
                this.pageSize = 100;

                this.dom = {
                    listContainer: document.getElementById('file-list'),
                    detailPanel: document.getElementById('detail-panel'),
                    detailContent: document.getElementById('detail-content'),
                    searchInput: document.getElementById('search-input'),
                    regexSearch: document.getElementById('regex-search'),
                    pageSize: document.getElementById('page-size'),
                    typeFilter: document.getElementById('type-filter'),
                    sortBy: document.getElementById('sort-by'),
                    viewToggleBtn: document.getElementById('view-toggle-btn'),
                    refreshBtn: document.getElementById('refresh-btn'),
                    closePanelBtn: document.getElementById('close-panel'),
                    fileInput: document.getElementById('file-input'),
                    prevPageBtn: document.getElementById('prev-page'),
                    nextPageBtn: document.getElementById('next-page'),
                    pageNumbers: document.getElementById('page-numbers'),
                    pageInfo: document.getElementById('page-info'),
                    pageJump: document.getElementById('page-jump'),
                    jumpBtn: document.getElementById('jump-btn'),
                    fullscreenPreview: document.getElementById('fullscreen-preview'),
                    fullscreenContent: document.getElementById('fullscreen-content'),
                    replaceDialog: document.getElementById('replace-dialog'),
                    replaceUploadArea: document.getElementById('replace-upload-area'),
                    replacePreview: document.getElementById('replace-preview'),
                    replacePreviewImg: document.getElementById('replace-preview-img'),
                    replacePreviewInfo: document.getElementById('replace-preview-info'),
                    replaceFilename: document.getElementById('replace-filename'),
                    confirmReplaceBtn: document.getElementById('confirm-replace-btn')
                };

                this.bindEvents();
            }

            bindEvents() {
                this.dom.searchInput.addEventListener('input', (e) => {
                    this.filterText = e.target.value; this.currentPage = 1; this.applyFiltersAndSort();
                });
                this.dom.regexSearch.addEventListener('change', (e) => {
                    this.regexSearch = e.target.checked; this.currentPage = 1; this.applyFiltersAndSort();
                });
                this.dom.pageSize.addEventListener('change', (e) => {
                    this.pageSize = parseInt(e.target.value); this.currentPage = 1; this.renderList();
                });
                this.dom.typeFilter.addEventListener('change', (e) => {
                    this.typeFilter = e.target.value; this.currentPage = 1; this.applyFiltersAndSort();
                });
                this.dom.sortBy.addEventListener('change', (e) => {
                    this.sortBy = e.target.value; this.applyFiltersAndSort();
                });
                this.dom.viewToggleBtn.addEventListener('click', () => {
                    this.currentView = this.currentView === 'grid' ? 'list' : 'grid';
                    // Update DOM classes based on HSPA Mini
                    const gridIcon = document.getElementById('view-icon-grid');
                    const listIcon = document.getElementById('view-icon-list');

                    if (this.currentView === 'grid') {
                        this.dom.listContainer.className = 'grid grid-auto-fill gap-4';
                        gridIcon.classList.remove('hidden');
                        listIcon.classList.add('hidden');
                    } else {
                        this.dom.listContainer.className = 'list list-divided';
                        gridIcon.classList.add('hidden');
                        listIcon.classList.remove('hidden');
                    }
                    this.renderList();
                });
                this.dom.refreshBtn.addEventListener('click', () => this.loadAssets());
                this.dom.closePanelBtn.addEventListener('click', () => this.closePanel());

                // Pagination
                this.dom.prevPageBtn.addEventListener('click', () => { if (this.currentPage > 1) { this.currentPage--; this.renderList(); } });
                this.dom.nextPageBtn.addEventListener('click', () => { if (this.currentPage < Math.ceil(this.filteredAssets.length / this.pageSize)) { this.currentPage++; this.renderList(); } });
                this.dom.jumpBtn.addEventListener('click', () => {
                    const page = parseInt(this.dom.pageJump.value);
                    if (page >= 1 && page <= Math.ceil(this.filteredAssets.length / this.pageSize)) { this.currentPage = page; this.renderList(); }
                });

                // Replace Dialog
                this.dom.replaceUploadArea.addEventListener('click', () => this.dom.fileInput.click());
                this.dom.fileInput.addEventListener('change', (e) => { if(e.target.files[0]) this.handleReplaceFileSelect(e.target.files[0]); });
                this.dom.replaceUploadArea.addEventListener('dragover', (e) => { e.preventDefault(); this.dom.replaceUploadArea.classList.add('drag-over'); });
                this.dom.replaceUploadArea.addEventListener('dragleave', () => { this.dom.replaceUploadArea.classList.remove('drag-over'); });
                this.dom.replaceUploadArea.addEventListener('drop', (e) => {
                    e.preventDefault(); this.dom.replaceUploadArea.classList.remove('drag-over');
                    if(e.dataTransfer.files[0]) this.handleReplaceFileSelect(e.dataTransfer.files[0]);
                });
                document.addEventListener('paste', (e) => {
                    if (!this.dom.replaceDialog.classList.contains('hidden')) {
                        for (let item of e.clipboardData.items) {
                            if (item.type.indexOf('image') !== -1) {
                                this.handleReplaceFileSelect(item.getAsFile()); break;
                            }
                        }
                    }
                });
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') { this.closeFullscreen(); this.closeReplaceDialog(); }
                });
            }

            async init() {
                const sdk = window.pluginSdk;
                if (!sdk) return;
                document.documentElement.setAttribute('data-theme-mode', sdk.themeMode || 'light');
                await this.loadAssets();
            }

            async getFileSize(filename) {
                if (window.pluginSdk.getFileSize) {
                    const ans = await window.pluginSdk.getFileSize(`/data/assets/${filename}`);
                    return ans.size;
                }
                return null;
            }

            async loadAssets() {
                this.dom.listContainer.innerHTML = '<div class="empty-state"><div>Âä†ËΩΩ‰∏≠...</div></div>';
                try {
                    const res = await window.pluginSdk.request('/api/file/readDir', { path: '/data/assets' });
                    if (!res.ok) throw new Error(res.msg);
                    this.assets = res.data.filter(item => !item.isDir);
                    this.applyFiltersAndSort();
                } catch (e) {
                    this.dom.listContainer.innerHTML = `<div class="empty-state text-error"><div>Âä†ËΩΩÂ§±Ë¥•: ${e.message}</div></div>`;
                    window.pluginSdk.showMessage(e.message, 'error');
                }
            }

            applyFiltersAndSort() {
                // Filter
                this.filteredAssets = this.assets.filter(file => {
                    if (this.filterText) {
                        try {
                            if (this.regexSearch && !new RegExp(this.filterText, 'i').test(file.name)) return false;
                            else if (!this.regexSearch && !file.name.toLowerCase().includes(this.filterText.toLowerCase())) return false;
                        } catch {
                            if (!file.name.toLowerCase().includes(this.filterText.toLowerCase())) return false;
                        }
                    }
                    if (this.typeFilter !== 'all' && this.getFileType(file.name) !== this.typeFilter) return false;
                    return true;
                });

                // Sort
                this.filteredAssets.sort((a, b) => {
                    switch (this.sortBy) {
                        case 'updated-desc': return (b.updated || 0) - (a.updated || 0);
                        case 'updated-asc': return (a.updated || 0) - (b.updated || 0);
                        case 'name-asc': return a.name.localeCompare(b.name);
                        case 'name-desc': return b.name.localeCompare(a.name);
                        default: return 0;
                    }
                });
                this.renderList();
            }

            getFileType(filename) {
                const ext = filename.split('.').pop().toLowerCase();
                if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg', 'bmp', 'ico'].includes(ext)) return 'image';
                if (['mp4', 'webm', 'ogg', 'mov', 'avi', 'mkv'].includes(ext)) return 'video';
                if (['mp3', 'wav', 'ogg', 'flac', 'm4a', 'aac'].includes(ext)) return 'audio';
                if (['pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'txt', 'md'].includes(ext)) return 'document';
                if (['zip', 'rar', '7z', 'tar', 'gz'].includes(ext)) return 'archive';
                return 'other';
            }

            renderList() {
                const totalPages = Math.ceil(this.filteredAssets.length / this.pageSize) || 1;
                this.dom.pageInfo.textContent = `ÂÖ± ${this.filteredAssets.length} È°π`;
                this.dom.prevPageBtn.disabled = this.currentPage === 1;
                this.dom.nextPageBtn.disabled = this.currentPage >= totalPages;
                this.renderPageNumbers(totalPages);

                if (this.filteredAssets.length === 0) {
                    this.dom.listContainer.innerHTML = '<div class="empty-state"><div>Ê≤°ÊúâÊâæÂà∞Êñá‰ª∂</div></div>';
                    return;
                }

                const start = (this.currentPage - 1) * this.pageSize;
                const pageData = this.filteredAssets.slice(start, start + this.pageSize);

                this.dom.listContainer.innerHTML = '';

                pageData.forEach(file => {
                    const isSelected = this.selectedFile?.name === file.name;
                    const el = document.createElement('div');
                    el.onclick = () => this.selectFile(file, el);

                    const isImage = /\.(jpg|jpeg|png|gif|webp|svg|bmp)$/i.test(file.name);
                    // Use ?t= param to prevent caching
                    const imgUrl = `/assets/${file.name}?t=${file.updated || ''}`;

                    if (this.currentView === 'grid') {
                        el.className = `card card-hover cursor-pointer p-2 flex flex-col items-center gap-2 ${isSelected ? 'selected-item' : ''}`;
                        el.innerHTML = `
                            <div class="file-card-thumb">
                                ${isImage ? `<img src="${imgUrl}" loading="lazy">` : this.getFileIcon(file.name)}
                            </div>
                            <div class="text-xs text-center text-truncate w-full" title="${file.name}">${file.name}</div>
                        `;
                    } else {
                        el.className = `list-item ${isSelected ? 'selected-item' : ''}`;
                        el.innerHTML = `
                            <div class="file-list-thumb">
                                ${isImage ? `<img src="${imgUrl}" loading="lazy">` : this.getFileIcon(file.name)}
                            </div>
                            <div class="flex-1 text-sm text-truncate" title="${file.name}">${file.name}</div>
                            <div class="text-xs text-muted">${file.updated ? this.formatDate(file.updated) : '-'}</div>
                        `;
                    }
                    this.dom.listContainer.appendChild(el);
                });
            }

            renderPageNumbers(totalPages) {
                this.dom.pageNumbers.innerHTML = '';
                if (totalPages <= 1) return;

                const createBtn = (p, text) => {
                    const btn = document.createElement('button');
                    btn.className = `btn btn-sm ${p === this.currentPage ? 'btn-primary' : ''}`;
                    btn.textContent = text || p;
                    if (p === '...') { btn.disabled = true; btn.classList.add('btn-ghost'); }
                    else btn.onclick = () => { this.currentPage = p; this.renderList(); };
                    return btn;
                };

                // Simple pagination logic
                if (totalPages <= 6) {
                    for(let i=1; i<=totalPages; i++) this.dom.pageNumbers.appendChild(createBtn(i));
                } else {
                    this.dom.pageNumbers.appendChild(createBtn(1));
                    if (this.currentPage > 3) this.dom.pageNumbers.appendChild(createBtn('...'));

                    const start = Math.max(2, this.currentPage - 1);
                    const end = Math.min(totalPages - 1, this.currentPage + 1);

                    for(let i=start; i<=end; i++) this.dom.pageNumbers.appendChild(createBtn(i));

                    if (this.currentPage < totalPages - 2) this.dom.pageNumbers.appendChild(createBtn('...'));
                    this.dom.pageNumbers.appendChild(createBtn(totalPages));
                }
            }

            getFileIcon(filename) {
                const ext = filename.split('.').pop().toLowerCase();
                const icons = {
                    pdf: 'üìÑ', doc: 'üìù', docx: 'üìù', xls: 'üìä', xlsx: 'üìä',
                    ppt: 'üìë', pptx: 'üìë', txt: 'üìÉ', md: 'üìù', zip: 'üì¶',
                    rar: 'üì¶', '7z': 'üì¶', mp3: 'üéµ', wav: 'üéµ', mp4: 'üé¨',
                    mov: 'üé¨', webm: 'üé¨', json: 'üìã', xml: 'üìã', csv: 'üìä',
                    html: 'üåê', css: 'üé®', js: 'üìú', ts: 'üìú'
                };
                return icons[ext] || 'üìÑ';
            }

            selectFile(file, el) {
                if (this.currentView === 'grid') {
                    document.querySelectorAll('.card').forEach(i => i.classList.remove('selected-item'));
                } else {
                    document.querySelectorAll('.list-item').forEach(i => i.classList.remove('selected-item'));
                }
                el.classList.add('selected-item');
                this.selectedFile = file;
                this.renderDetail(file);
                this.dom.detailPanel.classList.add('open');
            }

            async renderDetail(file) {
                const type = this.getFileType(file.name);
                const url = `/assets/${file.name}?t=${file.updated || ''}`;

                let preview = ``;
                if (type === 'image') preview = `<img src="${url}">`;
                else if (type === 'video') preview = `<video src="${url}" controls></video>`;
                else preview = `<div style="font-size: 3em; line-height: 1;">${this.getFileIcon(file.name)}</div>`;

                // Wrap in click container for fullscreen
                preview = `<div class="preview-box cursor-pointer" onclick="app.openFullscreen('${file.name}', '${type}')">${preview}</div>`;

                this.dom.detailContent.innerHTML = `
                    ${preview}
                    <div class="flex flex-col gap-2">
                        <div class="form-group">
                            <span class="text-xs text-muted">Êñá‰ª∂Âêç</span>
                            <div class="text-sm text-break select-all p-1 rounded border" style="background-color: var(--c-surface);">${this.escapeHtml(file.name)}</div>
                        </div>
                        <div class="flex gap-4">
                            <div class="form-group flex-1">
                                <span class="text-xs text-muted">Á±ªÂûã</span>
                                <div class="text-sm">${type}</div>
                            </div>
                            <div class="form-group flex-1">
                                <span class="text-xs text-muted">Â§ßÂ∞è</span>
                                <div class="text-sm" id="file-size-val">ËÆ°ÁÆó‰∏≠...</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <span class="text-xs text-muted">‰øÆÊîπÊó∂Èó¥</span>
                            <div class="text-sm">${this.formatDate(file.updated)}</div>
                        </div>

                        <div class="divider"></div>

                        <div class="grid grid-cols-2 gap-2">
                            <button class="btn btn-sm" onclick="app.checkReferences('${this.escapeAttribute(file.name)}')">üîç Êü•ÊâæÂºïÁî®</button>
                            <button class="btn btn-sm" onclick="app.copyLink('${this.escapeAttribute(file.name)}')">üìã Â§çÂà∂ÈìæÊé•</button>
                            <button class="btn btn-sm" onclick="app.copyFileContent('${this.escapeAttribute(file.name)}')">üìÑ Â§çÂà∂ÂÜÖÂÆπ</button>
                            <button class="btn btn-sm" onclick="app.downloadFile('${this.escapeAttribute(file.name)}')">‚¨áÔ∏è ‰∏ãËΩΩÊñá‰ª∂</button>
                            <button class="btn btn-sm" style="grid-column: span 2 / span 2;" onclick="app.triggerReplace('${this.escapeAttribute(file.name)}')">üîÑ ÊõøÊç¢Êñá‰ª∂</button>
                        </div>

                        <div id="ref-results" class="mt-4 flex flex-col gap-1 text-sm"></div>
                    </div>
                `;

                this.getFileSize(file.name).then(size => {
                    const el = document.getElementById('file-size-val');
                    if (el) el.textContent = size !== null ? this.formatSize(size) : 'Êú™Áü•';
                });
            }

            async checkReferences(filename) {
                const div = document.getElementById('ref-results');
                div.innerHTML = '<div class="text-muted">Ê≠£Âú®ÊêúÁ¥¢ÂºïÁî®...</div>';
                try {
                    const safe = filename.replace(/'/g, "''");
                    const sql = `SELECT * FROM blocks WHERE (markdown LIKE '%/assets/${safe}%' OR markdown LIKE '%assets/${safe}%') LIMIT 50`;
                    const blocks = await window.pluginSdk.querySQL(sql);

                    if (!blocks.length) {
                        div.innerHTML = '<div class="text-muted">Êú™ÊâæÂà∞ÂºïÁî®</div>';
                        return;
                    }

                    div.innerHTML = blocks.map(b => `
                        <div class="card p-2 cursor-pointer hover-surface" onclick="window.pluginSdk.openBlock('${b.id}')">
                            <div class="text-truncate">${this.escapeHtml(b.content || 'Êó†ÂÜÖÂÆπ')}</div>
                            <div class="text-xs text-muted text-truncate">${b.hpath}</div>
                        </div>
                    `).join('');
                } catch (e) {
                    div.innerHTML = `<div class="text-error">Êü•ËØ¢Èîô: ${e.message}</div>`;
                }
            }

            copyLink(name) {
                navigator.clipboard.writeText(`![${name}](/assets/${name})`).then(() => window.pluginSdk.showMessage('ÈìæÊé•Â∑≤Â§çÂà∂'));
            }

            async copyFileContent(name) {
                try {
                    if (this.getFileType(name) === 'image') {
                        const res = await fetch(`/assets/${name}?t=${this.selectedFile?.updated}`);
                        const blob = await res.blob();
                        await navigator.clipboard.write([new ClipboardItem({[blob.type]: blob})]);
                    } else {
                        const res = await window.pluginSdk.loadBlob(`/data/assets/${name}`);
                        if(!res.ok) throw new Error('Load failed');
                        await navigator.clipboard.writeText(await res.data.text());
                    }
                    window.pluginSdk.showMessage('Â∑≤Â§çÂà∂');
                } catch(e) { window.pluginSdk.showMessage('Â§çÂà∂Â§±Ë¥•: '+e.message, 'error'); }
            }

            downloadFile(name) {
                const a = document.createElement('a');
                a.href = `/assets/${name}?t=${this.selectedFile?.updated}`;
                a.download = name;
                a.click();
            }

            triggerReplace(name) {
                this.replaceTargetFilename = name;
                this.dom.replaceFilename.textContent = name;
                this.dom.replacePreview.classList.add('hidden');
                this.dom.confirmReplaceBtn.disabled = true;
                this.dom.replaceDialog.classList.remove('hidden');
                this.dom.replaceDialog.classList.add('flex'); // hspa-flex-center override
            }

            closeReplaceDialog() {
                this.dom.replaceDialog.classList.add('hidden');
                this.dom.replaceDialog.classList.remove('flex');
                this.replaceFile = null;
            }

            handleReplaceFileSelect(file) {
                const ext1 = this.replaceTargetFilename.split('.').pop().toLowerCase();
                const ext2 = file.name.split('.').pop().toLowerCase();
                if (ext1 !== ext2) { window.pluginSdk.showMessage(`Á±ªÂûã‰∏çÂåπÈÖç: ÈúÄ .${ext1}`, 'error'); return; }

                this.replaceFile = file;
                if (this.getFileType(file.name) === 'image') {
                    const reader = new FileReader();
                    reader.onload = e => {
                        this.dom.replacePreviewImg.src = e.target.result;
                        this.dom.replacePreview.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                } else {
                    this.dom.replacePreview.classList.add('hidden');
                }

                this.dom.replacePreviewInfo.textContent = `${file.name} (${this.formatSize(file.size)})`;
                this.dom.confirmReplaceBtn.disabled = false;
            }

            async confirmReplace() {
                if(!this.replaceFile) return;
                try {
                    this.dom.confirmReplaceBtn.disabled = true;
                    this.dom.confirmReplaceBtn.textContent = 'ÊõøÊç¢‰∏≠...';
                    await window.pluginSdk.saveBlob(`/data/assets/${this.replaceTargetFilename}`, this.replaceFile);
                    window.pluginSdk.showMessage('ÊõøÊç¢ÊàêÂäü');
                    this.closeReplaceDialog();
                    this.loadAssets();
                    // Refresh detail if same
                    if(this.selectedFile?.name === this.replaceTargetFilename) {
                        // Trick to refresh detail view
                        const fakeFile = {...this.selectedFile, updated: Date.now()};
                        this.renderDetail(fakeFile);
                    }
                } catch(e) { window.pluginSdk.showMessage('ÊõøÊç¢Â§±Ë¥•', 'error'); }
                finally { this.dom.confirmReplaceBtn.textContent = 'Á°ÆËÆ§ÊõøÊç¢'; }
            }

            async openFullscreen(name, type) {
                const content = this.dom.fullscreenContent;
                content.innerHTML = '';
                const url = `/assets/${name}?t=${Date.now()}`;

                if (type === 'image') {
                    content.innerHTML = `<img src="${url}" id="fullscreen-img">`;
                    document.getElementById('zoom-controls').classList.remove('hidden');
                    setTimeout(() => this.imageViewer = new ImageViewer(document.getElementById('fullscreen-img')), 50);
                } else if (type === 'video') {
                    content.innerHTML = `<video src="${url}" controls autoplay style="max-width:90vw; max-height:90vh"></video>`;
                } else if (['document','other'].includes(type) || type === 'text' || name.match(/\.(txt|md|json|js|css|html|xml)$/i)) {
                    // Try text load
                    try {
                        const res = await window.pluginSdk.loadBlob(`/data/assets/${name}`);
                        content.innerHTML = `<div class="text-preview">${this.escapeHtml(await res.data.text())}</div>`;
                    } catch { content.innerHTML = '<div style="color:#fff;">Êó†Ê≥ïÈ¢ÑËßà</div>'; }
                } else {
                    content.innerHTML = '<div style="color:#fff;">‰∏çÊîØÊåÅÈ¢ÑËßà</div>';
                }

                this.dom.fullscreenPreview.classList.add('active');
            }

            closeFullscreen() {
                if(this.imageViewer) { this.imageViewer.destroy(); this.imageViewer = null; }
                document.getElementById('zoom-controls').classList.add('hidden');
                this.dom.fullscreenPreview.classList.remove('active');
            }

            closePanel() {
                this.dom.detailPanel.classList.remove('open');
                this.selectedFile = null;
                if(this.currentView === 'grid') document.querySelectorAll('.card').forEach(i => i.classList.remove('selected-item'));
                else document.querySelectorAll('.list-item').forEach(i => i.classList.remove('selected-item'));
            }

            formatSize(b) {
                if (b===0) return '0 B';
                const i = Math.floor(Math.log(b) / Math.log(1024));
                return parseFloat((b / Math.pow(1024, i)).toFixed(2)) + ' ' + ['B', 'KB', 'MB', 'GB'][i];
            }
            formatDate(ts) {
                if (!ts) return '-';
                return new Date(ts.toString().length === 10 ? ts*1000 : ts).toLocaleString('zh-CN');
            }
            escapeHtml(s) { return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }
            escapeAttribute(s) { return s.replace(/'/g, "\\'").replace(/"/g, '\\"'); }
        }

        const app = new AssetManager();
        window.addEventListener('pluginSdkReady', () => app.init());
        window.addEventListener('search-given-asset-file', (e) => {
            // TODO: Handle external search trigger
        });
    </script>
</body>
</html>
