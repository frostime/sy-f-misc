<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨¡æ¿ç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--theme-background);
            color: var(--theme-on-background);
            font-size: 14px;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .toolbar {
            padding: 12px 16px;
            border-bottom: 1px solid var(--theme-surface-lighter);
            display: flex;
            gap: 8px;
            align-items: center;
            background: var(--theme-surface);
        }

        .toolbar button {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            background: var(--theme-background);
            color: var(--theme-on-background);
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .toolbar button:hover {
            background: var(--theme-surface-hover);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .toolbar button.primary {
            background: var(--theme-primary);
            color: var(--theme-on-primary);
            border-color: var(--theme-primary);
        }

        .content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .list-panel {
            width: 300px;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            background: var(--theme-surface);
        }

        .list-search {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .list-search input {
            width: 100%;
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--theme-background);
            color: var(--theme-on-background);
            font-size: 13px;
            outline: none;
        }

        .list-search input:focus {
            border-color: var(--theme-primary);
        }

        .list-items {
            flex: 1;
            overflow-y: auto;
        }

        .list-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s;
        }

        .list-item:hover {
            background: var(--theme-surface-hover);
        }

        .list-item.active {
            background: var(--theme-primary-light);
            border-left: 3px solid var(--theme-primary);
        }

        .list-item-title {
            font-weight: 500;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .list-item-desc {
            font-size: 12px;
            color: var(--theme-on-surface);
            opacity: 0.7;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .editor-panel {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            background: var(--theme-background);
        }

        .editor-empty {
            text-align: center;
            padding: 64px 24px;
            color: var(--theme-on-surface);
            opacity: 0.5;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
            color: var(--theme-on-background);
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--theme-surface);
            color: var(--theme-on-background);
            font-family: var(--font-family);
            font-size: 14px;
            outline: none;
        }

        #advancedConfig {
            &.form-input,
            .form-textarea,
            .form-select {
                background: var(--theme-background);
            }
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            border-color: var(--theme-primary);
            box-shadow: 0 0 0 2px var(--theme-primary-light);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
            font-family: var(--font-family-code);
            line-height: 1.5;
        }

        .form-help {
            margin-top: 6px;
            font-size: 12px;
            color: var(--theme-on-surface);
            opacity: 0.6;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            margin-top: 32px;
        }

        .btn {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            background: var(--theme-surface);
            color: var(--theme-on-surface);
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn:hover {
            background: var(--theme-surface-hover);
        }

        .btn-primary {
            background: var(--theme-primary);
            color: var(--theme-on-primary);
            border-color: var(--theme-primary);
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }

        .btn-danger {
            background: var(--theme-error);
            color: var(--theme-on-error);
            border-color: var(--theme-error);
        }

        /* Table Styles */
        .var-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            font-size: 13px;
        }

        .var-table th,
        .var-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .var-table th {
            background: var(--theme-surface);
            font-weight: 600;
        }

        .var-table tr:last-child td {
            border-bottom: none;
        }

        .var-table tr:hover {
            background: var(--theme-surface-light);
        }

        /* Dialog Styles */
        dialog {
            padding: 0;
            border: none;
            border-radius: 8px;
            background: var(--theme-surface);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            min-width: 400px;
            color: var(--theme-on-surface);
        }

        dialog::backdrop {
            background: rgba(0, 0, 0, 0.5);
        }

        .dialog-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            font-weight: bold;
            font-size: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dialog-footer {
            padding: 16px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .dialog-body {
            padding: 16px;
            background: var(--theme-background);
            max-height: 60vh;
            overflow-y: auto;
        }

        /* Form Custom */
        .input-with-tip {
            position: relative;
        }
    </style>
</head>

<body>
    <div class="toolbar">
        <button class="primary" onclick="createTemplate()">â• æ–°å»ºæ¨¡æ¿</button>
        <button onclick="importTemplates()">ğŸ“¥ å¯¼å…¥</button>
        <button onclick="exportTemplates()">ğŸ“¤ å¯¼å‡º</button>
        <div style="flex: 1"></div>
        <button onclick="saveAll()">ğŸ’¾ ä¿å­˜æ‰€æœ‰æ›´æ”¹</button>
    </div>

    <div class="content">
        <div class="list-panel">
            <div class="list-search">
                <input type="text" placeholder="æœç´¢æ¨¡æ¿..." id="searchInput" oninput="filterTemplates()">
            </div>
            <div class="list-items" id="templateList"></div>
        </div>

        <div class="editor-panel" id="editorPanel">
            <!-- Content rendered by JS -->
        </div>
    </div>

    <!-- Variable Editor Dialog -->
    <dialog id="varDialog">
        <div class="dialog-header">
            <span id="varDialogTitle">æ·»åŠ å˜é‡</span>
            <button class="btn btn-sm" onclick="closeVarDialog()">âœ–</button>
        </div>
        <div class="dialog-body">
            <div class="form-group">
                <label class="form-label">å˜é‡å (Key) *</label>
                <input type="text" class="form-input" id="vKey" placeholder="ä¾‹å¦‚: title">
                <div class="form-help">åœ¨æ¨¡æ¿ä¸­å¼•ç”¨æ—¶ä½¿ç”¨, å¦‚ {{title}}</div>
            </div>
            <div class="form-group">
                <label class="form-label">æ˜¾ç¤ºåç§° (Label)</label>
                <input type="text" class="form-input" id="vLabel" placeholder="ä¾‹å¦‚: æ–‡ç« æ ‡é¢˜">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">ç±»å‹</label>
                    <select class="form-select" id="vType" onchange="updateVarTypeFields()">
                        <option value="text">æ–‡æœ¬ (Text)</option>
                        <option value="number">æ•°å­— (Number)</option>
                        <option value="bool">å¸ƒå°” (Boolean)</option>
                        <option value="enum">é€‰é¡¹ (Enum)</option>
                    </select>
                </div>
                <!-- Extra Type fields -->
            </div>

            <!-- Type Specific Fields -->
            <div id="typeParams"></div>

            <div class="form-group">
                <label class="form-label">é»˜è®¤å€¼</label>
                <input type="text" class="form-input" id="vDefault" placeholder="">
            </div>

            <div class="form-group">
                <label class="form-label">æè¿°</label>
                <input type="text" class="form-input" id="vDesc" placeholder="å˜é‡ç”¨é€”æç¤º">
            </div>
        </div>
        <div class="dialog-footer">
            <button class="btn" onclick="closeVarDialog()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="saveVariable()">ç¡®å®š</button>
        </div>
    </dialog>

    <script>
        // State
        let sdk = null;
        let templates = [];
        let notebooks = [];
        let currentTemplate = null;
        let onSaveCallback = null;

        // Variable Editor State
        let editingVarKey = null; // null for new, key for editing

        // Initialization
        window.addEventListener('pluginSdkReady', async () => {
            sdk = window.pluginSdk;

            if (sdk.getTemplates) {
                templates = sdk.getTemplates();
                // Data Migration: contentTemplate -> template
                // Migration: variables array -> declaredInputVar object
                // We'll trust the provided data but if we create new ones we stick to new schema
            }
            if (sdk.onSave) {
                onSaveCallback = sdk.onSave;
            }
            if (sdk.notebooks) {
                notebooks = sdk.notebooks();
            }

            // Sync with Theme
            document.documentElement.style.setProperty('--theme-primary', getComputedStyle(document.body).getPropertyValue('--theme-primary'));

            renderList();
            renderEditor();
        });

        // --- List View Logic ---

        function renderList() {
            const container = document.getElementById('templateList');
            container.innerHTML = '';

            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const filtered = searchText
                ? templates.filter(t =>
                    t.name.toLowerCase().includes(searchText) ||
                    (t.group && t.group.toLowerCase().includes(searchText))
                )
                : templates;

            if (filtered.length === 0) {
                container.innerHTML = `<div style="padding:20px; text-align:center; color:gray;">æ— ç»“æœ</div>`;
                return;
            }

            filtered.forEach(template => {
                const item = document.createElement('div');
                item.className = 'list-item' + (currentTemplate?.id === template.id ? ' active' : '');
                item.onclick = () => selectTemplate(template);

                item.innerHTML = `
                    <div class="list-item-title">
                        <span>${template.icon || 'ğŸ“'}</span>
                        <span>${template.name}</span>
                    </div>
                    <div class="list-item-desc">${template.group ? '[' + template.group + '] ' : ''}${template.desc || template.description || 'æ— æè¿°'}</div>
                `;

                container.appendChild(item);
            });
        }

        function filterTemplates() {
            renderList();
        }

        function selectTemplate(template) {
            // Before switching, maybe auto-save current? For now manual save.
            currentTemplate = template;
            renderList();
            renderEditor();
        }

        // --- Editor Logic ---

        function renderEditor() {
            const panel = document.getElementById('editorPanel');

            if (!currentTemplate) {
                panel.innerHTML = `
                    <div class="editor-empty">
                        <div style="font-size: 48px; opacity: 0.3;">ğŸ“</div>
                        <div style="margin-top: 16px;">è¯·é€‰æ‹©æ¨¡æ¿è¿›è¡Œç¼–è¾‘ï¼Œæˆ–åˆ›å»ºæ–°æ¨¡æ¿</div>
                    </div>
                `;
                return;
            }

            const t = currentTemplate;
            // Compatible with legacy 'contentTemplate' or new 'template'
            const content = t.template !== undefined ? t.template : (t.contentTemplate || '');
            const desc = t.desc !== undefined ? t.desc : (t.description || '');

            panel.innerHTML = `
                <h2 style="margin-bottom: 24px; border-left: 4px solid var(--theme-primary); padding-left: 12px;">ç¼–è¾‘æ¨¡æ¿</h2>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">æ¨¡æ¿åç§° *</label>
                        <input type="text" class="form-input" id="name" value="${escapeHtml(t.name)}" oninput="updateModel('name', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">å›¾æ ‡</label>
                        <input type="text" class="form-input" id="icon" value="${escapeHtml(t.icon || '')}" placeholder="ğŸ“" oninput="updateModel('icon', this.value)">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">æè¿°</label>
                    <input type="text" class="form-input" id="desc" value="${escapeHtml(desc)}" placeholder="ç®€çŸ­æè¿°æ­¤æ¨¡æ¿çš„ç”¨é€”" oninput="updateModel('desc', this.value)">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">åˆ†ç»„</label>
                        <input type="text" class="form-input" id="group" value="${escapeHtml(t.group || '')}" placeholder="å·¥ä½œã€ç”Ÿæ´»ç­‰" oninput="updateModel('group', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ’å…¥ç±»å‹</label>
                        <select class="form-select" id="newtype" onchange="updateModel('newtype', this.value); renderEditor();">
                            <option value="block" ${t.newtype === 'block' ? 'selected' : ''}>å—æ’å…¥ (Block)</option>
                            <option value="document" ${t.newtype === 'document' ? 'selected' : ''}>æ–°æ–‡æ¡£ (Document)</option>
                            <option value="dailynote" ${t.newtype === 'dailynote' ? 'selected' : ''}>æ—¥è®° (Daily Note)</option>
                        </select>
                    </div>
                </div>

                <!-- Template Content -->
                <div class="form-group">
                    <label class="form-label">å†…å®¹æ¨¡æ¿ (Markdown) *</label>
                    <textarea class="form-textarea" id="templateContent" style="min-height: 200px;"
                        placeholder="åœ¨æ­¤è¾“å…¥å†…å®¹ï¼Œæ”¯æŒ {{å˜é‡å}} è¯­æ³•" oninput="updateModel('template', this.value)">${escapeHtml(content)}</textarea>
                    <div class="form-help">å¯ä»¥ä½¿ç”¨ <code>{{today}}</code>, <code>{{title}}</code> ç­‰å˜é‡</div>
                </div>

                <!-- Insert To Config (Dynamic) -->
                ${renderInsertConfig(t)}

                <!-- Advanced Config -->
                <div style="border: 1px solid var(--border-color); border-radius: 4px; overflow: hidden; margin-bottom: 20px; background: var(--theme-surface);">
                    <div style="padding: 10px 12px; font-weight: 500; cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none;" onclick="toggleAdvanced(this)">
                        <span>ğŸ› ï¸ é«˜çº§é…ç½® (è„šæœ¬ & é€‰é¡¹)</span>
                        <span id="advArrow" style="font-size: 12px; transition: transform 0.2s;">â–¶</span>
                    </div>
                    <div id="advancedConfig" style="display: none; padding: 16px; border-top: 1px solid var(--border-color);">
                        <div class="form-group">
                            <label class="form-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="openBlock" ${t.openBlock !== false ? 'checked' : ''} onchange="updateModel('openBlock', this.checked)">
                                æ’å…¥åæ‰“å¼€æ‰€åœ¨å— (Open Block)
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">å‰ç½®è„šæœ¬ (Pre-Execute Script)</label>
                            <textarea class="form-textarea" style="min-height: 80px; font-family: monospace; font-size: 12px;"
                                placeholder="return { additionalVar: 'value' };" oninput="updateModel('preExecuteScript', this.value)">${escapeHtml(t.preExecuteScript || '')}</textarea>
                            <div class="form-help">åœ¨æ¸²æŸ“æ¨¡æ¿å‰æ‰§è¡Œï¼Œè¿”å›çš„å¯¹è±¡å°†åˆå¹¶åˆ°æ¨¡æ¿å˜é‡ä¸­ã€‚å¯ä½¿ç”¨ <code>ctx</code> å˜é‡ã€‚</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">åç½®è„šæœ¬ (Post-Execute Script)</label>
                            <textarea class="form-textarea" style="min-height: 80px; font-family: monospace; font-size: 12px;"
                                placeholder="window.siyuan.setBlockAttrs(blockId, { ... });" oninput="updateModel('postExecuteScript', this.value)">${escapeHtml(t.postExecuteScript || '')}</textarea>
                            <div class="form-help">åœ¨æ’å…¥å†…å®¹åæ‰§è¡Œã€‚å¯ç”¨å˜é‡: <code>ctx</code>, <code>content</code>, <code>blockId</code>ã€‚</div>
                        </div>
                    </div>
                </div>

                <!-- Variable Editor -->
                <div class="form-group">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 8px;">
                        <label class="form-label" style="margin-bottom:0;">è¾“å…¥å˜é‡å®šä¹‰</label>
                    </div>

                    <table class="var-table" id="varTable">
                        <thead>
                            <tr>
                                <th style="width: 20%">Key</th>
                                <th style="width: 20%">åç§°</th>
                                <th style="width: 15%">ç±»å‹</th>
                                <th style="width: 30%">é»˜è®¤å€¼</th>
                                <th style="width: 15%">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="varListBody">
                            <!-- Helper will render rows here -->
                        </tbody>
                    </table>
                    <button class="btn btn-sm" style="margin-top: 8px; width: 100%; border-style: dashed;" onclick="openVarDialog()">+ æ·»åŠ å˜é‡</button>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="saveCurrent()">ğŸ’¾ ä¿å­˜å½“å‰æ¨¡æ¿</button>
                    <button class="btn" onclick="duplicateTemplate()">ğŸ“‹ åˆ›å»ºå‰¯æœ¬</button>
                    <button class="btn btn-danger" onclick="deleteTemplate()">ğŸ—‘ï¸ åˆ é™¤æ¨¡æ¿</button>
                </div>

                <div style="height: 40px;"></div>
            `;

            renderVarTable();
        }

        function renderNotebookSelect(currentId, onChangePath, required = false) {
            let html = `
                <div class="form-group">
                    <label class="form-label">ç¬”è®°æœ¬ ${required ? '<span style="color: var(--theme-error); margin-left: 4px;">* (å¿…å¡«)</span>' : '(å¯é€‰)'}</label>
                    <select class="form-select" onchange="updateInsertTo('${onChangePath}', this.value)">
                        <option value="" ${!currentId ? 'selected' : ''}>${required ? 'è¯·é€‰æ‹©ç¬”è®°æœ¬' : 'å½“å‰æ‰“å¼€ç¬”è®°æœ¬'}</option>
            `;

            notebooks.forEach(nb => {
                html += `<option value="${nb.id}" ${nb.id === currentId ? 'selected' : ''}>${escapeHtml(nb.name)}${nb.closed ? ' (å·²å…³é—­)' : ''}</option>`;
            });

            html += `
                    </select>
                </div>
            `;
            return html;
        }

        function renderInsertConfig(t) {
            // Helper to safe access nested properties
            const get = (path, def) => {
                const parts = path.split('.');
                let current = t.insertTo || {};
                for (const p of parts) {
                    if (current === undefined || current === null) return def;
                    current = current[p];
                }
                return current !== undefined ? current : def;
            };

            let html = `<div style="border-radius: 4px; margin-bottom: 20px; border: 1px solid var(--border-color);">`;
            html += `<h3 style="background: var(--theme-surface-light); padding: 2px 0px; font-size: 1em; margin-bottom: 12px; ">ğŸ“ æ’å…¥ä½ç½®é…ç½®</h3>`;

            if (t.newtype === 'block') {
                const type = get('anchorGenerator.type', 'sql');
                const usage = get('usage', 'insert'); // legacy 'usage' ? or anchorUsage?
                // In generic type InsertToAnchor, structure depends.
                // Let's rely on standard structure from types.ts if possible, but UI must be robust.

                html += `
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">é”šç‚¹å®šä½æ–¹å¼</label>
                            <select class="form-select" onchange="updateInsertTo('anchorGenerator.type', this.value)">
                                <option value="sql" ${type === 'sql' ? 'selected' : ''}>SQL æŸ¥è¯¢ (SQL)</option>
                                <option value="js" ${type === 'js' ? 'selected' : ''}>JS è„šæœ¬ (JS)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ’å…¥æ–¹å¼</label>
                            <select class="form-select" onchange="updateInsertTo('usage', this.value)">
                                <option value="insert" ${usage === 'insert' ? 'selected' : ''}>æ’å…¥ (Insert)</option>
                                <option value="append" ${usage === 'append' ? 'selected' : ''}>è¿½åŠ  (Append)</option>
                                <option value="prepend" ${usage === 'prepend' ? 'selected' : ''}>å¼€å¤´ (Prepend)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">å®šä½ä»£ç  (SQL/JS)</label>
                        <textarea class="form-textarea" style="min-height: 80px;" onchange="updateInsertTo('anchorGenerator.searchCode', this.value)">${escapeHtml(get('anchorGenerator.searchCode', ''))}</textarea>
                    </div>
                `;
            } else if (t.newtype === 'document') {
                const type = get('anchorGenerator.type', 'hpath');
                html += `
                     <div class="form-group">
                        <label class="form-label">æ–‡æ¡£å®šä½æ–¹å¼</label>
                        <select class="form-select" onchange="updateInsertTo('anchorGenerator.type', this.value)">
                            <option value="hpath" ${type === 'hpath' ? 'selected' : ''}>è·¯å¾„æ¨¡æ¿ (HPath)</option>
                            <option value="search" ${type === 'search' ? 'selected' : ''}>é«˜çº§æœç´¢ (Search)</option>
                        </select>
                    </div>
                `;
                if (type === 'hpath') {
                    html += `
                    <div class="form-group">
                        <label class="form-label">æ–‡æ¡£è·¯å¾„æ¨¡æ¿</label>
                        <input type="text" class="form-input" value="${escapeHtml(get('anchorGenerator.hpathTemplate', ''))}"
                            placeholder="/Note/{{year}}/{{month}}" onchange="updateInsertTo('anchorGenerator.hpathTemplate', this.value)">
                    </div>
                    ${renderNotebookSelect(get('anchorGenerator.notebook', ''), 'anchorGenerator.notebook')}
                    `;
                } else {
                    html += `
                    <div class="form-group">
                        <label class="form-label">æœç´¢ä»£ç  (JS/SQL)</label>
                        <textarea class="form-textarea" onchange="updateInsertTo('anchorGenerator.searchCode', this.value)">${escapeHtml(get('anchorGenerator.searchCode', ''))}</textarea>
                    </div>`
                }
            } else if (t.newtype === 'dailynote') {
                const usage = get('usage', 'append');
                html += `
                    ${renderNotebookSelect(get('notebook', ''), 'notebook', true)}
                    <div class="form-group">
                        <label class="form-label">æ’å…¥ä½ç½®</label>
                        <select class="form-select" onchange="updateInsertTo('usage', this.value)">
                            <option value="append" ${usage === 'append' ? 'selected' : ''}>æ–‡æ¡£æœ«å°¾</option>
                            <option value="prepend" ${usage === 'prepend' ? 'selected' : ''}>æ–‡æ¡£å¼€å¤´</option>
                        </select>
                    </div>
                `;
            }

            html += `</div>`;
            return html;
        }

        // --- Model Update Logic ---

        function updateModel(field, value) {
            if (!currentTemplate) return;
            currentTemplate[field] = value;
            // Debounce list update?
            if (field === 'name' || field === 'icon' || field === 'group') {
                // simple Update list title UI directly? Or re-render list
                // Re-rendering list is cheap enough usually
                // setTimeout(() => renderList(), 500);
            }
        }

        function updateInsertTo(path, value) {
            if (!currentTemplate) return;
            if (!currentTemplate.insertTo) currentTemplate.insertTo = {};

            const parts = path.split('.');
            let target = currentTemplate.insertTo;
            for (let i = 0; i < parts.length - 1; i++) {
                if (!target[parts[i]]) target[parts[i]] = {};
                target = target[parts[i]];
            }
            target[parts[parts.length - 1]] = value;

            // If type changed, re-render to show appropriate fields
            if (path === 'anchorGenerator.type') {
                renderEditor();
            }
        }

        // --- Variable Logic ---

        function getVarsAsArray() {
            const t = currentTemplate;
            if (!t) return [];

            // Handle legacy Array format
            if (Array.isArray(t.variables)) {
                return t.variables;
            }

            // Handle Object format (declaredInputVar)
            const vars = t.declaredInputVar || {};
            return Object.entries(vars).map(([key, conf]) => ({
                name: key,
                ...conf
            }));
        }

        function saveVarsFromArray(arr) {
            if (!currentTemplate) return;

            // Convert array back to declaredInputVar object
            const decl = {};
            arr.forEach(v => {
                const { name, ...rest } = v;
                decl[name] = rest;
            });

            currentTemplate.declaredInputVar = decl;

            // Clear legacy if exists
            delete currentTemplate.variables;
        }

        function renderVarTable() {
            const tbody = document.getElementById('varListBody');
            if (!tbody) return;

            const vars = getVarsAsArray();
            tbody.innerHTML = '';

            if (vars.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:gray; padding: 20px;">æš‚æ— å˜é‡</td></tr>`;
                return;
            }

            vars.forEach(v => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><code>${escapeHtml(v.name)}</code></td>
                    <td>${escapeHtml(v.label || v.name)}</td>
                    <td><span style="font-size:12px; padding:2px 6px; background:#e0e0e0; border-radius:10px;">${v.type}</span></td>
                    <td>${escapeHtml(String(v.default === undefined ? '' : v.default))}</td>
                    <td>
                        <button class="btn btn-sm" onclick="editVariable('${v.name}')" title="ç¼–è¾‘">âœï¸</button>
                        <button class="btn btn-sm btn-danger" onclick="removeVariable('${v.name}')" title="åˆ é™¤">ğŸ—‘ï¸</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function openVarDialog(key = null) {
            const dialog = document.getElementById('varDialog');
            const vars = getVarsAsArray();
            editingVarKey = key;

            document.getElementById('varDialogTitle').textContent = key ? 'ç¼–è¾‘å˜é‡' : 'æ·»åŠ å˜é‡';

            // Reset Form
            document.getElementById('vKey').value = '';
            document.getElementById('vLabel').value = '';
            document.getElementById('vType').value = 'text';
            document.getElementById('vDefault').value = '';
            document.getElementById('vDesc').value = '';
            document.getElementById('vKey').disabled = false;

            // Fill if editing
            if (key) {
                const v = vars.find(x => x.name === key);
                if (v) {
                    document.getElementById('vKey').value = v.name;
                    document.getElementById('vKey').disabled = true; // Key cannot allow rename easily, simpler to re-create
                    document.getElementById('vLabel').value = v.label || '';
                    document.getElementById('vType').value = v.type || 'text';
                    document.getElementById('vDefault').value = v.default || '';
                    document.getElementById('vDesc').value = v.description || '';
                }
            }

            updateVarTypeFields();
            dialog.showModal();
        }

        function closeVarDialog() {
            document.getElementById('varDialog').close();
        }

        function updateVarTypeFields() {
            const type = document.getElementById('vType').value;
            const container = document.getElementById('typeParams');

            if (type === 'enum') {
                // Get current enum options if editing
                let currentOpts = '';
                if (editingVarKey) {
                    const vars = getVarsAsArray();
                    const v = vars.find(x => x.name === editingVarKey);
                    if (v && v.enum) currentOpts = v.enum.join(', ');
                }

                container.innerHTML = `
                    <div class="form-group">
                         <label class="form-label">é€‰é¡¹åˆ—è¡¨ (é€—å·åˆ†éš”)</label>
                         <textarea class="form-textarea" id="vEnumOpts" style="min-height:60px;" placeholder="é€‰é¡¹A, é€‰é¡¹B, é€‰é¡¹C">${currentOpts}</textarea>
                    </div>
                `;
            } else if (type === 'number') {
                container.innerHTML = `
                   <div class="form-group">
                       <label class="form-label">æ•°å­—èŒƒå›´ (å¯é€‰)</label>
                       <div style="display:flex; gap:8px;">
                           <input type="number" class="form-input" id="vMin" placeholder="Min" style="width: 33%">
                           <input type="number" class="form-input" id="vMax" placeholder="Max" style="width: 33%">
                           <input type="number" class="form-input" id="vStep" placeholder="Step" style="width: 33%">
                       </div>
                   </div>
                `;
                // Fill values if editing... (simplified for brevity)
            } else {
                container.innerHTML = '';
            }
        }

        function saveVariable() {
            const key = document.getElementById('vKey').value.trim();
            if (!key) {
                sdk?.showMessage('è¯·è¾“å…¥å˜é‡å', 'error');
                return;
            }

            const label = document.getElementById('vLabel').value.trim();
            const type = document.getElementById('vType').value;
            const defVal = document.getElementById('vDefault').value;
            const desc = document.getElementById('vDesc').value;

            const newVar = {
                name: key,
                label: label,
                type: type,
                description: desc,
                default: defVal // Convert type later?
            };

            if (type === 'number') newVar.default = Number(defVal) || 0;
            if (type === 'bool') newVar.default = (defVal === 'true' || defVal === '1');

            // Enum handling
            const enumInput = document.getElementById('vEnumOpts');
            if (enumInput) {
                newVar.enum = enumInput.value.split(/[,ï¼Œ]/).map(s => s.trim()).filter(s => s);
            }

            let vars = getVarsAsArray();

            if (editingVarKey) {
                // Update
                const idx = vars.findIndex(v => v.name === editingVarKey);
                if (idx >= 0) {
                    vars[idx] = { ...vars[idx], ...newVar };
                }
            } else {
                // Create
                if (vars.find(v => v.name === key)) {
                    sdk?.showMessage('å˜é‡åå·²å­˜åœ¨', 'error');
                    return;
                }
                vars.push(newVar);
            }

            saveVarsFromArray(vars);
            renderVarTable();
            closeVarDialog();
        }

        function editVariable(key) {
            openVarDialog(key);
        }

        function removeVariable(key) {
            let vars = getVarsAsArray();
            vars = vars.filter(v => v.name !== key);
            saveVarsFromArray(vars);
            renderVarTable();
        }

        // --- Core Actions ---

        function createTemplate() {
            const newTemplate = {
                id: Date.now().toString(),
                name: 'æ–°æ¨¡æ¿',
                icon: 'ğŸ“',
                newtype: 'block',
                template: '', // Use 'template' property
                declaredInputVar: {},
                insertTo: {
                    anchorGenerator: { type: 'sql', searchCode: '' },
                    usage: 'insert'
                }
            };
            templates.push(newTemplate);
            currentTemplate = newTemplate;
            renderList();
            renderEditor();
        }

        function duplicateTemplate() {
            if (!currentTemplate) return;
            const copy = JSON.parse(JSON.stringify(currentTemplate));
            copy.id = Date.now().toString();
            copy.name = currentTemplate.name + ' (å‰¯æœ¬)';
            templates.push(copy);
            currentTemplate = copy;
            renderList();
            renderEditor();
        }

        function deleteTemplate() {
            if (!currentTemplate) return;

            sdk.confirm('åˆ é™¤æ¨¡æ¿', `ç¡®å®šè¦åˆ é™¤æ¨¡æ¿ "${currentTemplate.name}" å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚`, () => {
                performDelete();
            });
        }

        function performDelete() {
            templates = templates.filter(t => t.id !== currentTemplate.id);
            currentTemplate = null;
            renderList();
            renderEditor();
            sdk?.showMessage('æ¨¡æ¿å·²åˆ é™¤', 'info');
            saveAll();
        }

        function saveCurrent() {
            if (currentTemplate) {
                // Ensure textareas are synced (though oninput should cover it)
                const tContent = document.getElementById('templateContent');
                if (tContent) currentTemplate.template = tContent.value;
            }
            saveAll();
        }

        function saveAll() {
            if (!onSaveCallback) {
                console.error("No save callback");
                return;
            }

            onSaveCallback(templates).then(() => {
                sdk?.showMessage('âœ… æ‰€æœ‰æ›´æ”¹å·²ä¿å­˜', 'info');
                renderList(); // Refresh list to update titles
            }).catch(err => {
                sdk?.showMessage('ä¿å­˜å¤±è´¥: ' + err, 'error');
            });
        }

        // --- Import/Export ---

        function importTemplates() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const imported = JSON.parse(event.target.result);
                        if (Array.isArray(imported)) {
                            // Validate/Migrate imported
                            imported.forEach(t => {
                                if (!t.id) t.id = Date.now() + Math.random().toString().slice(2);
                                // Ensure template property key
                                if (t.contentTemplate && !t.template) t.template = t.contentTemplate;
                            });

                            templates.push(...imported);
                            renderList();
                            sdk?.showMessage(`æˆåŠŸå¯¼å…¥ ${imported.length} ä¸ªæ¨¡æ¿`, 'info');
                            saveAll();
                        }
                    } catch (err) {
                        sdk?.showMessage('å¯¼å…¥å¤±è´¥ï¼š' + err.message, 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function exportTemplates() {
            const dataStr = JSON.stringify(templates, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `siyuan-templates-backup.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // --- Utils ---
        function escapeHtml(unsafe) {
            if (unsafe === undefined || unsafe === null) return '';
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function toggleAdvanced(header) {
            const content = header.nextElementSibling;
            const arrow = header.querySelector('#advArrow');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.style.transform = 'rotate(90deg)';
                arrow.textContent = 'â–¼'; // Sync icon state just in case
            } else {
                content.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
                arrow.textContent = 'â–¶';
            }
        }
    </script>
</body>

</html>