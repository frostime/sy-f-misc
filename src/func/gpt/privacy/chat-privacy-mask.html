<!-- filepath: src\func\gpt\privacy\chat-privacy-mask.html -->
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éšç§å±è”½è§„åˆ™é…ç½®</title>
    <style>
        :root {
            /* åŸºç¡€å˜é‡æ˜ å°„ */
            --font-family: var(--font-family, "Helvetica Neue", Helvetica, Arial, sans-serif);
            --code-font: var(--font-family-code, monospace);
            --font-size: var(--font-size, 14px);

            /* é¢œè‰²ç³»ç»Ÿ */
            --bg-base: var(--theme-background, #fff);
            --bg-surface: var(--theme-surface, #f8f9fa);
            --bg-hover: var(--theme-surface-light, #f1f3f5);

            --text-main: var(--theme-on-background, #212529);
            --text-second: var(--theme-on-surface, #868e96);
            --border: var(--theme-surface-lighter, #dee2e6);

            --primary: var(--theme-primary, #228be6);
            --primary-light: var(--theme-primary-light, #e7f5ff);
            --on-primary: var(--theme-on-primary, #fff);

            --danger: #fa5252;
            --success: #40c057;
            --warning: #fab005;

            /* å¸ƒå±€å°ºå¯¸ */
            --radius: 6px;
            --space-sm: 8px;
            --space-md: 16px;
        }

        [data-theme-mode="dark"] {
            --bg-hover: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
        }

        * {
            box-sizing: border-box;
            outline: none;
        }

        body {
            font-family: var(--font-family);
            font-size: var(--font-size);
            background: var(--bg-base);
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Header --- */
        header {
            padding: var(--space-md);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-surface);
            flex-shrink: 0;
        }

        h1 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .toolbar {
            display: flex;
            gap: var(--space-sm);
        }

        /* --- Main Table Area --- */
        main {
            flex: 1;
            overflow: auto;
            padding: var(--space-md);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--font-size);
        }

        .data-table th,
        .data-table td {
            text-align: left;
            padding: 10px;
            border-bottom: 1px solid var(--border);
        }

        .data-table th {
            font-weight: 500;
            color: var(--text-second);
            background: var(--bg-base);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table tr:hover {
            background: var(--bg-hover);
        }

        .data-table tr.disabled {
            opacity: 0.6;
        }

        /* --- Components --- */
        .btn {
            padding: 6px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--bg-base);
            color: var(--text-main);
            cursor: pointer;
            font-size: var(--font-size);
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .btn:hover {
            background: var(--bg-hover);
        }

        .btn-primary {
            background: var(--primary);
            color: var(--on-primary);
            border-color: var(--primary);
        }

        .btn-primary:hover {
            opacity: 0.9;
            background: var(--primary);
        }

        .btn-icon {
            padding: 4px;
            border: none;
            background: transparent;
            color: var(--text-second);
        }

        .btn-icon:hover {
            color: var(--text-main);
            background: var(--bg-hover);
        }

        .btn-icon.delete:hover {
            color: var(--danger);
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600; /* åŠ ç²—ä¸€ç‚¹ */
            background: var(--bg-surface);
            border: 1px solid transparent;
            font-family: var(--code-font); /* ä½¿ç”¨ä»£ç å­—ä½“ */
        }

        /* é»˜è®¤æ ·å¼ï¼ŒJS ä¼šåŠ¨æ€è¦†ç›– */
        .badge-default {
            color: var(--text-second);
            background: var(--bg-surface);
            border-color: var(--border);
        }

        /* Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 32px;
            height: 18px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border);
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--primary);
        }

        input:checked+.slider:before {
            transform: translateX(14px);
        }

        /* --- Footer --- */
        footer {
            padding: var(--space-md);
            border-top: 1px solid var(--border);
            background: var(--bg-surface);
            display: flex;
            justify-content: flex-end;
            gap: var(--space-md);
        }

        /* --- Dialog/Modal --- */
        dialog {
            border: none;
            border-radius: var(--radius);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            padding: 0;
            width: 500px;
            max-width: 90vw;
            background: var(--bg-base);
            color: var(--text-main);
        }

        dialog::backdrop {
            background: rgba(0, 0, 0, 0.4);
        }

        .dialog-header {
            padding: var(--space-md);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dialog-body {
            padding: var(--space-md);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .dialog-footer {
            padding: var(--space-md);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: var(--space-sm);
            background: var(--bg-surface);
        }

        /* Form Controls */
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group label {
            font-size: 12px;
            color: var(--text-second);
            font-weight: 500;
        }

        .form-control {
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--bg-base);
            color: var(--text-main);
            width: 100%;
            font-size: var(--font-size);
        }

        textarea.form-control {
            font-family: var(--code-font);
            min-height: 100px;
            resize: vertical;
        }

        .preset-tags {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }

        .preset-tag {
            font-size: 12px;
            padding: 2px 8px;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            user-select: none;
        }

        .preset-tag:hover {
            background: var(--primary-light);
            color: var(--primary);
            border-color: var(--primary);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-second);
        }

        /* é”™è¯¯æç¤ºæ ·å¼ */
        .input-error {
            border-color: var(--danger);
        }
        .error-msg {
            font-size: 12px;
            color: var(--danger);
            margin-top: 4px;
        }
    </style>
</head>

<body>

    <header>
        <h1>éšç§å±è”½è§„åˆ™</h1>
        <div class="toolbar">
            <button class="btn btn-primary" id="btnAdd">
                <span>ï¼‹</span> æ–°å¢è§„åˆ™
            </button>
        </div>
    </header>

    <main>
        <table class="data-table">
            <thead>
                <tr>
                    <th width="50">å¯ç”¨</th>
                    <th width="100">ç±»å‹</th>
                    <th>æè¿°</th>
                    <th width="100">æ¨¡å¼</th>
                    <th width="80">è§„åˆ™æ•°</th>
                    <th width="80" style="text-align: right;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <!-- Data rendered via JS -->
            </tbody>
        </table>
        <div id="emptyState" class="empty-state" style="display: none;">
            æš‚æ— é…ç½®ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’æ–°å¢
        </div>
    </main>

    <footer>
        <button class="btn" id="btnCancel">å–æ¶ˆ</button>
        <button class="btn btn-primary" id="btnSaveAll">ä¿å­˜æ›´æ”¹</button>
    </footer>

    <!-- Editor Dialog -->
    <dialog id="editorDialog">
        <div class="dialog-header">
            <h3 id="dialogTitle">ç¼–è¾‘è§„åˆ™</h3>
            <button class="btn-icon" id="btnCloseDialog">âœ•</button>
        </div>
        <div class="dialog-body">
            <!-- å¿«é€Ÿé¢„è®¾ -->
            <div class="form-group">
                <label>å¿«é€Ÿé¢„è®¾ (ç‚¹å‡»åº”ç”¨)</label>
                <div class="preset-tags" id="presetTags">
                    <!-- Loaded via JS -->
                </div>
            </div>

            <div class="form-group">
                <label>è§„åˆ™ç±»å‹</label>
                <select id="inputType" class="form-control">
                    <option value="CUSTOM">è‡ªå®šä¹‰</option>
                    <option value="EMAIL">é‚®ç®±</option>
                    <option value="PHONE">ç”µè¯</option>
                    <option value="BANKCARD">é“¶è¡Œå¡</option>
                    <option value="API_KEY">å¯†é’¥</option>
                    <option value="PASSWORD">å¯†ç </option>
                    <option value="ID_CARD">èº«ä»½è¯</option>
                    <option value="ADDRESS">åœ°å€</option>
                    <option value="NAME">å§“å</option>
                </select>
            </div>

            <!-- è‡ªå®šä¹‰ç±»å‹è¾“å…¥æ¡†ï¼Œé»˜è®¤éšè— -->
            <div class="form-group" id="customTypeGroup" style="display: none;">
                <label>è‡ªå®šä¹‰ç±»å‹ä»£ç  (MaskType)</label>
                <input type="text" id="inputCustomType" class="form-control" placeholder="ä¾‹å¦‚ï¼šPROJECT_CODE (å»ºè®®ä½¿ç”¨å¤§å†™å­—æ¯å’Œä¸‹åˆ’çº¿)">
            </div>

            <div class="form-group">
                <label>æè¿°</label>
                <input type="text" id="inputDesc" class="form-control" placeholder="ä¾‹å¦‚ï¼šè¿‡æ»¤å†…éƒ¨æµ‹è¯•è´¦å·">
            </div>

            <div class="form-group">
                <label>åŒ¹é…æ¨¡å¼</label>
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                    <label class="switch" style="width: 28px; height: 16px;">
                        <input type="checkbox" id="inputIsRegex">
                        <span class="slider"></span>
                    </label>
                    <span style="font-size: 12px;">ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼</span>
                </div>
                <textarea id="inputPatterns" class="form-control" placeholder="æ¯è¡Œè¾“å…¥ä¸€ä¸ªåŒ¹é…è§„åˆ™"></textarea>
                <div style="font-size: 12px; color: var(--text-second); margin-top: 4px;">
                    éæ­£åˆ™æ¨¡å¼ä¸‹å°†è¿›è¡Œç²¾ç¡®æ–‡æœ¬åŒ¹é…
                </div>
            </div>
        </div>
        <div class="dialog-footer">
            <button class="btn" id="btnDialogCancel">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="btnDialogConfirm">ç¡®å®š</button>
        </div>
    </dialog>

    <script>
        /**
         * Logic & State Management
         */
        const PRESETS = {
            email: {
                patterns: ['\\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Z|a-z]{2,}\\b'],
                isRegex: true,
                maskType: 'EMAIL',
                description: 'é‚®ç®±'
            },
            phone: {
                patterns: ['1[3-9]\\d{9}'],
                isRegex: true,
                maskType: 'PHONE',
                description: 'æ‰‹æœºå·'
            },
            bankcard: {
                patterns: ['\\b[0-9]{16,19}\\b'],
                isRegex: true,
                maskType: 'BANKCARD',
                description: 'é“¶è¡Œå¡å· (16-19ä½)'
            },
            api_key: {
                patterns: ['sk-[A-Za-z0-9]{48}', 'Bearer\\s+[a-zA-Z0-9_-]+'],
                isRegex: true,
                maskType: 'API_KEY',
                description: 'å¸¸è§ API Token'
            },
            id_card: {
                patterns: ['\\b[1-9]\\d{5}(18|19|20)\\d{2}(0[1-9]|1[0-2])(0[1-9]|[12]\\d|3[01])\\d{3}[0-9Xx]\\b'],
                isRegex: true,
                maskType: 'ID_CARD',
                description: 'èº«ä»½è¯å·'
            }
        };

        const STANDARD_TYPES = ['EMAIL', 'PHONE', 'BANKCARD', 'API_KEY', 'PASSWORD', 'ID_CARD', 'ADDRESS', 'NAME'];

        // State
        let privacyFields = [];
        let editingIndex = -1; // -1 means creating new
        let palette = []; //[[back, front]]

        // DOM Elements
        const tableBody = document.getElementById('tableBody');
        const emptyState = document.getElementById('emptyState');
        const dialog = document.getElementById('editorDialog');

        // Editor Inputs
        const inputs = {
            type: document.getElementById('inputType'),
            customType: document.getElementById('inputCustomType'),
            customTypeGroup: document.getElementById('customTypeGroup'),
            desc: document.getElementById('inputDesc'),
            isRegex: document.getElementById('inputIsRegex'),
            patterns: document.getElementById('inputPatterns')
        };

        // --- Initialization ---

        window.addEventListener('pluginSdkReady', async () => {
            initTheme();

            // åŠ è½½é¢œè‰²é…ç½®
            if (window.pluginSdk?.colors && Array.isArray(window.pluginSdk.colors) && window.pluginSdk.colors.length > 0) {
                palette = window.pluginSdk.colors;
            }

            loadData();
            initPresetsUI();
            bindEvents();
        });

        function initTheme() {
            const theme = window.pluginSdk?.themeMode || 'light';
            document.documentElement.setAttribute('data-theme-mode', theme);
        }

        function bindEvents() {
            // ç±»å‹é€‰æ‹©å˜åŒ–ç›‘å¬
            inputs.type.addEventListener('change', () => {
                toggleCustomTypeInput();
            });
        }

        function toggleCustomTypeInput() {
            if (inputs.type.value === 'CUSTOM') {
                inputs.customTypeGroup.style.display = 'flex';
                // è‡ªåŠ¨èšç„¦
                // setTimeout(() => inputs.customType.focus(), 50);
            } else {
                inputs.customTypeGroup.style.display = 'none';
            }
        }

        async function loadData() {
            let rawData = [];
            // Priority: Custom API -> Generic Config -> Empty
            if (window.pluginSdk?.getPrivacyFields) {
                rawData = window.pluginSdk.getPrivacyFields() || [];
            } else {
                window.pluginSdk?.showMessage?.('æ— æ³•è·å–åˆ°éšç§è§„åˆ™!', 5000, 'error')
            }
            // âš ï¸ Deep clone
            privacyFields = JSON.parse(JSON.stringify(rawData));
            renderTable();
        }

        // --- Color Utils ---

        /**
         * Simple string hash to index
         */
        function getHashCode(str) {
            let hash = 0;
            if (str.length === 0) return hash;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            return Math.abs(hash);
        }

        function getTypeStyle(type) {
            if (!type) return '';
            const index = getHashCode(type) % palette.length;
            const colors = palette[index];

            // ä½¿ç”¨é¢œè‰²ä½œä¸ºæ–‡å­—é¢œè‰²ï¼Œå¹¶ä½¿ç”¨å¸¦é€æ˜åº¦çš„èƒŒæ™¯è‰²
            // Hex color + alpha: 1A = ~10%, 22 = ~13%
            // return `color: ${color}; background-color: ${color}22; border-color: ${color}44;`;
            return `background-color: ${colors[0]}; color: ${colors[1]};`;
        }

        // --- Rendering ---

        function renderTable() {
            tableBody.innerHTML = '';

            if (!privacyFields || privacyFields.length === 0) {
                emptyState.style.display = 'block';
                return;
            }
            emptyState.style.display = 'none';

            privacyFields.forEach((field, index) => {
                const tr = document.createElement('tr');
                if (!field.enabled) tr.classList.add('disabled');

                // åŠ¨æ€è®¡ç®—æ ·å¼
                const badgeStyle = getTypeStyle(field.maskType);

                tr.innerHTML = `
                    <td>
                        <label class="switch">
                            <input type="checkbox" ${field.enabled ? 'checked' : ''} onchange="toggleField(${index})">
                            <span class="slider"></span>
                        </label>
                    </td>
                    <td><span class="badge" style="${badgeStyle}">${escapeHtml(field.maskType)}</span></td>
                    <td>${escapeHtml(field.description || '-')}</td>
                    <td>
                        <span style="font-family: var(--code-font); font-size: 12px; background: var(--bg-surface); padding: 2px 4px; border-radius: 4px;">
                            ${field.isRegex ? 'Regex' : 'Text'}
                        </span>
                    </td>
                    <td>${field.patterns?.length || 0}</td>
                    <td style="text-align: right;">
                        <button class="btn-icon" onclick="openEdit(${index})" title="ç¼–è¾‘">âœï¸</button>
                        <button class="btn-icon delete" onclick="deleteField(${index})" title="åˆ é™¤">ğŸ—‘ï¸</button>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        }

        function initPresetsUI() {
            const container = document.getElementById('presetTags');
            Object.keys(PRESETS).forEach(key => {
                const tag = document.createElement('span');
                tag.className = 'preset-tag';
                tag.textContent = PRESETS[key].description;
                tag.onclick = () => applyPreset(key);
                container.appendChild(tag);
            });
        }

        // --- Actions ---

        window.toggleField = (index) => {
            privacyFields[index].enabled = !privacyFields[index].enabled;
            renderTable();
        };

        window.deleteField = async (index) => {
            const ok = await window.pluginSdk.confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è§„åˆ™å—ï¼Ÿ');
            if (ok === true) {
                privacyFields.splice(index, 1);
                renderTable();
            }
        };

        window.openEdit = (index) => {
            editingIndex = index;
            const field = privacyFields[index];

            // Fill form
            const typeValue = field.maskType;
            // åˆ¤æ–­æ˜¯å¦ä¸ºæ ‡å‡†ç±»å‹ï¼ˆå¿½ç•¥å¤§å°å†™ï¼Œä¸ºäº†ç¨³å¥ï¼‰
            const isStandard = STANDARD_TYPES.includes(typeValue.toLowerCase());

            if (isStandard) {
                inputs.type.value = typeValue.toLowerCase(); // ä¸‹æ‹‰æ¡†çš„ value éƒ½æ˜¯å°å†™
                inputs.customType.value = '';
            } else {
                inputs.type.value = 'CUSTOM';
                inputs.customType.value = typeValue;
            }
            toggleCustomTypeInput();

            inputs.desc.value = field.description || '';
            inputs.isRegex.checked = field.isRegex;
            inputs.patterns.value = (field.patterns || []).join('\n');

            document.getElementById('dialogTitle').textContent = 'ç¼–è¾‘è§„åˆ™';
            dialog.showModal();
        };

        function openCreate() {
            editingIndex = -1;
            // Reset form
            inputs.type.value = 'CUSTOM';
            inputs.customType.value = '';
            toggleCustomTypeInput();

            inputs.desc.value = '';
            inputs.isRegex.checked = false;
            inputs.patterns.value = '';

            document.getElementById('dialogTitle').textContent = 'æ–°å¢è§„åˆ™';
            dialog.showModal();
        }

        function applyPreset(key) {
            const p = PRESETS[key];
            // é¢„è®¾è‚¯å®šæ˜¯æ ‡å‡†ç±»å‹
            inputs.type.value = p.maskType;
            toggleCustomTypeInput();

            inputs.desc.value = p.description;
            inputs.isRegex.checked = p.isRegex;

            // Replace patterns
            const newPatterns = p.patterns.join('\n');
            inputs.patterns.value = newPatterns;
        }

        function saveDialog() {
            // 1. è·å– MaskType
            let finalMaskType = inputs.type.value;
            if (finalMaskType === 'CUSTOM') {
                const customVal = inputs.customType.value.trim();
                if (!customVal) {
                    window.pluginSdk?.showMessage?.('è¯·è¾“å…¥è‡ªå®šä¹‰ç±»å‹ä»£ç ', 'error');
                    inputs.customType.focus();
                    return;
                }
                // ç®€å•çš„æ ¡éªŒï¼šå…è®¸å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿
                if (!/^[a-zA-Z0-9_]+$/.test(customVal)) {
                    window.pluginSdk?.showMessage?.('ç±»å‹ä»£ç ä»…å…è®¸å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿', 'error');
                    return;
                }
                finalMaskType = customVal;
            }

            // 2. è·å– Patterns
            const rawPatterns = inputs.patterns.value.split('\n').map(s => s.trim()).filter(s => s);

            if (rawPatterns.length === 0) {
                window.pluginSdk?.showMessage?.('è¯·è‡³å°‘è¾“å…¥ä¸€ä¸ªåŒ¹é…è§„åˆ™', 'error');
                return;
            }

            // 3. æ ¡éªŒ Regex
            if (inputs.isRegex.checked) {
                for (let p of rawPatterns) {
                    try { new RegExp(p); } catch (e) {
                        window.pluginSdk?.showMessage?.(`æ— æ•ˆçš„æ­£åˆ™è¡¨è¾¾å¼: ${p}`, 'error');
                        return;
                    }
                }
            }

            const newData = {
                maskType: finalMaskType,
                description: inputs.desc.value,
                isRegex: inputs.isRegex.checked,
                patterns: rawPatterns,
                enabled: true
            };

            if (editingIndex >= 0) {
                // Keep enabled state if editing
                newData.enabled = privacyFields[editingIndex].enabled;
                privacyFields[editingIndex] = newData;
            } else {
                privacyFields.push(newData);
            }

            dialog.close();
            renderTable();
        }

        // --- Persistence ---

        document.getElementById('btnAdd').onclick = openCreate;
        document.getElementById('btnCloseDialog').onclick = () => dialog.close();
        document.getElementById('btnDialogCancel').onclick = () => dialog.close();
        document.getElementById('btnDialogConfirm').onclick = saveDialog;

        document.getElementById('btnCancel').onclick = () => {
            window.pluginSdk?.close ? window.pluginSdk.close() : window.close();
        };

        document.getElementById('btnSaveAll').onclick = async () => {
            try {
                if (window.pluginSdk?.savePrivacyFields) {
                    await window.pluginSdk.savePrivacyFields(privacyFields);
                } else if (window.pluginSdk?.saveConfig) {
                    await window.pluginSdk.saveConfig({ privacyFields });
                }
                window.pluginSdk?.showMessage?.('é…ç½®å·²ä¿å­˜', 'info');
                // Optional: Close after save
                // window.pluginSdk?.close?.();
            } catch (e) {
                window.pluginSdk?.showMessage?.('ä¿å­˜å¤±è´¥', 'error');
                console.error(e);
            }
        };

        // Utils
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Close dialog when clicking backdrop
        dialog.addEventListener('click', (e) => {
            if (e.target === dialog) dialog.close();
        });
    </script>
</body>

</html>
