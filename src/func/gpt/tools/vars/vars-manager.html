<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Variables Manager</title>
    <style>
        [x-cloak] { display: none !important; }

        /* ===== CSS ÂèòÈáèÂÆö‰πâ ===== */
        :root {
            --font-size-normal: 15px;
            --font-size-large: calc(var(--font-size-normal) * 1.15);
            --font-size-medium: calc(var(--font-size-normal) * 0.93);
            --font-size-small: calc(var(--font-size-normal) * 0.86);

            --bg-primary: var(--theme-background, #ffffff);
            --bg-secondary: var(--theme-surface, #f5f5f5);
            --bg-hover: var(--theme-surface-light, #f0f0f0);
            --bg-selected: var(--theme-primary-lightest, #ffe8e6);

            --text-primary: var(--theme-on-background, #333333);
            --text-secondary: var(--theme-on-surface-light, #666666);

            --border-color: var(--theme-surface-lighter, #e0e0e0);
            --accent-color: var(--theme-primary, #d23f31);

            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;

            --radius-sm: 4px;
            --radius-md: 8px;
        }

        /* ===== ÂÖ®Â±ÄÊ†∑Âºè ===== */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-family, sans-serif);
            font-size: var(--font-size-normal);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        #app {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* ===== Â§¥ÈÉ®Â∑•ÂÖ∑Ê†è ===== */
        .toolbar {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .stats {
            display: flex;
            gap: var(--spacing-md);
            font-size: var(--font-size-small);
            color: var(--text-secondary);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .stat-label { font-weight: 500; }
        .stat-value { color: var(--accent-color); font-weight: 600; }

        .toolbar-spacer { flex: 1; }

        .search-box {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .search-input {
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-size: var(--font-size-normal);
            min-width: 200px;
        }

        .filter-select {
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-size: var(--font-size-normal);
        }

        .btn {
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-size: var(--font-size-normal);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn:hover { background-color: var(--bg-hover); }

        .btn-danger {
            background-color: #ea4335;
            color: white;
            border-color: #ea4335;
        }

        .btn-danger:hover { background-color: #c5221f; }

        /* ===== ‰∏ª‰ΩìÂå∫Âüü ===== */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .table-container {
            flex: 1;
            overflow-y: auto;
            border-right: 1px solid var(--border-color);
        }

        table { width: 100%; border-collapse: collapse; }

        thead {
            position: sticky;
            top: 0;
            background-color: var(--bg-secondary);
            z-index: 1;
        }

        th {
            text-align: left;
            padding: var(--spacing-md);
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
            font-size: var(--font-size-medium);
        }

        td {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            font-size: var(--font-size-normal);
        }

        tbody tr {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        tbody tr:hover { background-color: var(--bg-hover); }
        tbody tr.selected { background-color: var(--bg-selected); }

        .type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-small);
            font-weight: 500;
        }

        .type-rule { background-color: #4caf50; color: white; }
        .type-toolcache { background-color: #2196f3; color: white; }
        .type-msgcache { background-color: #ff9800; color: white; }
        .type-llmadd { background-color: #9c27b0; color: white; }

        .keep-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-small);
            background-color: #ffc107;
            color: #333;
            font-weight: 600;
        }

        .tag-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-small);
            background-color: #607d8b;
            color: white;
            font-weight: 500;
            margin-right: 4px;
        }

        .tags-input-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-xs);
            padding: var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background-color: var(--bg-primary);
            min-height: 40px;
        }

        .tag-item {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background-color: #607d8b;
            color: white;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-small);
        }

        .tag-remove {
            cursor: pointer;
            font-weight: bold;
            opacity: 0.7;
        }

        .tag-remove:hover { opacity: 1; }

        .tag-input {
            flex: 1;
            min-width: 100px;
            border: none;
            outline: none;
            background: transparent;
            font-size: var(--font-size-normal);
            color: var(--text-primary);
        }

        /* ===== ËØ¶ÊÉÖÈù¢Êùø ===== */
        .detail-panel {
            width: 650px;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-secondary);
            overflow: hidden;
        }

        .detail-header {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .detail-title {
            font-size: var(--font-size-large);
            font-weight: 600;
            max-width: 500px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: var(--spacing-xs);
            line-height: 1;
        }

        .close-btn:hover { color: var(--text-primary); }

        .detail-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-md);
        }

        .detail-section { margin-bottom: var(--spacing-lg); }
        .detail-section:last-child { margin-bottom: 0; }

        .detail-label {
            font-size: var(--font-size-small);
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xs);
            font-weight: 500;
        }

        .detail-input,
        .detail-textarea {
            width: 100%;
            padding: var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-family: inherit;
            font-size: var(--font-size-normal);
        }

        .detail-textarea {
            font-family: var(--font-family-code, monospace);
            resize: vertical;
            line-height: 1.5;
        }

        .content-textarea { min-height: 400px; }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
            background-color: var(--bg-primary);
            border-radius: var(--radius-sm);
        }

        .checkbox-wrapper input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .detail-actions {
            padding: var(--spacing-md);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: var(--spacing-sm);
            justify-content: flex-end;
        }

        .content-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-sm);
            background-color: var(--bg-primary);
            border-radius: var(--radius-sm);
            margin-bottom: var(--spacing-sm);
            font-size: var(--font-size-small);
            color: var(--text-secondary);
        }

        .content-stats {
            display: flex;
            gap: var(--spacing-md);
        }

        .content-stat {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: var(--spacing-md);
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            font-size: var(--font-size-large);
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div id="app" x-data="varsManager()" x-init="init()" x-cloak>

        <!-- Loading -->
        <template x-if="!_initialized">
            <div class="loading">Loading...</div>
        </template>

        <!-- Main UI -->
        <template x-if="_initialized">
            <div style="display:flex;flex-direction:column;height:100%;">
                <!-- Â∑•ÂÖ∑Ê†è -->
                <div class="toolbar">
                    <div class="stats">
                        <div class="stat-item">
                            <span class="stat-label">ÊÄªËÆ°:</span>
                            <span class="stat-value" x-text="stats.total"></span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">RULE:</span>
                            <span class="stat-value" x-text="stats.byType.RULE || 0"></span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Cache:</span>
                            <span class="stat-value" x-text="stats.byType.ToolCallCache || 0"></span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">LLM:</span>
                            <span class="stat-value" x-text="stats.byType.LLMAdd || 0"></span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">‰øùÊä§:</span>
                            <span class="stat-value" x-text="stats.keepCount"></span>
                        </div>
                    </div>
                    <div class="toolbar-spacer"></div>
                    <div class="search-box">
                        <input type="text" class="search-input" placeholder="ÊêúÁ¥¢ÂèòÈáè..."
                            x-model="searchQuery" @input="applyFilters()">
                        <select class="filter-select" x-model="currentFilter" @change="applyFilters()">
                            <option value="ALL">ÂÖ®ÈÉ®Á±ªÂûã</option>
                            <template x-for="type in varTypes" :key="type">
                                <option :value="type" x-text="type"></option>
                            </template>
                        </select>
                        <button class="btn" @click="handleAddVariable()">‚û• Ê∑ªÂä†</button>
                        <button class="btn" @click="handleRefresh()">üîÑ Âà∑Êñ∞</button>
                        <button class="btn btn-danger" @click="handleClearAll()">üóëÔ∏è Ê∏ÖÁ©∫</button>
                    </div>
                </div>

                <!-- ‰∏ª‰Ωì -->
                <div class="main-content">
                    <!-- Ë°®Ê†º -->
                    <div class="table-container">
                        <!-- Á©∫Áä∂ÊÄÅ -->
                        <div x-show="filteredVariables.length === 0" class="empty-state">
                            <div class="empty-icon">üì≠</div>
                            <div>Ê≤°ÊúâÊâæÂà∞ÂèòÈáè</div>
                        </div>

                        <table x-show="filteredVariables.length > 0">
                            <thead>
                                <tr>
                                    <th style="width: 35%">ÂèòÈáèÂêç</th>
                                    <th style="width: 20%">Á±ªÂûã</th>
                                    <th style="width: 15%">ÂºïÁî®</th>
                                    <th style="width: 20%">ÂàõÂª∫Êó∂Èó¥</th>
                                    <th style="width: 10%">Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="v in filteredVariables" :key="v.name">
                                    <tr :class="{ 'selected': selectedVariable?.name === v.name }"
                                        @click="handleSelectVariable(v.name)">
                                        <td>
                                            <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                                <div x-text="v.name"></div>
                                                <span x-show="v.keep" class="keep-badge">üîí</span>
                                                <template x-for="tag in (v.tags || [])" :key="tag">
                                                    <span class="tag-badge" x-text="tag"></span>
                                                </template>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="type-badge"
                                                :class="'type-' + v.type.toLowerCase().replace('toolcallcache', 'toolcache').replace('messagecache', 'msgcache')"
                                                x-text="v.type"></span>
                                        </td>
                                        <td x-text="v.referenceCount"></td>
                                        <td x-text="formatDate(v.created)"></td>
                                        <td>
                                            <button class="btn" @click.stop="handleCopyRef(v.name)"
                                                style="font-size: 12px; padding: 4px 8px;">üìã</button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>

                    <!-- ËØ¶ÊÉÖÈù¢ÊùøÔºöÁºñËæëÁé∞ÊúâÂèòÈáè -->
                    <div class="detail-panel" x-show="selectedVariable && !isAddingVariable">
                        <template x-if="selectedVariable && !isAddingVariable">
                            <div style="display:flex;flex-direction:column;height:100%;">
                                <div class="detail-header">
                                    <div class="detail-title" x-text="selectedVariable.name"></div>
                                    <button class="close-btn" @click="handleCloseDetail()">‚úï</button>
                                </div>
                                <div class="detail-content">
                                    <div class="detail-section">
                                        <div class="detail-label">Á±ªÂûã</div>
                                        <select class="detail-input" x-model="editForm.type">
                                            <template x-for="type in varTypes" :key="type">
                                                <option :value="type" x-text="type"></option>
                                            </template>
                                        </select>
                                    </div>
                                    <div class="detail-section">
                                        <div class="detail-label">ÊèèËø∞</div>
                                        <input type="text" class="detail-input" x-model="editForm.desc"
                                            placeholder="Ê∑ªÂä†ÊèèËø∞...">
                                    </div>
                                    <div class="detail-section">
                                        <div class="detail-label">Ê†áÁ≠æ (Tags)</div>
                                        <div class="tags-input-wrapper">
                                            <template x-for="(tag, idx) in editForm.tags" :key="idx">
                                                <div class="tag-item">
                                                    <span x-text="tag"></span>
                                                    <span class="tag-remove" @click="editForm.tags.splice(idx, 1)">‚úï</span>
                                                </div>
                                            </template>
                                            <input type="text" class="tag-input" placeholder="ËæìÂÖ•Ê†áÁ≠æÂêéÊåâÂõûËΩ¶..."
                                                x-ref="tagInput"
                                                @keydown.enter.prevent="addTag(editForm.tags, $refs.tagInput)">
                                        </div>
                                    </div>
                                    <div class="detail-section">
                                        <div class="checkbox-wrapper">
                                            <input type="checkbox" id="keepCheckbox" x-model="editForm.keep">
                                            <label for="keepCheckbox">üîí ‰øùÊä§Ê≠§ÂèòÈáèÔºàÈò≤Ê≠¢Ë¢´Ëá™Âä®Ê∏ÖÁêÜÔºâ</label>
                                        </div>
                                    </div>
                                    <div class="detail-section">
                                        <div class="detail-label">ÂÆåÊï¥ÂÜÖÂÆπ</div>
                                        <div class="content-info">
                                            <div class="content-stats">
                                                <div class="content-stat">
                                                    <span>üìè</span>
                                                    <span x-text="editForm.value.length.toLocaleString() + ' Â≠óÁ¨¶'"></span>
                                                </div>
                                                <div class="content-stat">
                                                    <span>üìÑ</span>
                                                    <span x-text="editForm.value.split('\\n').length.toLocaleString() + ' Ë°å'"></span>
                                                </div>
                                                <div class="content-stat">
                                                    <span>üîó</span>
                                                    <span x-text="selectedVariable.referenceCount + ' Ê¨°ÂºïÁî®'"></span>
                                                </div>
                                            </div>
                                            <div>
                                                <button class="btn" @click="handleCopyContent()"
                                                    style="font-size: 11px; padding: 2px 8px;">üìã Â§çÂà∂ÂÜÖÂÆπ</button>
                                            </div>
                                        </div>
                                        <textarea class="detail-textarea content-textarea"
                                            x-model="editForm.value"></textarea>
                                    </div>
                                </div>
                                <div class="detail-actions">
                                    <button class="btn btn-danger" @click="handleDelete()">üóëÔ∏è Âà†Èô§</button>
                                    <button class="btn" @click="handleCloseDetail()">ÂèñÊ∂à</button>
                                    <button class="btn" @click="handleSave()">üíæ ‰øùÂ≠ò</button>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- ËØ¶ÊÉÖÈù¢ÊùøÔºöÊ∑ªÂä†Êñ∞ÂèòÈáè -->
                    <div class="detail-panel" x-show="isAddingVariable">
                        <template x-if="isAddingVariable">
                            <div style="display:flex;flex-direction:column;height:100%;">
                                <div class="detail-header">
                                    <div class="detail-title">Ê∑ªÂä†Êñ∞ÂèòÈáè</div>
                                    <button class="close-btn" @click="handleCancelAdd()">‚úï</button>
                                </div>
                                <div class="detail-content">
                                    <div class="detail-section">
                                        <div class="detail-label">ÂèòÈáèÂêç *</div>
                                        <input type="text" class="detail-input" x-model="newVarData.name"
                                            placeholder="ËæìÂÖ•ÂèòÈáèÂêç...">
                                    </div>
                                    <div class="detail-section">
                                        <div class="detail-label">Á±ªÂûã *</div>
                                        <select class="detail-input" x-model="newVarData.type">
                                            <template x-for="type in varTypes" :key="type">
                                                <option :value="type" x-text="type"></option>
                                            </template>
                                        </select>
                                    </div>
                                    <div class="detail-section">
                                        <div class="detail-label">ÊèèËø∞</div>
                                        <input type="text" class="detail-input" x-model="newVarData.desc"
                                            placeholder="Ê∑ªÂä†ÊèèËø∞...">
                                    </div>
                                    <div class="detail-section">
                                        <div class="detail-label">Ê†áÁ≠æ (Tags)</div>
                                        <div class="tags-input-wrapper">
                                            <template x-for="(tag, idx) in newVarData.tags" :key="idx">
                                                <div class="tag-item">
                                                    <span x-text="tag"></span>
                                                    <span class="tag-remove" @click="newVarData.tags.splice(idx, 1)">‚úï</span>
                                                </div>
                                            </template>
                                            <input type="text" class="tag-input" placeholder="ËæìÂÖ•Ê†áÁ≠æÂêéÊåâÂõûËΩ¶..."
                                                x-ref="newTagInput"
                                                @keydown.enter.prevent="addTag(newVarData.tags, $refs.newTagInput)">
                                        </div>
                                    </div>
                                    <div class="detail-section">
                                        <div class="detail-label">ÂÜÖÂÆπ *</div>
                                        <textarea class="detail-textarea content-textarea"
                                            x-model="newVarData.value" placeholder="ËæìÂÖ•ÂèòÈáèÂÜÖÂÆπ..."></textarea>
                                    </div>
                                </div>
                                <div class="detail-actions">
                                    <button class="btn" @click="handleCancelAdd()">ÂèñÊ∂à</button>
                                    <button class="btn" @click="handleConfirmAdd()">‚úì Ê∑ªÂä†</button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <script src="/plugins/sy-f-misc/scripts/alpine.min.js" defer></script>
    <script>
        function varsManager() {
            return {
                _initialized: false,

                // Data
                variables: [],
                filteredVariables: [],
                selectedVariable: null,
                stats: null,
                varTypes: [],

                // Filters
                currentFilter: 'ALL',
                searchQuery: '',

                // Edit form (populated when selecting a variable)
                editForm: { type: '', desc: '', value: '', keep: false, tags: [] },

                // Add new variable
                isAddingVariable: false,
                newVarData: { name: '', type: 'USER_ADD', value: '', desc: '', tags: [] },

                // ===== Init =====
                async init() {
                    await new Promise(r => {
                        if (window.pluginSdk) return r();
                        window.addEventListener('pluginSdkReady', r, { once: true });
                    });

                    document.documentElement.setAttribute('data-theme-mode',
                        window.pluginSdk.themeMode || 'light');

                    await this.loadData();
                    this._initialized = true;
                },

                // ===== Data =====
                async loadData() {
                    try {
                        this.variables = await window.pluginSdk.listVariables();
                        this.stats = await window.pluginSdk.getStats();

                        if (!this.varTypes || this.varTypes.length === 0) {
                            this.varTypes = window.pluginSdk.getVarTypes();
                        }

                        this.applyFilters();
                    } catch (error) {
                        console.error('Failed to load data:', error);
                        window.pluginSdk.showMessage('Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•: ' + error.message, 'error');
                    }
                },

                applyFilters() {
                    let filtered = this.variables;

                    if (this.currentFilter !== 'ALL') {
                        filtered = filtered.filter(v => v.type === this.currentFilter);
                    }

                    if (this.searchQuery) {
                        const query = this.searchQuery.toLowerCase();
                        filtered = filtered.filter(v =>
                            v.name.toLowerCase().includes(query) ||
                            v.desc?.toLowerCase().includes(query)
                        );
                    }

                    this.filteredVariables = filtered;
                },

                // ===== Tag helper =====
                addTag(tagsArray, inputEl) {
                    const tag = inputEl.value.trim();
                    if (tag && !tagsArray.includes(tag)) {
                        tagsArray.push(tag);
                    }
                    inputEl.value = '';
                },

                // ===== Event handlers =====
                async handleSelectVariable(name) {
                    try {
                        const result = await window.pluginSdk.getVariable(name);
                        if (result.ok) {
                            this.selectedVariable = result.data;
                            this.isAddingVariable = false;
                            // Populate edit form
                            this.editForm = {
                                type: result.data.type,
                                desc: result.data.desc || '',
                                value: result.data.value,
                                keep: result.data.keep || false,
                                tags: [...(result.data.tags || [])],
                            };
                        } else {
                            window.pluginSdk.showMessage('Âä†ËΩΩÂèòÈáèÂ§±Ë¥•: ' + result.error, 'error');
                        }
                    } catch (error) {
                        console.error('Failed to select variable:', error);
                        window.pluginSdk.showMessage('Âä†ËΩΩÂèòÈáèÂ§±Ë¥•: ' + error.message, 'error');
                    }
                },

                handleCloseDetail() {
                    this.selectedVariable = null;
                    this.isAddingVariable = false;
                },

                handleAddVariable() {
                    this.isAddingVariable = true;
                    this.selectedVariable = null;
                    this.newVarData = { name: '', type: 'USER_ADD', value: '', desc: '', tags: [] };
                },

                handleCancelAdd() {
                    this.isAddingVariable = false;
                    this.newVarData = { name: '', type: 'USER_ADD', value: '', desc: '', tags: [] };
                },

                async handleConfirmAdd() {
                    try {
                        const { name, type, desc, value, tags } = this.newVarData;

                        if (!name.trim()) {
                            window.pluginSdk.showMessage('ËØ∑ËæìÂÖ•ÂèòÈáèÂêç', 'error');
                            return;
                        }
                        if (!value) {
                            window.pluginSdk.showMessage('ËØ∑ËæìÂÖ•ÂèòÈáèÂÜÖÂÆπ', 'error');
                            return;
                        }

                        const result = await window.pluginSdk.addVariable(
                            name.trim(), value, type, desc.trim() || undefined,
                            Alpine.raw(tags)
                        );
                        if (result.ok) {
                            window.pluginSdk.showMessage('Ê∑ªÂä†ÊàêÂäü', 'info');
                            this.isAddingVariable = false;
                            this.newVarData = { name: '', type: 'USER_ADD', value: '', desc: '', tags: [] };
                            await this.loadData();
                        } else {
                            window.pluginSdk.showMessage('Ê∑ªÂä†Â§±Ë¥•: ' + result.error, 'error');
                        }
                    } catch (error) {
                        console.error('Failed to add variable:', error);
                        window.pluginSdk.showMessage('Ê∑ªÂä†Â§±Ë¥•: ' + error.message, 'error');
                    }
                },

                async handleSave() {
                    try {
                        const updates = {};
                        const sv = this.selectedVariable;
                        const ef = this.editForm;

                        if (ef.type !== sv.type) updates.type = ef.type;
                        if (ef.desc !== (sv.desc || '')) updates.desc = ef.desc;
                        if (ef.value !== sv.value) updates.value = ef.value;
                        if (ef.keep !== (sv.keep || false)) updates.keep = ef.keep;
                        if (JSON.stringify(Alpine.raw(ef.tags)) !== JSON.stringify(sv.tags || [])) {
                            updates.tags = Alpine.raw(ef.tags);
                        }

                        if (Object.keys(updates).length === 0) {
                            window.pluginSdk.showMessage('Ê≤°Êúâ‰øÆÊîπ', 'info');
                            return;
                        }

                        const result = await window.pluginSdk.updateVariable(sv.name, updates);
                        if (result.ok) {
                            window.pluginSdk.showMessage('‰øùÂ≠òÊàêÂäü', 'info');
                            await this.loadData();
                            await this.handleSelectVariable(sv.name);
                        } else {
                            window.pluginSdk.showMessage('‰øùÂ≠òÂ§±Ë¥•: ' + result.error, 'error');
                        }
                    } catch (error) {
                        console.error('Failed to save:', error);
                        window.pluginSdk.showMessage('‰øùÂ≠òÂ§±Ë¥•: ' + error.message, 'error');
                    }
                },

                async handleDelete() {
                    window.pluginSdk.confirm('Á°ÆËÆ§Âà†Èô§',
                        `Á°ÆÂÆöË¶ÅÂà†Èô§ÂèòÈáè "${this.selectedVariable.name}" ÂêóÔºü`,
                        async () => {
                            try {
                                const result = await window.pluginSdk.deleteVariable(this.selectedVariable.name);
                                if (result.ok) {
                                    window.pluginSdk.showMessage('Âà†Èô§ÊàêÂäü', 'info');
                                    this.selectedVariable = null;
                                    await this.loadData();
                                } else {
                                    window.pluginSdk.showMessage('Âà†Èô§Â§±Ë¥•: ' + result.error, 'error');
                                }
                            } catch (error) {
                                console.error('Failed to delete:', error);
                                window.pluginSdk.showMessage('Âà†Èô§Â§±Ë¥•: ' + error.message, 'error');
                            }
                        }
                    );
                },

                async handleRefresh() {
                    await this.loadData();
                    window.pluginSdk.showMessage('Âà∑Êñ∞ÊàêÂäü', 'info');
                },

                async handleClearAll() {
                    const type = this.currentFilter === 'ALL' ? 'ALL' : this.currentFilter;
                    const typeText = type === 'ALL' ? 'ÊâÄÊúâÈùû‰øùÊä§ÂèòÈáè' : `Á±ªÂûã‰∏∫ ${type} ÁöÑÈùû‰øùÊä§ÂèòÈáè`;

                    window.pluginSdk.confirm('Á°ÆËÆ§Ê∏ÖÁ©∫', `Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫${typeText}ÂêóÔºü`, async () => {
                        try {
                            const result = await window.pluginSdk.clearByType(type);
                            if (result.ok) {
                                window.pluginSdk.showMessage(`Â∑≤Ê∏ÖÁ©∫ ${result.removed} ‰∏™ÂèòÈáè`, 'info');
                                this.selectedVariable = null;
                                await this.loadData();
                            } else {
                                window.pluginSdk.showMessage('Ê∏ÖÁ©∫Â§±Ë¥•: ' + result.error, 'error');
                            }
                        } catch (error) {
                            console.error('Failed to clear:', error);
                            window.pluginSdk.showMessage('Ê∏ÖÁ©∫Â§±Ë¥•: ' + error.message, 'error');
                        }
                    });
                },

                handleCopyRef(name) {
                    const ref = `$VAR_REF{{${name}}}`;
                    navigator.clipboard.writeText(ref).then(() => {
                        window.pluginSdk.showMessage('Â∑≤Â§çÂà∂ÂºïÁî®: ' + ref, 'info', 2000);
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                        window.pluginSdk.showMessage('Â§çÂà∂Â§±Ë¥•', 'error');
                    });
                },

                handleCopyContent() {
                    navigator.clipboard.writeText(this.editForm.value).then(() => {
                        window.pluginSdk.showMessage('Â∑≤Â§çÂà∂ÂÜÖÂÆπ', 'info', 2000);
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                        window.pluginSdk.showMessage('Â§çÂà∂Â§±Ë¥•', 'error');
                    });
                },

                // ===== Utils =====
                formatDate(isoString) {
                    const date = new Date(isoString);
                    return date.toLocaleString('zh-CN', {
                        year: 'numeric', month: '2-digit', day: '2-digit',
                        hour: '2-digit', minute: '2-digit'
                    });
                },
            };
        }
    </script>
</body>
</html>

