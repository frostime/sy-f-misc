<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>手动工具调用</title>
    <link rel="stylesheet" href="../styles/hspa-mini.css">
    <style>
        /* ==================== 视图特有样式 (无法被 hspa-mini 覆盖的部分) ==================== */
        :root {
            /* 工具组专用颜色 - 保持原有的特定语义驱动样式 */
            --group-header-bg: var(--theme-surface, #f0f0f2);
            --group-header-hover: var(--theme-surface-light, #e8e8ea);
            --group-border: var(--theme-surface-lighter, #d8d8dc);
            --tool-item-active-bg: var(--theme-primary-lightest, #fff0ee);
            --tool-item-active-border: var(--theme-primary, #d23f31);
        }

        [data-theme-mode="dark"] {
            --group-header-bg: #2d2d30;
            --group-header-hover: #383838;
            --group-border: #404045;
            --tool-item-active-bg: #3d2522;
        }

        /* 侧边栏样式 */
        #sidebar {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-color: var(--c-surface);
        }

        .sidebar-toolbar {
            border-bottom: 1px solid var(--c-border);
            flex-shrink: 0;
            background-color: var(--c-bg);
        }

        /* 分割条封装 */
        .resizer-h {
            width: 4px;
            background-color: var(--c-border);
            cursor: ew-resize;
            position: relative;
            flex-shrink: 0;
            transition: background-color 0.2s;
        }

        .resizer-h:hover {
            background-color: var(--c-accent);
        }

        .resizer-h::before {
            content: '';
            position: absolute;
            left: -4px;
            top: 0;
            bottom: 0;
            width: 12px;
        }

        .resizer-v {
            height: 4px;
            background-color: var(--c-border);
            cursor: ns-resize;
            position: relative;
            flex-shrink: 0;
            transition: background-color 0.2s;
        }

        .resizer-v:hover {
            background-color: var(--c-accent);
        }

        .resizer-v::before {
            content: '';
            position: absolute;
            top: -4px;
            left: 0;
            right: 0;
            height: 12px;
        }

        /* 工具列表项交互 */
        .tool-group {
            margin-bottom: var(--sp-2);
            border-radius: var(--radius);
            overflow: hidden;
            border: 1px solid var(--group-border);
            background-color: var(--c-bg);
        }

        .group-header {
            padding: var(--sp-2) var(--sp-3);
            font-weight: 600;
            background-color: var(--group-header-bg);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: var(--sp-2);
        }

        .group-header:hover {
            background-color: var(--group-header-hover);
        }

        .group-header-icon {
            transition: transform 0.2s ease;
        }

        .group-header.collapsed .group-header-icon {
            transform: rotate(-90deg);
        }

        .tool-item {
            padding: var(--sp-2) var(--sp-3);
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: all 0.15s ease;
            border-bottom: 1px solid var(--group-border);
        }

        .tool-item:last-child {
            border-bottom: none;
        }

        .tool-item:hover {
            background-color: var(--c-surface-hover);
        }

        .tool-item.active {
            background-color: var(--tool-item-active-bg);
            border-left-color: var(--tool-item-active-border);
        }

        .tool-item.active .tool-name::before {
            opacity: 1;
        }

        .tool-name {
            font-weight: 500;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tool-name::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: var(--c-accent);
            opacity: 0.6;
        }

        /* 让结果代码块填满剩余空间 */
        .result-content-wrapper {
            display: flex;
            flex-direction: column;
            height: 100%;
            gap: var(--sp-2);
            overflow: hidden; /* 防止溢出导致出现双滚动条 */
        }

        /* 覆盖 hspa-mini.css 的 max-height，确保代码块填满 */
        .result-content-wrapper .code-block {
            flex: 1;
            max-height: none;
            margin: 0;
            overflow: auto; /* 这里代码块自己负责滚动 */
        }

        /* 修复 hspa-mini.css 默认 fill 导致描边图标变色块的问题 */
        .icon {
            fill: none !important;
            stroke: currentColor;
        }

        /* 确保 page-body 在此处作为容器能让子元素填满 */
        #result-panel .page-body {
            display: flex;
            flex-direction: column;
            overflow: hidden; /* 内部滚动由 code-block 负责 */
        }
    </style>
    <script defer src="../scripts/alpine.min.js"></script>
</head>

<body class="page" x-data="manualExecute" @mousemove.window="doResize($event)" @mouseup.window="stopResize()">
    <div id="app" class="flex h-screen w-full overflow-hidden">
        <!-- 侧边栏：工具组/工具列表 -->
        <aside id="sidebar" :style="{ width: sidebarWidth + 'px' }">
            <div class="sidebar-toolbar flex-between p-3">
                <span class="text-bold">工具列表</span>
                <div class="flex gap-1">
                    <button class="btn btn-sm" @click="expandAll()" title="全部展开">
                        <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <polyline points="6 9 12 15 18 9" />
                        </svg>
                    </button>
                    <button class="btn btn-sm" @click="collapseAll()" title="全部折叠">
                        <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <polyline points="18 15 12 9 6 15" />
                        </svg>
                    </button>
                </div>
            </div>
            <div id="tool-groups-container" class="flex-1 scroll-y p-2">
                <template x-for="group in toolGroups" :key="group.name">
                    <div class="tool-group">
                        <div class="group-header" :class="{ collapsed: collapsedGroups.has(group.name) }"
                            @click="toggleGroup(group.name)">
                            <span class="group-header-icon flex-center">
                                <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <polyline points="6 9 12 15 18 9" />
                                </svg>
                            </span>
                            <span class="flex-1 text-sm" x-text="group.name"></span>
                            <span class="badge" x-text="group.tools.length"></span>
                        </div>
                        <div x-show="!collapsedGroups.has(group.name)" x-collapse>
                            <template x-for="tool in group.tools" :key="tool.name">
                                <div class="tool-item" :class="{ active: currentTool?.function.name === tool.name }"
                                    @click="selectTool(tool.name)">
                                    <div class="tool-name text-sm" x-text="tool.name"></div>
                                    <div class="text-xs text-muted text-truncate" style="padding-left: var(--sp-3);"
                                        x-text="tool.description || '无描述'"></div>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
        </aside>

        <!-- 水平拖动分割条 -->
        <div class="resizer-h" @mousedown="startResize('horizontal', $event)" @dblclick="handleDblClick('sidebar')">
        </div>

        <!-- 主内容区 -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <!-- 参数输入面板 -->
            <section id="input-panel" class="scroll-y p-4 bg-bg"
                :style="{ height: inputPanelHeight === 'auto' ? 'auto' : inputPanelHeight + 'px' }">
                <template x-if="!currentTool">
                    <div class="empty-state">
                        <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                        <div class="text-muted">请从左侧选择一个工具</div>
                    </div>
                </template>
                <template x-if="currentTool">
                    <div>
                        <div class="flex-between mb-4 items-start">
                            <div class="flex-1">
                                <h2 class="text-lg text-bold" style="margin-bottom: var(--sp-1);" x-text="currentTool.function.name"></h2>
                                <p class="text-sm text-muted" x-text="currentTool.function.description || '无描述'"></p>
                            </div>
                            <div class="flex gap-2" style="margin-left: var(--sp-4);">
                                <button type="button" class="btn btn-primary" @click="execute()" :disabled="loading">
                                    <svg x-show="!loading" class="icon" viewBox="0 0 24 24" fill="none"
                                        stroke="currentColor" stroke-width="2">
                                        <polygon points="5 3 19 12 5 21 5 3" />
                                    </svg>
                                    <span x-text="loading ? '执行中...' : '执行'"></span>
                                </button>
                                <button type="button" class="btn" @click="resetForm()">重置</button>
                            </div>
                        </div>
                        <form id="param-form" class="flex flex-col gap-4" @submit.prevent="execute()">
                            <template x-for="(schema, name) in (currentTool.function.parameters.properties || {})"
                                :key="name">
                                <div class="form-group border-b" style="padding-bottom: var(--sp-3);">
                                    <label class="form-label flex items-center gap-1">
                                        <span x-text="name"></span>
                                        <template x-if="currentTool.function.parameters.required?.includes(name)">
                                            <span class="text-error">*</span>
                                        </template>
                                    </label>

                                    <template x-if="schema.type === 'string' && schema.enum">
                                        <select class="select" x-model="formArgs[name]">
                                            <option value="">请选择...</option>
                                            <template x-for="val in schema.enum" :key="val">
                                                <option :value="val" x-text="val"></option>
                                            </template>
                                        </select>
                                    </template>

                                    <template x-if="schema.type === 'string' && !schema.enum">
                                        <div class="flex gap-2 items-start">
                                            <template x-if="!multilineFields.has(name)">
                                                <input class="input flex-1" type="text" x-model="formArgs[name]"
                                                    :placeholder="schema.description || ''" />
                                            </template>
                                            <template x-if="multilineFields.has(name)">
                                                <textarea class="textarea flex-1" x-model="formArgs[name]"
                                                    :placeholder="schema.description || ''"></textarea>
                                            </template>
                                            <button type="button" class="btn btn-icon"
                                                :class="{ 'btn-primary': multilineFields.has(name) }"
                                                @click="toggleMultiline(name)" title="切换多行输入">
                                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                    stroke-width="2">
                                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                                                    <line x1="3" y1="9" x2="21" y2="9" />
                                                    <line x1="3" y1="15" x2="21" y2="15" />
                                                </svg>
                                            </button>
                                        </div>
                                    </template>

                                    <template x-if="schema.type === 'number' || schema.type === 'integer'">
                                        <input class="input" type="number" x-model="formArgs[name]"
                                            :step="schema.type === 'integer' ? '1' : 'any'" />
                                    </template>

                                    <template x-if="schema.type === 'boolean'">
                                        <label class="check-row">
                                            <input type="checkbox" x-model="formArgs[name]" />
                                            <span class="text-sm" x-text="schema.description || name"></span>
                                        </label>
                                    </template>

                                    <template x-if="schema.type === 'array' || schema.type === 'object'">
                                        <textarea class="textarea text-mono" x-model="formArgs[name]"
                                            :placeholder="schema.type === 'array' ? 'JSON array, e.g. [...]' : 'JSON object, e.g. {\'key\': \'value\'}'"></textarea>
                                    </template>

                                    <span x-show="schema.description && schema.type !== 'boolean'" class="form-hint"
                                        x-text="schema.description"></span>
                                </div>
                            </template>
                        </form>
                    </div>
                </template>
            </section>

            <!-- 可拖动分割条 -->
            <div class="resizer-v" @mousedown="startResize('vertical', $event)" @dblclick="handleDblClick('input')">
            </div>

            <!-- 结果展示面板 -->
            <section id="result-panel" class="flex-1 flex flex-col overflow-hidden" style="min-height: 96px;">
                <div class="result-header flex-between px-4 py-2 bg-surface border-b">
                    <div class="flex gap-1">
                        <template x-for="v in ['raw', 'formatted', 'final']" :key="v">
                            <button class="btn btn-sm" :class="{ 'btn-primary': currentView === v }"
                                @click="currentView = v" x-text="v.toUpperCase()"></button>
                        </template>
                    </div>
                    <div class="flex gap-2">
                        <button class="btn btn-icon btn-sm" @click="copyResult()" title="复制结果">
                            <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2" />
                                <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1" />
                            </svg>
                        </button>
                    </div>
                </div>
                <!-- 这里的 h-full 配合外部的 flex-1 确保填满 -->
                <div class="page-body p-4 h-full">
                    <template x-if="!currentResult">
                        <div class="empty-state">
                            <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <circle cx="12" cy="12" r="10" />
                                <path d="M12 16v-4M12 8h.01" />
                            </svg>
                            <div class="text-muted">执行工具后结果将显示在这里</div>
                        </div>
                    </template>
                    <!-- 使用 result-content-wrapper 类来实现内部的 flex 布局 -->
                    <div x-show="currentResult" class="result-content-wrapper">
                        <div class="flex flex-wrap gap-2" style="margin-bottom: var(--sp-3);">
                            <template x-if="currentResult?.status === 'success'">
                                <span class="badge badge-success">SUCCESS</span>
                            </template>
                            <template x-if="currentResult?.status === 'error'">
                                <span class="badge badge-error">ERROR</span>
                            </template>
                            <template
                                x-if="currentResult?.status && !['success','error'].includes(currentResult.status)">
                                <span class="badge badge-info" x-text="currentResult.status.toUpperCase()"></span>
                            </template>
                            <span x-show="currentResult?.isTruncated" class="badge badge-warning">TRUNCATED</span>
                            <span x-show="currentResult?.cacheFile" class="badge badge-info">CACHED</span>
                            <span class="badge" x-text="'Chars: ' + getDisplayResult().length"></span>
                        </div>
                        <div class="code-block text-sm" x-text="getDisplayResult()"></div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('manualExecute', () => ({
                toolGroups: [],
                currentTool: null,
                currentResult: null,
                currentView: 'raw',
                loading: false,
                sidebarWidth: 280,
                inputPanelHeight: 320,
                collapsedGroups: new Set(),
                formArgs: {},
                multilineFields: new Set(),
                resizing: null,
                startX: 0,
                startY: 0,
                startSize: 0,
                savedSidebarWidth: null,
                savedInputHeight: null,

                async init() {
                    window.addEventListener('pluginSdkReady', async () => {
                        const sdk = window.pluginSdk;
                        document.documentElement.setAttribute('data-theme-mode', sdk.themeMode || 'light');
                        this.toolGroups = await sdk.listToolGroups();
                    });
                },

                async selectTool(toolName) {
                    this.loading = true;
                    try {
                        const toolDef = await window.pluginSdk.getToolDefinition(toolName);
                        this.currentTool = toolDef;
                        this.formArgs = {};
                        this.multilineFields.clear();
                        this.currentResult = null;

                        const props = toolDef.function.parameters?.properties || {};
                        for (const [name, schema] of Object.entries(props)) {
                            if (schema.type === 'boolean') {
                                this.formArgs[name] = false;
                            } else {
                                this.formArgs[name] = '';
                            }
                        }
                    } finally {
                        this.loading = false;
                    }
                },

                toggleGroup(groupName) {
                    if (this.collapsedGroups.has(groupName)) {
                        this.collapsedGroups.delete(groupName);
                    } else {
                        this.collapsedGroups.add(groupName);
                    }
                },

                expandAll() { this.collapsedGroups.clear(); },
                collapseAll() { this.toolGroups.forEach(g => this.collapsedGroups.add(g.name)); },

                toggleMultiline(name) {
                    if (this.multilineFields.has(name)) {
                        this.multilineFields.delete(name);
                    } else {
                        this.multilineFields.add(name);
                    }
                },

                async execute() {
                    if (!this.currentTool || this.loading) return;
                    this.loading = true;
                    try {
                        const args = this.processArgs();
                        const result = await window.pluginSdk.executeTool(this.currentTool.function.name, args);
                        this.currentResult = result;
                    } catch (e) {
                        window.pluginSdk.showMessage('执行失败: ' + e.message, 'error');
                    } finally {
                        this.loading = false;
                    }
                },

                processArgs() {
                    const args = {};
                    const props = this.currentTool.function.parameters?.properties || {};
                    for (const [name, value] of Object.entries(this.formArgs)) {
                        const schema = props[name];
                        if (value === '' || value === null || value === undefined) {
                            if (schema.type === 'boolean') args[name] = false;
                            continue;
                        }

                        if (schema.type === 'number' || schema.type === 'integer') {
                            args[name] = Number(value);
                        } else if (schema.type === 'array' || schema.type === 'object') {
                            try {
                                args[name] = typeof value === 'string' ? JSON.parse(value) : value;
                            } catch (e) {
                                throw new Error(`参数 "${name}" 不是有效的 JSON: ${e.message}`);
                            }
                        } else {
                            args[name] = value;
                        }
                    }
                    return args;
                },

                resetForm() {
                    if (this.currentTool) this.selectTool(this.currentTool.function.name);
                },

                getDisplayResult() {
                    if (!this.currentResult) return '';
                    const res = this.currentResult;
                    let text = '';
                    switch (this.currentView) {
                        case 'raw': text = JSON.stringify(res.data, null, 2); break;
                        case 'formatted': text = res.formattedText || JSON.stringify(res.data, null, 2); break;
                        case 'final': text = res.finalText || res.formattedText || JSON.stringify(res.data, null, 2); break;
                    }
                    return text || (res ? `(无内容)\n\n原始返回如下: ${JSON.stringify(res)}` : '');
                },

                copyResult() {
                    const text = this.getDisplayResult();
                    if (text) {
                        navigator.clipboard.writeText(text).then(() => {
                            window.pluginSdk.showMessage('已复制', 'info');
                        });
                    }
                },

                startResize(type, e) {
                    this.resizing = type;
                    if (type === 'horizontal') {
                        this.startX = e.clientX;
                        this.startSize = this.sidebarWidth;
                    } else {
                        this.startY = e.clientY;
                        this.startSize = this.inputPanelHeight;
                    }
                    document.body.style.cursor = type === 'horizontal' ? 'ew-resize' : 'ns-resize';
                    document.body.style.userSelect = 'none';
                    e.preventDefault();
                },

                doResize(e) {
                    if (!this.resizing) return;
                    if (this.resizing === 'horizontal') {
                        const delta = e.clientX - this.startX;
                        this.sidebarWidth = Math.max(200, Math.min(600, this.startSize + delta));
                    } else {
                        const delta = e.clientY - this.startY;
                        const mainHeight = document.body.offsetHeight;
                        this.inputPanelHeight = Math.max(100, Math.min(mainHeight - 150, this.startSize + delta));
                    }
                },

                stopResize() {
                    this.resizing = null;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                },

                handleDblClick(type) {
                    if (type === 'sidebar') {
                        if (this.sidebarWidth !== 280) {
                            this.savedSidebarWidth = this.sidebarWidth;
                            this.sidebarWidth = 280;
                        } else {
                            this.sidebarWidth = this.savedSidebarWidth || 60;
                        }
                    } else {
                        if (this.inputPanelHeight !== 320) {
                            this.savedInputHeight = this.inputPanelHeight;
                            this.inputPanelHeight = 320;
                        } else {
                            this.inputPanelHeight = this.savedInputHeight || 100;
                        }
                    }
                }
            }));
        });
    </script>
</body>

</html>