<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Tree Visualization</title>
    <style>
        :root {
            /* å­—ä½“å¤§å°è¯­ä¹‰åŒ–å˜é‡ */
            --font-size-normal: var(--font-size, 14px);
            --font-size-large: calc(var(--font-size-normal) * 1.2);
            --font-size-small: calc(var(--font-size-normal) * 0.85);
            --font-size-tiny: calc(var(--font-size-normal) * 0.75);

            /* é¢œè‰²è¯­ä¹‰åŒ–å˜é‡ */
            --bg-primary: var(--theme-background, #ffffff);
            --bg-secondary: var(--theme-surface, #f5f5f5);
            --bg-tertiary: var(--theme-surface-light, #eeeeee);

            --text-primary: var(--theme-on-background, #333333);
            --text-secondary: var(--theme-on-surface-light, #666666);

            --accent-color: var(--theme-primary, #4a90d9);
            --accent-light: var(--theme-primary-lightest, #e3f2fd);

            --border-color: var(--theme-surface-lighter, #e0e0e0);

            /* èŠ‚ç‚¹é¢œè‰² */
            --node-user: #4caf50;
            --node-user-bg: #e8f5e9;
            --node-assistant: #2196f3;
            --node-assistant-bg: #e3f2fd;
            --node-separator: #9e9e9ee9e9e;
            --node-separator-bg: #f5f5f5;
            --node-active: var(--accent-color);
            --node-active-glow: rgba(74, 144, 217, 0.4);

            /* è¿çº¿ */
            --edge-color: #bdbdbd;
            --edge-active: var(--accent-color);
        }

        [data-theme-mode="dark"] {
            --node-user-bg: #1b5e20;
            --node-assistant-bg: #0d47a1;
            --node-separator-bg: #424242;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family, system-ui, sans-serif);
            font-size: var(--font-size-normal);
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* ========== é¡¶éƒ¨å·¥å…·æ  ========== */
        .toolbar {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .toolbar-title {
            font-size: var(--font-size-large);
            font-weight: 600;
            color: var(--text-primary);
        }

        .toolbar-info {
            font-size: var(--font-size-small);
            color: var(--text-secondary);
            margin-left: auto;
        }

        .toolbar-btn {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: var(--font-size-small);
            transition: all 0.15s ease;
        }

        .toolbar-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-color);
        }

        .toolbar-btn.active {
            background: var(--accent-light);
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        /* ========== ä¸»åŒºåŸŸå¸ƒå±€ ========== */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* ========== æ ‘å½¢è§†å›¾ ========== */
        .tree-container {
            flex: 1;
            overflow: auto;
            padding: 24px;
            position: relative;
        }

        .tree-canvas {
            position: relative;
            min-width: 100%;
            min-height: 100%;
        }

        /* SVG è¿çº¿å±‚ */
        .tree-edges {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            overflow: visible;
        }

        .tree-edge {
            stroke: var(--edge-color);
            stroke-width: 2;
            fill: none;
        }

        .tree-edge.active {
            stroke: var(--edge-active);
            stroke-width: 3;
        }

        /* èŠ‚ç‚¹å±‚ */
        .tree-nodes {
            position: relative;
        }

        .tree-node {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.15s ease;
        }

        .tree-node:hover {
            transform: scale(1.05);
        }

        .node-circle {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
            border: 3px solid transparent;
            transition: all 0.2s ease;
            position: relative;
        }

        .node-circle.user {
            background: var(--node-user-bg);
            color: var(--node-user);
            border-color: var(--node-user);
        }

        .node-circle.assistant {
            background: var(--node-assistant-bg);
            color: var(--node-assistant);
            border-color: var(--node-assistant);
        }

        .node-circle.separator {
            width: 32px;
            height: 32px;
            background: var(--node-separator-bg);
            color: var(--node-separator);
            border-color: var(--node-separator);
            font-size: 14px;
        }

        .node-circle.active {
            box-shadow: 0 0 0 4px var(--node-active-glow);
        }

        .node-circle.worldline {
            border-width: 4px;
        }

        /* ç‰ˆæœ¬å¾½ç«  */
        .node-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            min-width: 18px;
            height: 18px;
            padding: 0 4px;
            border-radius: 9px;
            background: var(--accent-color);
            color: white;
            font-size: 11px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* åˆ†æ”¯å¾½ç«  */
        .node-branch-badge {
            position: absolute;
            bottom: -4px;
            right: -4px;
            min-width: 18px;
            height: 18px;
            padding: 0 4px;
            border-radius: 9px;
            background: #ff9800;
            color: white;
            font-size: 11px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .node-label {
            margin-top: 6px;
            font-size: var(--font-size-tiny);
            color: var(--text-secondary);
            max-width: 80px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ========== è¯¦æƒ…é¢æ¿ ========== */
        .detail-panel {
            width: 320px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: width 0.2s ease;
        }

        .detail-panel.collapsed {
            width: 0;
            border-left: none;
        }

        .detail-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-header-title {
            font-weight: 600;
            flex: 1;
        }

        .detail-close {
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }

        .detail-close:hover {
            background: var(--bg-tertiary);
        }

        .detail-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .detail-section {
            margin-bottom: 16px;
        }

        .detail-section-title {
            font-size: var(--font-size-small);
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-field {
            display: flex;
            margin-bottom: 6px;
            font-size: var(--font-size-small);
        }

        .detail-field-label {
            width: 80px;
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        .detail-field-value {
            flex: 1;
            word-break: break-all;
        }

        .detail-preview {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
            font-size: var(--font-size-small);
            line-height: 1.5;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .detail-actions {
            padding: 12px 16px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 8px;
        }

        .detail-btn {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: var(--font-size-small);
            transition: all 0.15s ease;
        }

        .detail-btn:hover {
            background: var(--bg-tertiary);
        }

        .detail-btn.primary {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .detail-btn.primary:hover {
            opacity: 0.9;
        }

        /* ========== å›¾ä¾‹ ========== */
        .legend {
            display: flex;
            gap: 16px;
            padding: 8px 16px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            font-size: var(--font-size-small);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .legend-dot.user {
            background: var(--node-user);
        }

        .legend-dot.assistant {
            background: var(--node-assistant);
        }

        .legend-dot.separator {
            background: var(--node-separator);
        }

        .legend-dot.worldline {
            border: 3px solid var(--accent-color);
            background: transparent;
        }

        /* ========== ç©ºçŠ¶æ€ ========== */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: var(--font-size-normal);
        }
    </style>
</head>

<body>
    <div class="toolbar">
        <span class="toolbar-title">Chat Tree</span>
        <button class="toolbar-btn" id="btn-fit">é€‚åº”çª—å£</button>
        <button class="toolbar-btn" id="btn-center">å±…ä¸­æ ¹èŠ‚ç‚¹</button>
        <span class="toolbar-info" id="tree-info">--</span>
    </div>

    <div class="main-container">
        <div class="tree-container" id="tree-container">
            <div class="tree-canvas" id="tree-canvas">
                <svg class="tree-edges" id="tree-edges"></svg>
                <div class="tree-nodes" id="tree-nodes"></div>
            </div>
        </div>

        <div class="detail-panel" id="detail-panel">
            <div class="detail-header">
                <span class="detail-header-title">èŠ‚ç‚¹è¯¦æƒ…</span>
                <button class="detail-close" id="detail-close">âœ•</button>
            </div>
            <div class="detail-content" id="detail-content">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸŒ³</div>
                    <div class="empty-state-text">ç‚¹å‡»èŠ‚ç‚¹æŸ¥çœ‹è¯¦æƒ…</div>
                </div>
            </div>
            <div class="detail-actions" id="detail-actions" style="display: none;">
                <button class="detail-btn primary" id="btn-switch-worldline">åˆ‡æ¢åˆ°æ­¤ä¸–ç•Œçº¿</button>
            </div>
        </div>
    </div>

    <div class="legend">
        <div class="legend-item">
            <div class="legend-dot user"></div>
            <span>ç”¨æˆ·æ¶ˆæ¯</span>
        </div>
        <div class="legend-item">
            <div class="legend-dot assistant"></div>
            <span>åŠ©æ‰‹æ¶ˆæ¯</span>
        </div>
        <div class="legend-item">
            <div class="legend-dot separator"></div>
            <span>åˆ†éš”ç¬¦</span>
        </div>
        <div class="legend-item">
            <div class="legend-dot worldline"></div>
            <span>å½“å‰ä¸–ç•Œçº¿</span>
        </div>
    </div>

    <script>
        // ============ æ•°æ®æ ¼å¼å®šä¹‰ ============
        /**
         * @typedef {Object} TreeNode
         * @property {string} id
         * @property {'message' | 'separator'} type
         * @property {'user' | 'assistant' | ''} role
         * @property {string | null} parent
         * @property {string[]} children
         * @property {string} [preview] - å†…å®¹é¢„è§ˆï¼ˆå‰50å­—ï¼‰
         * @property {number} [versionCount] - ç‰ˆæœ¬æ•°é‡
         * @property {number} [timestamp]
         * @property {string} [author]
         */

        /**
         * @typedef {Object} TreeData
         * @property {Object.<string, TreeNode>} nodes
         * @property {string[]} worldLine
         * @property {string | null} rootId
         */

        // ============ å…¨å±€çŠ¶æ€ ============
        let treeData = null;
        let selectedNodeId = null;
        let nodePositions = new Map(); // id -> {x, y}

        // å¸ƒå±€å‚æ•°
        const LAYOUT = {
            nodeWidth: 100,
            nodeHeight: 80,
            levelGap: 100,      // å±‚çº§é—´è·ï¼ˆå‚ç›´ï¼‰
            siblingGap: 40,     // å…„å¼ŸèŠ‚ç‚¹é—´è·
            padding: 50
        };

        // ============ DOM å¼•ç”¨ ============
        const $treeContainer = document.getElementById('tree-container');
        const $treeCanvas = document.getElementById('tree-canvas');
        const $treeEdges = document.getElementById('tree-edges');
        const $treeNodes = document.getElementById('tree-nodes');
        const $detailPanel = document.getElementById('detail-panel');
        const $detailContent = document.getElementById('detail-content');
        const $detailActions = document.getElementById('detail-actions');
        const $treeInfo = document.getElementById('tree-info');

        // ============ å¸ƒå±€ç®—æ³• ============

        /**
         * è®¡ç®—å­æ ‘å®½åº¦ï¼ˆé€’å½’ï¼‰
         */
        function calcSubtreeWidth(nodeId, nodes) {
            const node = nodes[nodeId];
            if (!node) return LAYOUT.nodeWidth;

            if (node.children.length === 0) {
                return LAYOUT.nodeWidth;
            }

            let totalWidth = 0;
            for (const childId of node.children) {
                totalWidth += calcSubtreeWidth(childId, nodes);
            }
            totalWidth += (node.children.length - 1) * LAYOUT.siblingGap;

            return Math.max(totalWidth, LAYOUT.nodeWidth);
        }

        /**
         * å¸ƒå±€æ ‘å½¢ç»“æ„
         */
        function layoutTree(data) {
            nodePositions.clear();
            if (!data || !data.rootId || !data.nodes[data.rootId]) return;

            const { nodes, rootId } = data;

            // é€’å½’å¸ƒå±€
            function layoutNode(nodeId, x, y) {
                const node = nodes[nodeId];
                if (!node) return;

                nodePositions.set(nodeId, { x, y });

                if (node.children.length === 0) return;

                // è®¡ç®—å­èŠ‚ç‚¹çš„æ€»å®½åº¦
                const childWidths = node.children.map(id => calcSubtreeWidth(id, nodes));
                const totalWidth = childWidths.reduce((a, b) => a + b, 0)
                    + (node.children.length - 1) * LAYOUT.siblingGap;

                // ä»å·¦è¾¹å¼€å§‹æ”¾ç½®å­èŠ‚ç‚¹
                let childX = x - totalWidth / 2;
                const childY = y + LAYOUT.levelGap;

                for (let i = 0; i < node.children.length; i++) {
                    const childId = node.children[i];
                    const childWidth = childWidths[i];
                    const centerX = childX + childWidth / 2;

                    layoutNode(childId, centerX, childY);
                    childX += childWidth + LAYOUT.siblingGap;
                }
            }

            // ä»æ ¹èŠ‚ç‚¹å¼€å§‹å¸ƒå±€
            const rootWidth = calcSubtreeWidth(rootId, nodes);
            layoutNode(rootId, rootWidth / 2 + LAYOUT.padding, LAYOUT.padding);
        }

        // ============ æ¸²æŸ“å‡½æ•° ============

        /**
         * æ¸²æŸ“æ ‘
         */
        function renderTree(data) {
            if (!data) {
                $treeNodes.innerHTML = `
                    <div class="empty-state" style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);">
                        <div class="empty-state-icon">ğŸŒ³</div>
                        <div class="empty-state-text">æš‚æ— æ•°æ®</div>
                    </div>
                `;
                $treeEdges.innerHTML = '';
                return;
            }

            treeData = data;
            layoutTree(data);

            const { nodes, worldLine } = data;
            const worldLineSet = new Set(worldLine);

            // è®¡ç®—ç”»å¸ƒå¤§å°
            let maxX = 0, maxY = 0;
            for (const [_, pos] of nodePositions) {
                maxX = Math.max(maxX, pos.x + LAYOUT.nodeWidth);
                maxY = Math.max(maxY, pos.y + LAYOUT.nodeHeight);
            }
            $treeCanvas.style.width = (maxX + LAYOUT.padding) + 'px';
            $treeCanvas.style.height = (maxY + LAYOUT.padding) + 'px';

            // æ¸²æŸ“è¿çº¿
            let edgesHtml = '';
            for (const [id, node] of Object.entries(nodes)) {
                const pos = nodePositions.get(id);
                if (!pos) continue;

                for (const childId of node.children) {
                    const childPos = nodePositions.get(childId);
                    if (!childPos) continue;

                    const isActive = worldLineSet.has(id) && worldLineSet.has(childId);
                    const x1 = pos.x;
                    const y1 = pos.y + 24; // èŠ‚ç‚¹åœ†å¿ƒ
                    const x2 = childPos.x;
                    const y2 = childPos.y + 24;

                    // ä½¿ç”¨è´å¡å°”æ›²çº¿
                    const midY = (y1 + y2) / 2;
                    edgesHtml += `<path class="tree-edge ${isActive ? 'active' : ''}" 
                        d="M ${x1} ${y1} C ${x1} ${midY}, ${x2} ${midY}, ${x2} ${y2}"/>`;
                }
            }
            $treeEdges.innerHTML = edgesHtml;
            $treeEdges.style.width = $treeCanvas.style.width;
            $treeEdges.style.height = $treeCanvas.style.height;

            // æ¸²æŸ“èŠ‚ç‚¹
            let nodesHtml = '';
            for (const [id, node] of Object.entries(nodes)) {
                const pos = nodePositions.get(id);
                if (!pos) continue;

                const isOnWorldLine = worldLineSet.has(id);
                const isSelected = id === selectedNodeId;

                let roleClass = node.role || 'separator';
                let icon = node.role === 'user' ? 'U' : node.role === 'assistant' ? 'A' : 'â€”';
                let label = node.preview ? node.preview.slice(0, 10) : (node.type === 'separator' ? 'åˆ†éš”ç¬¦' : '');

                let badges = '';
                if (node.versionCount && node.versionCount > 1) {
                    badges += `<div class="node-badge">${node.versionCount}</div>`;
                }
                if (node.children.length > 1) {
                    badges += `<div class="node-branch-badge">${node.children.length}</div>`;
                }

                nodesHtml += `
                    <div class="tree-node" data-id="${id}" 
                        style="left: ${pos.x - LAYOUT.nodeWidth / 2}px; top: ${pos.y}px; width: ${LAYOUT.nodeWidth}px;">
                        <div class="node-circle ${roleClass} ${isOnWorldLine ? 'worldline' : ''} ${isSelected ? 'active' : ''}">
                            ${icon}
                            ${badges}
                        </div>
                        <div class="node-label" title="${label}">${label}</div>
                    </div>
                `;
            }
            $treeNodes.innerHTML = nodesHtml;

            // æ›´æ–°ä¿¡æ¯
            $treeInfo.textContent = `æ€»èŠ‚ç‚¹: ${Object.keys(nodes).length} | å½“å‰ä¸–ç•Œçº¿: ${worldLine.length}`;

            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            $treeNodes.querySelectorAll('.tree-node').forEach(el => {
                el.addEventListener('click', () => {
                    const id = el.getAttribute('data-id');
                    selectNode(id);
                });
            });
        }

        /**
         * é€‰ä¸­èŠ‚ç‚¹
         */
        function selectNode(id) {
            selectedNodeId = id;

            // æ›´æ–°èŠ‚ç‚¹é«˜äº®
            $treeNodes.querySelectorAll('.node-circle').forEach(el => {
                el.classList.remove('active');
            });
            const nodeEl = $treeNodes.querySelector(`[data-id="${id}"] .node-circle`);
            if (nodeEl) nodeEl.classList.add('active');

            // æ˜¾ç¤ºè¯¦æƒ…
            const node = treeData?.nodes?.[id];
            if (!node) return;

            const worldLineSet = new Set(treeData.worldLine);
            const isOnWorldLine = worldLineSet.has(id);
            const isLeaf = node.children.length === 0;

            $detailContent.innerHTML = `
                <div class="detail-section">
                    <div class="detail-section-title">åŸºæœ¬ä¿¡æ¯</div>
                    <div class="detail-field">
                        <span class="detail-field-label">ID</span>
                        <span class="detail-field-value">${id}</span>
                    </div>
                    <div class="detail-field">
                        <span class="detail-field-label">ç±»å‹</span>
                        <span class="detail-field-value">${node.type === 'message' ? 'æ¶ˆæ¯' : 'åˆ†éš”ç¬¦'}</span>
                    </div>
                    ${node.role ? `
                    <div class="detail-field">
                        <span class="detail-field-label">è§’è‰²</span>
                        <span class="detail-field-value">${node.role === 'user' ? 'ç”¨æˆ·' : 'åŠ©æ‰‹'}</span>
                    </div>
                    ` : ''}
                    ${node.author ? `
                    <div class="detail-field">
                        <span class="detail-field-label">ä½œè€…</span>
                        <span class="detail-field-value">${node.author}</span>
                    </div>
                    ` : ''}
                    ${node.timestamp ? `
                    <div class="detail-field">
                        <span class="detail-field-label">æ—¶é—´</span>
                        <span class="detail-field-value">${new Date(node.timestamp).toLocaleString()}</span>
                    </div>
                    ` : ''}
                </div>

                <div class="detail-section">
                    <div class="detail-section-title">ç»“æ„ä¿¡æ¯</div>
                    <div class="detail-field">
                        <span class="detail-field-label">çˆ¶èŠ‚ç‚¹</span>
                        <span class="detail-field-value">${node.parent || '(æ ¹èŠ‚ç‚¹)'}</span>
                    </div>
                    <div class="detail-field">
                        <span class="detail-field-label">å­èŠ‚ç‚¹</span>
                        <span class="detail-field-value">${node.children.length} ä¸ª</span>
                    </div>
                    ${node.versionCount ? `
                    <div class="detail-field">
                        <span class="detail-field-label">ç‰ˆæœ¬æ•°</span>
                        <span class="detail-field-value">${node.versionCount}</span>
                    </div>
                    ` : ''}
                    <div class="detail-field">
                        <span class="detail-field-label">ä¸–ç•Œçº¿</span>
                        <span class="detail-field-value">${isOnWorldLine ? 'âœ“ åœ¨å½“å‰ä¸–ç•Œçº¿ä¸Š' : 'âœ— ä¸åœ¨å½“å‰ä¸–ç•Œçº¿ä¸Š'}</span>
                    </div>
                </div>

                ${node.preview ? `
                <div class="detail-section">
                    <div class="detail-section-title">å†…å®¹é¢„è§ˆ</div>
                    <div class="detail-preview">${escapeHtml(node.preview)}</div>
                </div>
                ` : ''}
            `;

            // æ˜¾ç¤ºæ“ä½œæŒ‰é’®ï¼ˆä»…å¶å­èŠ‚ç‚¹å¯åˆ‡æ¢ä¸–ç•Œçº¿ï¼‰
            if (isLeaf && !isOnWorldLine) {
                $detailActions.style.display = 'flex';
            } else {
                $detailActions.style.display = 'none';
            }
        }

        function escapeHtml(str) {
            return str.replace(/[&<>"']/g, c => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            }[c]));
        }

        // ============ äº‹ä»¶å¤„ç† ============

        document.getElementById('btn-fit').addEventListener('click', () => {
            // é€‚åº”çª—å£ï¼ˆç®€å•å®ç°ï¼šæ»šåŠ¨åˆ°ä¸­å¿ƒï¼‰
            const container = $treeContainer;
            const canvas = $treeCanvas;
            container.scrollLeft = (canvas.offsetWidth - container.offsetWidth) / 2;
            container.scrollTop = 0;
        });

        document.getElementById('btn-center').addEventListener('click', () => {
            if (!treeData?.rootId) return;
            const pos = nodePositions.get(treeData.rootId);
            if (pos) {
                $treeContainer.scrollTo({
                    left: pos.x - $treeContainer.offsetWidth / 2,
                    top: 0,
                    behavior: 'smooth'
                });
            }
        });

        document.getElementById('detail-close').addEventListener('click', () => {
            selectedNodeId = null;
            $treeNodes.querySelectorAll('.node-circle').forEach(el => {
                el.classList.remove('active');
            });
            $detailContent.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸŒ³</div>
                    <div class="empty-state-text">ç‚¹å‡»èŠ‚ç‚¹æŸ¥çœ‹è¯¦æƒ…</div>
                </div>
            `;
            $detailActions.style.display = 'none';
        });

        document.getElementById('btn-switch-worldline').addEventListener('click', () => {
            if (!selectedNodeId) return;
            // é€šçŸ¥å¤–éƒ¨åˆ‡æ¢ä¸–ç•Œçº¿
            if (window.pluginSdk?.switchWorldLine) {
                window.pluginSdk.switchWorldLine(selectedNodeId);
            } else {
                console.log('Switch worldline to:', selectedNodeId);
                window.pluginSdk?.showMessage?.('å·²è¯·æ±‚åˆ‡æ¢ä¸–ç•Œçº¿: ' + selectedNodeId);
            }
        });

        // ============ åˆå§‹åŒ– ============

        window.addEventListener('pluginSdkReady', async () => {
            const themeMode = window.pluginSdk?.themeMode || 'light';
            document.documentElement.setAttribute('data-theme-mode', themeMode);

            // å¦‚æœæœ‰ getTreeData æ–¹æ³•ï¼Œè°ƒç”¨è·å–æ•°æ®
            if (window.pluginSdk?.getTreeData) {
                const data = await window.pluginSdk.getTreeData();
                renderTree(data);
            }
        });

        // ç›‘å¬å¤–éƒ¨æ•°æ®æ›´æ–°äº‹ä»¶
        window.addEventListener('treeDataUpdate', (e) => {
            renderTree(e.detail);
        });

        // æš´éœ²æ¸²æŸ“æ–¹æ³•ä¾›å¤–éƒ¨è°ƒç”¨
        window.renderTree = renderTree;

        // Demo æ•°æ®ï¼ˆå¼€å‘æµ‹è¯•ç”¨ï¼Œç”Ÿäº§ç¯å¢ƒç§»é™¤ï¼‰
        // const DEMO_DATA = {
        //     rootId: 'u1',
        //     worldLine: ['u1', 'a1', 'u2', 'a2'],
        //     nodes: {
        //         'u1': { id: 'u1', type: 'message', role: 'user', parent: null, children: ['a1'], preview: 'ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹è‡ªå·±', timestamp: Date.now() - 100000 },
        //         'a1': { id: 'a1', type: 'message', role: 'assistant', parent: 'u1', children: ['u2', 'u3'], preview: 'ä½ å¥½ï¼æˆ‘æ˜¯ä¸€ä¸ªAIåŠ©æ‰‹...', timestamp: Date.now() - 90000, versionCount: 2 },
        //         'u2': { id: 'u2', type: 'message', role: 'user', parent: 'a1', children: ['a2'], preview: 'è§£é‡Šä¸€ä¸‹é‡å­åŠ›å­¦', timestamp: Date.now() - 80000 },
        //         'a2': { id: 'a2', type: 'message', role: 'assistant', parent: 'u2', children: ['sep1'], preview: 'é‡å­åŠ›å­¦æ˜¯æè¿°å¾®è§‚ç²’å­è¡Œä¸ºçš„ç‰©ç†ç†è®º...', timestamp: Date.now() - 70000 },
        //         'sep1': { id: 'sep1', type: 'separator', role: '', parent: 'a2', children: ['u4'] },
        //         'u4': { id: 'u4', type: 'message', role: 'user', parent: 'sep1', children: ['a4'], preview: 'ç»§ç»­è®²è®²è–›å®šè°”çš„çŒ«', timestamp: Date.now() - 50000 },
        //         'a4': { id: 'a4', type: 'message', role: 'assistant', parent: 'u4', children: [], preview: 'è–›å®šè°”çš„çŒ«æ˜¯ä¸€ä¸ªæ€æƒ³å®éªŒ...', timestamp: Date.now() - 40000, author: 'GPT-4' },
        //         'u3': { id: 'u3', type: 'message', role: 'user', parent: 'a1', children: ['a3'], preview: 'è®²ä¸ªç¬‘è¯å§', timestamp: Date.now() - 85000 },
        //         'a3': { id: 'a3', type: 'message', role: 'assistant', parent: 'u3', children: [], preview: 'å¥½çš„ï¼Œç»™ä½ è®²ä¸€ä¸ªç¨‹åºå‘˜ç¬‘è¯...', timestamp: Date.now() - 82000 },
        //     }
        // };

        // // å¦‚æœæ²¡æœ‰ SDKï¼Œä½¿ç”¨ demo æ•°æ®
        // if (!window.pluginSdk) {
        //     setTimeout(() => renderTree(DEMO_DATA), 100);
        // }
    </script>
</body>

</html>