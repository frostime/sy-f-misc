<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Tree Visualization</title>
    <style>
        :root {
            /* å­—ä½“å¤§å°è¯­ä¹‰åŒ–å˜é‡ */
            --font-size-normal: var(--font-size, 14px);
            --font-size-large: calc(var(--font-size-normal) * 1.2);
            --font-size-small: calc(var(--font-size-normal) * 0.85);
            --font-size-tiny: calc(var(--font-size-normal) * 0.75);

            /* é¢œè‰²è¯­ä¹‰åŒ–å˜é‡ */
            --bg-primary: var(--theme-background, #ffffff);
            --bg-secondary: var(--theme-surface, #f5f5f5);
            --bg-tertiary: var(--theme-surface-light, #eeeeee);

            --text-primary: var(--theme-on-background, #333333);
            --text-secondary: var(--theme-on-surface-light, #666666);

            --accent-color: var(--theme-primary, #4a90d9);
            --accent-light: var(--theme-primary-lightest, #e3f2fd);

            --border-color: var(--theme-surface-lighter, #e0e0e0);

            /* èŠ‚ç‚¹é¢œè‰² */
            --node-user: #4caf50;
            --node-user-bg: #e8f5e9;
            --node-assistant: #2196f3;
            --node-assistant-bg: #e3f2fd;
            --node-separator: #9e9e9e;
            --node-separator-bg: #f5f5f5;
            --node-active: var(--accent-color);
            --node-active-glow: rgba(74, 144, 217, 0.4);

            /* è¿çº¿ */
            --edge-color: #bdbdbd;
            --edge-active: var(--accent-color);
        }

        [data-theme-mode="dark"] {
            --node-user-bg: #1b5e20;
            --node-assistant-bg: #0d47a1;
            --node-separator-bg: #424242;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family, system-ui, sans-serif);
            font-size: var(--font-size-normal);
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* ========== é¡¶éƒ¨å·¥å…·æ  ========== */
        .toolbar {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .toolbar-title {
            font-size: var(--font-size-large);
            font-weight: 600;
            color: var(--text-primary);
        }

        .toolbar-info {
            font-size: var(--font-size-small);
            color: var(--text-secondary);
            margin-left: auto;
        }

        .toolbar-btn {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: var(--font-size-small);
            transition: all 0.15s ease;
        }

        .toolbar-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-color);
        }

        .toolbar-btn.active {
            background: var(--accent-light);
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        /* ========== ä¸»åŒºåŸŸå¸ƒå±€ ========== */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* ========== æ ‘å½¢è§†å›¾ ========== */
        .tree-container {
            flex: 1;
            overflow: auto;
            position: relative;
        }

        .tree-canvas {
            position: relative;
            /* å°ºå¯¸ç”± JS åŠ¨æ€è®¾ç½® */
        }

        /* SVG è¿çº¿å±‚ - ä½¿ç”¨ç»å¯¹å®šä½è¦†ç›–æ•´ä¸ªç”»å¸ƒ */
        .tree-edges {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            /* å…³é”®ï¼šç¡®ä¿ SVG å¯ä»¥æ¸²æŸ“è¶…å‡ºè¾¹ç•Œçš„å†…å®¹ */
            overflow: visible;
        }

        .tree-edge {
            stroke: var(--edge-color);
            stroke-width: 2;
            fill: none;
            transition: stroke 0.2s ease, stroke-width 0.2s ease;
        }

        .tree-edge.active {
            stroke: var(--edge-active);
            stroke-width: 3;
        }

        /* èŠ‚ç‚¹å±‚ */
        .tree-nodes {
            position: relative;
        }

        .tree-node {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.15s ease;
            /* ç¡®ä¿èŠ‚ç‚¹å†…å®¹å±…ä¸­å¯¹é½ */
            transform-origin: center top;
        }

        .tree-node:hover {
            transform: scale(1.05);
        }

        .node-circle {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
            border: 3px solid transparent;
            transition: all 0.2s ease;
            position: relative;
            flex-shrink: 0;
        }

        .node-circle.user {
            background: var(--node-user-bg);
            color: var(--node-user);
            border-color: var(--node-user);
        }

        .node-circle.assistant {
            background: var(--node-assistant-bg);
            color: var(--node-assistant);
            border-color: var(--node-assistant);
        }

        .node-circle.separator {
            width: 32px;
            height: 32px;
            background: var(--node-separator-bg);
            color: var(--node-separator);
            border-color: var(--node-separator);
            font-size: 14px;
        }

        .node-circle.active {
            box-shadow: 0 0 0 4px var(--node-active-glow);
        }

        .node-circle.worldline {
            border-width: 4px;
        }

        /* ç‰ˆæœ¬å¾½ç«  */
        .node-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            min-width: 18px;
            height: 18px;
            padding: 0 4px;
            border-radius: 9px;
            background: var(--accent-color);
            color: white;
            font-size: 11px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* åˆ†æ”¯å¾½ç«  */
        .node-branch-badge {
            position: absolute;
            bottom: -4px;
            right: -4px;
            min-width: 18px;
            height: 18px;
            padding: 0 4px;
            border-radius: 9px;
            background: #ff9800;
            color: white;
            font-size: 11px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .node-label {
            margin-top: 6px;
            font-size: var(--font-size-tiny);
            color: var(--text-secondary);
            max-width: 80px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ========== è¯¦æƒ…é¢æ¿ ========== */
        .detail-panel {
            width: 320px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: width 0.2s ease;
        }

        .detail-panel.collapsed {
            width: 0;
            border-left: none;
        }

        .detail-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-header-title {
            font-weight: 600;
            flex: 1;
        }

        .detail-close {
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }

        .detail-close:hover {
            background: var(--bg-tertiary);
        }

        .detail-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .detail-section {
            margin-bottom: 16px;
        }

        .detail-section-title {
            font-size: var(--font-size-small);
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-field {
            display: flex;
            margin-bottom: 6px;
            font-size: var(--font-size-small);
        }

        .detail-field-label {
            width: 80px;
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        .detail-field-value {
            flex: 1;
            word-break: break-all;
        }

        .detail-preview {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
            font-size: var(--font-size-small);
            line-height: 1.5;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .detail-actions {
            padding: 12px 16px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 8px;
        }

        .detail-btn {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: var(--font-size-small);
            transition: all 0.15s ease;
        }

        .detail-btn:hover {
            background: var(--bg-tertiary);
        }

        .detail-btn.primary {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .detail-btn.primary:hover {
            opacity: 0.9;
        }

        /* ========== å›¾ä¾‹ ========== */
        .legend {
            display: flex;
            gap: 16px;
            padding: 8px 16px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            font-size: var(--font-size-small);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .legend-dot.user {
            background: var(--node-user);
        }

        .legend-dot.assistant {
            background: var(--node-assistant);
        }

        .legend-dot.separator {
            background: var(--node-separator);
        }

        .legend-dot.worldline {
            border: 3px solid var(--accent-color);
            background: transparent;
        }

        /* ========== ç©ºçŠ¶æ€ ========== */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: var(--font-size-normal);
        }
    </style>
</head>

<body>
    <div class="toolbar">
        <span class="toolbar-title">Chat Tree</span>
        <button class="toolbar-btn" id="btn-fit">é€‚åº”çª—å£</button>
        <button class="toolbar-btn" id="btn-center">å±…ä¸­æ ¹èŠ‚ç‚¹</button>
        <span class="toolbar-info" id="tree-info">--</span>
    </div>

    <div class="main-container">
        <div class="tree-container" id="tree-container">
            <div class="tree-canvas" id="tree-canvas">
                <svg class="tree-edges" id="tree-edges"></svg>
                <div class="tree-nodes" id="tree-nodes"></div>
            </div>
        </div>

        <div class="detail-panel" id="detail-panel">
            <div class="detail-header">
                <span class="detail-header-title">èŠ‚ç‚¹è¯¦æƒ…</span>
                <button class="detail-close" id="detail-close">âœ•</button>
            </div>
            <div class="detail-content" id="detail-content">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸŒ³</div>
                    <div class="empty-state-text">ç‚¹å‡»èŠ‚ç‚¹æŸ¥çœ‹è¯¦æƒ…</div>
                </div>
            </div>
            <div class="detail-actions" id="detail-actions" style="display: none;">
                <button class="detail-btn primary" id="btn-switch-worldline">åˆ‡æ¢åˆ°æ­¤ä¸–ç•Œçº¿</button>
            </div>
        </div>
    </div>

    <div class="legend">
        <div class="legend-item">
            <div class="legend-dot user"></div>
            <span>ç”¨æˆ·æ¶ˆæ¯</span>
        </div>
        <div class="legend-item">
            <div class="legend-dot assistant"></div>
            <span>åŠ©æ‰‹æ¶ˆæ¯</span>
        </div>
        <div class="legend-item">
            <div class="legend-dot separator"></div>
            <span>åˆ†éš”ç¬¦</span>
        </div>
        <div class="legend-item">
            <div class="legend-dot worldline"></div>
            <span>å½“å‰ä¸–ç•Œçº¿</span>
        </div>
    </div>

    <script>
        // ============ æ•°æ®æ ¼å¼å®šä¹‰ ============
        /**
         * @typedef {Object} TreeNode
         * @property {string} id
         * @property {'message' | 'separator'} type
         * @property {'user' | 'assistant' | ''} role
         * @property {string | null} parent
         * @property {string[]} children
         * @property {string} [preview]
         * @property {number} [versionCount]
         * @property {number} [timestamp]
         * @property {string} [author]
         */

        /**
         * @typedef {Object} TreeData
         * @property {Object.<string, TreeNode>} nodes
         * @property {string[]} worldLine
         * @property {string | null} rootId
         */

        // ============ å…¨å±€çŠ¶æ€ ============
        let treeData = null;
        let selectedNodeId = null;
        /** @type {Map<string, {x: number, y: number}>} */
        let nodePositions = new Map();

        // å¸ƒå±€å‚æ•°
        const LAYOUT = {
            nodeWidth: 100,       // èŠ‚ç‚¹å®¹å™¨å®½åº¦
            nodeHeight: 80,       // èŠ‚ç‚¹å®¹å™¨é«˜åº¦ï¼ˆåŒ…å«åœ†å½¢å’Œæ ‡ç­¾ï¼‰
            circleSize: 48,       // åœ†å½¢ç›´å¾„
            separatorSize: 32,    // åˆ†éš”ç¬¦åœ†å½¢ç›´å¾„
            levelGap: 100,        // å±‚çº§é—´è·ï¼ˆå‚ç›´ï¼‰
            siblingGap: 20,       // å…„å¼ŸèŠ‚ç‚¹æœ€å°é—´è·
            subtreeGap: 30,       // å­æ ‘ä¹‹é—´çš„é—´è·
            padding: 60           // ç”»å¸ƒè¾¹è·
        };

        // ============ DOM å¼•ç”¨ ============
        const $treeContainer = document.getElementById('tree-container');
        const $treeCanvas = document.getElementById('tree-canvas');
        const $treeEdges = document.getElementById('tree-edges');
        const $treeNodes = document.getElementById('tree-nodes');
        const $detailPanel = document.getElementById('detail-panel');
        const $detailContent = document.getElementById('detail-content');
        const $detailActions = document.getElementById('detail-actions');
        const $treeInfo = document.getElementById('tree-info');

        // ============ æ”¹è¿›çš„ Reingold-Tilford å¸ƒå±€ç®—æ³• ============

        /**
         * å¸ƒå±€èŠ‚ç‚¹çš„å†…éƒ¨è¡¨ç¤º
         * @typedef {Object} LayoutNode
         * @property {string} id
         * @property {LayoutNode[]} children
         * @property {number} x - ç›¸å¯¹äºçˆ¶èŠ‚ç‚¹çš„ x åç§»
         * @property {number} y - å±‚çº§æ·±åº¦
         * @property {number} mod - ä¿®æ­£å€¼ï¼Œç”¨äºå­æ ‘ç§»åŠ¨
         * @property {LayoutNode|null} thread - çº¿ç´¢ï¼Œç”¨äºè½®å»“è®¡ç®—
         * @property {LayoutNode|null} ancestor - ç¥–å…ˆå¼•ç”¨
         */

        /**
         * ä»åŸå§‹æ•°æ®æ„å»ºå¸ƒå±€æ ‘
         */
        function buildLayoutTree(nodes, rootId) {
            if (!rootId || !nodes[rootId]) return null;

            function build(id, depth) {
                const node = nodes[id];
                if (!node) return null;

                /** @type {LayoutNode} */
                const layoutNode = {
                    id: id,
                    children: [],
                    x: 0,
                    y: depth,
                    mod: 0,
                    thread: null,
                    ancestor: null
                };
                layoutNode.ancestor = layoutNode;

                for (const childId of node.children) {
                    const childNode = build(childId, depth + 1);
                    if (childNode) {
                        layoutNode.children.push(childNode);
                    }
                }

                return layoutNode;
            }

            return build(rootId, 0);
        }

        /**
         * Reingold-Tilford ç®—æ³• - ç¬¬ä¸€éï¼šååºéå†ï¼Œè®¡ç®—åˆå§‹ä½ç½®
         */
        function firstWalk(node, siblings = [], index = 0) {
            if (node.children.length === 0) {
                // å¶å­èŠ‚ç‚¹
                if (index > 0) {
                    // æœ‰å·¦å…„å¼Ÿï¼Œç›¸å¯¹äºå·¦å…„å¼Ÿå®šä½
                    const leftSibling = siblings[index - 1];
                    node.x = leftSibling.x + LAYOUT.nodeWidth + LAYOUT.siblingGap;
                } else {
                    node.x = 0;
                }
            } else {
                // å†…éƒ¨èŠ‚ç‚¹
                let defaultAncestor = node.children[0];

                // é€’å½’å¤„ç†æ‰€æœ‰å­èŠ‚ç‚¹
                for (let i = 0; i < node.children.length; i++) {
                    const child = node.children[i];
                    firstWalk(child, node.children, i);
                    defaultAncestor = apportion(child, defaultAncestor, node.children, i);
                }

                executeShifts(node);

                // èŠ‚ç‚¹å±…ä¸­äºå­èŠ‚ç‚¹
                const firstChild = node.children[0];
                const lastChild = node.children[node.children.length - 1];
                const midpoint = (firstChild.x + lastChild.x) / 2;

                if (index > 0) {
                    const leftSibling = siblings[index - 1];
                    node.x = leftSibling.x + LAYOUT.nodeWidth + LAYOUT.siblingGap;
                    node.mod = node.x - midpoint;
                } else {
                    node.x = midpoint;
                }
            }
        }

        /**
         * å¤„ç†å­æ ‘ä¹‹é—´çš„å†²çª
         */
        function apportion(node, defaultAncestor, siblings, index) {
            if (index > 0) {
                const leftSibling = siblings[index - 1];

                let vInnerRight = node;
                let vOuterRight = node;
                let vInnerLeft = leftSibling;
                let vOuterLeft = siblings[0];

                let sInnerRight = node.mod;
                let sOuterRight = node.mod;
                let sInnerLeft = vInnerLeft.mod;
                let sOuterLeft = vOuterLeft.mod;

                while (nextRight(vInnerLeft) && nextLeft(vInnerRight)) {
                    vInnerLeft = nextRight(vInnerLeft);
                    vInnerRight = nextLeft(vInnerRight);
                    vOuterLeft = nextLeft(vOuterLeft);
                    vOuterRight = nextRight(vOuterRight);

                    vOuterRight.ancestor = node;

                    const shift = (vInnerLeft.x + sInnerLeft) - (vInnerRight.x + sInnerRight) + LAYOUT.nodeWidth + LAYOUT.subtreeGap;

                    if (shift > 0) {
                        const ancestor = findAncestor(vInnerLeft, node, defaultAncestor, siblings);
                        moveSubtree(ancestor, node, shift, siblings);
                        sInnerRight += shift;
                        sOuterRight += shift;
                    }

                    sInnerLeft += vInnerLeft.mod;
                    sInnerRight += vInnerRight.mod;
                    sOuterLeft += vOuterLeft.mod;
                    sOuterRight += vOuterRight.mod;
                }

                if (nextRight(vInnerLeft) && !nextRight(vOuterRight)) {
                    vOuterRight.thread = nextRight(vInnerLeft);
                    vOuterRight.mod += sInnerLeft - sOuterRight;
                }

                if (nextLeft(vInnerRight) && !nextLeft(vOuterLeft)) {
                    vOuterLeft.thread = nextLeft(vInnerRight);
                    vOuterLeft.mod += sInnerRight - sOuterLeft;
                    defaultAncestor = node;
                }
            }

            return defaultAncestor;
        }

        function nextLeft(node) {
            return node.children.length > 0 ? node.children[0] : node.thread;
        }

        function nextRight(node) {
            return node.children.length > 0 ? node.children[node.children.length - 1] : node.thread;
        }

        function findAncestor(vil, node, defaultAncestor, siblings) {
            const found = siblings.find(s => s === vil.ancestor);
            return found ? vil.ancestor : defaultAncestor;
        }

        function moveSubtree(wl, wr, shift, siblings) {
            const wlIndex = siblings.indexOf(wl);
            const wrIndex = siblings.indexOf(wr);
            const subtrees = wrIndex - wlIndex;

            if (subtrees > 0) {
                wr.change = (wr.change || 0) - shift / subtrees;
                wr.shift = (wr.shift || 0) + shift;
                wl.change = (wl.change || 0) + shift / subtrees;
                wr.x += shift;
                wr.mod += shift;
            }
        }

        function executeShifts(node) {
            let shift = 0;
            let change = 0;

            for (let i = node.children.length - 1; i >= 0; i--) {
                const child = node.children[i];
                child.x += shift;
                child.mod += shift;
                change += child.change || 0;
                shift += (child.shift || 0) + change;
            }
        }

        /**
         * ç¬¬äºŒéï¼šå‰åºéå†ï¼Œè®¡ç®—ç»å¯¹åæ ‡
         */
        function secondWalk(node, modSum = 0, minX = { value: Infinity }) {
            node.x += modSum;
            minX.value = Math.min(minX.value, node.x);

            for (const child of node.children) {
                secondWalk(child, modSum + node.mod, minX);
            }

            return minX.value;
        }

        /**
         * ç¬¬ä¸‰éï¼šå½’ä¸€åŒ–åæ ‡ï¼ˆç¡®ä¿æ‰€æœ‰ x >= 0ï¼‰å¹¶æ”¶é›†ä½ç½®
         */
        function normalizeAndCollect(node, offsetX) {
            const absX = node.x + offsetX + LAYOUT.padding;
            const absY = node.y * LAYOUT.levelGap + LAYOUT.padding;

            nodePositions.set(node.id, { x: absX, y: absY });

            for (const child of node.children) {
                normalizeAndCollect(child, offsetX);
            }
        }

        /**
         * ä¸»å¸ƒå±€å‡½æ•°
         */
        function layoutTree(data) {
            nodePositions.clear();
            if (!data || !data.rootId || !data.nodes[data.rootId]) return;

            // 1. æ„å»ºå¸ƒå±€æ ‘
            const layoutRoot = buildLayoutTree(data.nodes, data.rootId);
            if (!layoutRoot) return;

            // 2. ç¬¬ä¸€éï¼šè®¡ç®—ç›¸å¯¹ä½ç½®
            firstWalk(layoutRoot, [], 0);

            // 3. ç¬¬äºŒéï¼šç´¯åŠ ä¿®æ­£å€¼ï¼Œè®¡ç®—ç»å¯¹ä½ç½®
            const minX = secondWalk(layoutRoot);

            // 4. ç¬¬ä¸‰éï¼šå½’ä¸€åŒ–å¹¶æ”¶é›†åæ ‡
            const offsetX = -minX;
            normalizeAndCollect(layoutRoot, offsetX);
        }

        // ============ æ¸²æŸ“å‡½æ•° ============

        /**
         * è·å–èŠ‚ç‚¹åœ†å¿ƒåæ ‡ï¼ˆç”¨äºè¿çº¿ï¼‰
         */
        function getNodeCenter(id, nodes) {
            const pos = nodePositions.get(id);
            if (!pos) return null;

            const node = nodes[id];
            const circleSize = node?.type === 'separator' ? LAYOUT.separatorSize : LAYOUT.circleSize;

            return {
                x: pos.x,
                y: pos.y + circleSize / 2
            };
        }

        /**
         * æ¸²æŸ“æ ‘
         */
        function renderTree(data) {
            if (!data) {
                $treeNodes.innerHTML = `
                    <div class="empty-state" style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);">
                        <div class="empty-state-icon">ğŸŒ³</div>
                        <div class="empty-state-text">æš‚æ— æ•°æ®</div>
                    </div>
                `;
                $treeEdges.innerHTML = '';
                return;
            }

            treeData = data;
            layoutTree(data);

            const { nodes, worldLine } = data;
            const worldLineSet = new Set(worldLine);

            // è®¡ç®—ç”»å¸ƒå¤§å°
            let maxX = 0, maxY = 0;
            for (const [id, pos] of nodePositions) {
                const node = nodes[id];
                const circleSize = node?.type === 'separator' ? LAYOUT.separatorSize : LAYOUT.circleSize;
                maxX = Math.max(maxX, pos.x + LAYOUT.nodeWidth / 2);
                maxY = Math.max(maxY, pos.y + LAYOUT.nodeHeight);
            }

            const canvasWidth = maxX + LAYOUT.padding;
            const canvasHeight = maxY + LAYOUT.padding;

            $treeCanvas.style.width = canvasWidth + 'px';
            $treeCanvas.style.height = canvasHeight + 'px';

            // æ¸²æŸ“ SVG è¿çº¿
            $treeEdges.setAttribute('width', canvasWidth);
            $treeEdges.setAttribute('height', canvasHeight);
            $treeEdges.setAttribute('viewBox', `0 0 ${canvasWidth} ${canvasHeight}`);

            let edgesHtml = '';
            for (const [id, node] of Object.entries(nodes)) {
                const parentCenter = getNodeCenter(id, nodes);
                if (!parentCenter) continue;

                for (const childId of node.children) {
                    const childCenter = getNodeCenter(childId, nodes);
                    if (!childCenter) continue;

                    const isActive = worldLineSet.has(id) && worldLineSet.has(childId);

                    // ä½¿ç”¨å¹³æ»‘çš„è´å¡å°”æ›²çº¿
                    const x1 = parentCenter.x;
                    const y1 = parentCenter.y;
                    const x2 = childCenter.x;
                    const y2 = childCenter.y;

                    // æ§åˆ¶ç‚¹åœ¨ä¸¤ç‚¹ä¸­é—´é«˜åº¦ä½ç½®ï¼Œæ°´å¹³æ–¹å‘å¯¹é½èµ·ç‚¹/ç»ˆç‚¹
                    const cy1 = y1 + (y2 - y1) * 0.4;
                    const cy2 = y1 + (y2 - y1) * 0.6;

                    edgesHtml += `<path class="tree-edge${isActive ? ' active' : ''}"
                        d="M ${x1} ${y1} C ${x1} ${cy1}, ${x2} ${cy2}, ${x2} ${y2}"/>`;
                }
            }
            $treeEdges.innerHTML = edgesHtml;

            // æ¸²æŸ“èŠ‚ç‚¹
            let nodesHtml = '';
            for (const [id, node] of Object.entries(nodes)) {
                const pos = nodePositions.get(id);
                if (!pos) continue;

                const isOnWorldLine = worldLineSet.has(id);
                const isSelected = id === selectedNodeId;
                const isSeparator = node.type === 'separator';

                let roleClass = node.role || 'separator';
                let icon = node.role === 'user' ? 'U' : node.role === 'assistant' ? 'A' : 'â€”';
                let label = node.preview ? node.preview.slice(0, 10) : (isSeparator ? 'åˆ†éš”ç¬¦' : '');

                let badges = '';
                if (node.versionCount && node.versionCount > 1) {
                    badges += `<div class="node-badge">${node.versionCount}</div>`;
                }
                if (node.children.length > 1) {
                    badges += `<div class="node-branch-badge">${node.children.length}</div>`;
                }

                // èŠ‚ç‚¹å®šä½ï¼špos æ˜¯ä¸­å¿ƒç‚¹ï¼Œéœ€è¦åç§»ä½¿èŠ‚ç‚¹å±…ä¸­
                const nodeLeft = pos.x - LAYOUT.nodeWidth / 2;
                const nodeTop = pos.y;

                nodesHtml += `
                    <div class="tree-node" data-id="${id}"
                        style="left: ${nodeLeft}px; top: ${nodeTop}px; width: ${LAYOUT.nodeWidth}px;">
                        <div class="node-circle ${roleClass} ${isOnWorldLine ? 'worldline' : ''} ${isSelected ? 'active' : ''}">
                            ${icon}
                            ${badges}
                        </div>
                        <div class="node-label" title="${escapeHtml(label)}">${escapeHtml(label)}</div>
                    </div>
                `;
            }
            $treeNodes.innerHTML = nodesHtml;

            // æ›´æ–°ä¿¡æ¯
            $treeInfo.textContent = `æ€»èŠ‚ç‚¹: ${Object.keys(nodes).length} | å½“å‰ä¸–ç•Œçº¿: ${worldLine.length}`;

            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            $treeNodes.querySelectorAll('.tree-node').forEach(el => {
                el.addEventListener('click', () => {
                    const id = el.getAttribute('data-id');
                    selectNode(id);
                });
            });
        }

        /**
         * é€‰ä¸­èŠ‚ç‚¹
         */
        function selectNode(id) {
            selectedNodeId = id;

            // æ›´æ–°èŠ‚ç‚¹é«˜äº®
            $treeNodes.querySelectorAll('.node-circle').forEach(el => {
                el.classList.remove('active');
            });
            const nodeEl = $treeNodes.querySelector(`[data-id="${id}"] .node-circle`);
            if (nodeEl) nodeEl.classList.add('active');

            // æ˜¾ç¤ºè¯¦æƒ…
            const node = treeData?.nodes?.[id];
            if (!node) return;

            const worldLineSet = new Set(treeData.worldLine);
            const isOnWorldLine = worldLineSet.has(id);
            const isLeaf = node.children.length === 0;

            $detailContent.innerHTML = `
                <div class="detail-section">
                    <div class="detail-section-title">åŸºæœ¬ä¿¡æ¯</div>
                    <div class="detail-field">
                        <span class="detail-field-label">ID</span>
                        <span class="detail-field-value">${id}</span>
                    </div>
                    <div class="detail-field">
                        <span class="detail-field-label">ç±»å‹</span>
                        <span class="detail-field-value">${node.type === 'message' ? 'æ¶ˆæ¯' : 'åˆ†éš”ç¬¦'}</span>
                    </div>
                    ${node.role ? `
                    <div class="detail-field">
                        <span class="detail-field-label">è§’è‰²</span>
                        <span class="detail-field-value">${node.role === 'user' ? 'ç”¨æˆ·' : 'åŠ©æ‰‹'}</span>
                    </div>
                    ` : ''}
                    ${node.author ? `
                    <div class="detail-field">
                        <span class="detail-field-label">ä½œè€…</span>
                        <span class="detail-field-value">${node.author}</span>
                    </div>
                    ` : ''}
                    ${node.timestamp ? `
                    <div class="detail-field">
                        <span class="detail-field-label">æ—¶é—´</span>
                        <span class="detail-field-value">${new Date(node.timestamp).toLocaleString()}</span>
                    </div>
                    ` : ''}
                </div>

                <div class="detail-section">
                    <div class="detail-section-title">ç»“æ„ä¿¡æ¯</div>
                    <div class="detail-field">
                        <span class="detail-field-label">çˆ¶èŠ‚ç‚¹</span>
                        <span class="detail-field-value">${node.parent || '(æ ¹èŠ‚ç‚¹)'}</span>
                    </div>
                    <div class="detail-field">
                        <span class="detail-field-label">å­èŠ‚ç‚¹</span>
                        <span class="detail-field-value">${node.children.length} ä¸ª</span>
                    </div>
                    ${node.versionCount ? `
                    <div class="detail-field">
                        <span class="detail-field-label">ç‰ˆæœ¬æ•°</span>
                        <span class="detail-field-value">${node.versionCount}</span>
                    </div>
                    ` : ''}
                    <div class="detail-field">
                        <span class="detail-field-label">ä¸–ç•Œçº¿</span>
                        <span class="detail-field-value">${isOnWorldLine ? 'âœ“ åœ¨å½“å‰ä¸–ç•Œçº¿' : 'âœ— ä¸åœ¨å½“å‰ä¸–ç•Œçº¿'}</span>
                    </div>
                </div>

                ${node.preview ? `
                <div class="detail-section">
                    <div class="detail-section-title">å†…å®¹é¢„è§ˆ</div>
                    <div class="detail-preview">${escapeHtml(node.preview)}</div>
                </div>
                ` : ''}
            `;

            // æ˜¾ç¤ºæ“ä½œæŒ‰é’®ï¼ˆä»…å¶å­èŠ‚ç‚¹ä¸”ä¸åœ¨å½“å‰ä¸–ç•Œçº¿æ—¶å¯åˆ‡æ¢ï¼‰
            if (isLeaf && !isOnWorldLine) {
                $detailActions.style.display = 'flex';
            } else {
                $detailActions.style.display = 'none';
            }
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/[&<>"']/g, c => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            }[c]));
        }

        // ============ äº‹ä»¶å¤„ç† ============

        document.getElementById('btn-fit').addEventListener('click', () => {
            // é€‚åº”çª—å£ï¼šæ»šåŠ¨åˆ°æ°´å¹³å±…ä¸­ï¼Œå‚ç›´é¡¶éƒ¨
            const container = $treeContainer;
            const canvas = $treeCanvas;
            const scrollLeft = Math.max(0, (canvas.offsetWidth - container.offsetWidth) / 2);
            container.scrollTo({
                left: scrollLeft,
                top: 0,
                behavior: 'smooth'
            });
        });

        document.getElementById('btn-center').addEventListener('click', () => {
            if (!treeData?.rootId) return;
            const pos = nodePositions.get(treeData.rootId);
            if (pos) {
                $treeContainer.scrollTo({
                    left: Math.max(0, pos.x - $treeContainer.offsetWidth / 2),
                    top: 0,
                    behavior: 'smooth'
                });
            }
        });

        document.getElementById('detail-close').addEventListener('click', () => {
            selectedNodeId = null;
            $treeNodes.querySelectorAll('.node-circle').forEach(el => {
                el.classList.remove('active');
            });
            $detailContent.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸŒ³</div>
                    <div class="empty-state-text">ç‚¹å‡»èŠ‚ç‚¹æŸ¥çœ‹è¯¦æƒ…</div>
                </div>
            `;
            $detailActions.style.display = 'none';
        });

        document.getElementById('btn-switch-worldline').addEventListener('click', () => {
            if (!selectedNodeId) return;
            if (window.pluginSdk?.switchWorldLine) {
                window.pluginSdk.switchWorldLine(selectedNodeId);
            } else {
                console.log('Switch worldline to:', selectedNodeId);
                window.pluginSdk?.showMessage?.('å·²è¯·æ±‚åˆ‡æ¢ä¸–ç•Œçº¿: ' + selectedNodeId);
            }
        });

        // ============ åˆå§‹åŒ– ============

        window.addEventListener('pluginSdkReady', async () => {
            const themeMode = window.pluginSdk?.themeMode || 'light';
            document.documentElement.setAttribute('data-theme-mode', themeMode);

            if (window.pluginSdk?.getTreeData) {
                const data = await window.pluginSdk.getTreeData();
                renderTree(data);
            }
        });

        // ç›‘å¬å¤–éƒ¨æ•°æ®æ›´æ–°äº‹ä»¶
        window.addEventListener('treeDataUpdate', (e) => {
            renderTree(e.detail);
        });

        // æš´éœ²æ¸²æŸ“æ–¹æ³•ä¾›å¤–éƒ¨è°ƒç”¨
        window.renderTree = renderTree;
    </script>
</body>

</html>