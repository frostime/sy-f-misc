<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Editor</title>
    <!-- CodeMirror 5 核心样式 -->
    <link rel="stylesheet" href="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <!-- 代码提示样式 -->
    <link rel="stylesheet" href="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.css">
    <!-- 主题样式 -->
    <link rel="stylesheet" href="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">
    <link rel="stylesheet" href="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/codemirror/5.65.16/theme/eclipse.min.css">

    <style>
        :root {
            --font-size-normal: 14px;
            --bg-primary: #ffffff;
            --text-primary: #333333;
            --border-color: #e0e0e0;
            --accent-color: #d23f31;
            --success-color: #34a853;
        }

        * {
            box-sizing: border-box;
            outline: none;
        }

        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: var(--theme-background, var(--bg-primary));
            color: var(--theme-on-background, var(--text-primary));
            font-family: var(--font-family, sans-serif);
            overflow: hidden;
        }

        /* 提升提示框层级，防止被遮挡 */
        .CodeMirror-hints {
            z-index: 99999 !important;
            font-family: var(--font-family-code, monospace);
        }

        .toolbar {
            flex-shrink: 0;
            height: 42px;
            display: flex;
            align-items: center;
            padding: 0 12px;
            border-bottom: 1px solid var(--theme-surface-lighter, var(--border-color));
            background-color: var(--theme-surface, #f5f5f5);
            gap: 12px;
            user-select: none;
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .divider {
            width: 1px;
            height: 20px;
            background-color: var(--theme-surface-lighter, var(--border-color));
        }

        .control-label {
            font-size: 12px;
            color: var(--theme-on-surface-light, #888);
            margin-right: 4px;
        }

        select,
        input[type="number"] {
            background: var(--theme-background, #fff);
            color: var(--theme-on-background, #333);
            border: 1px solid var(--theme-surface-lighter, #ccc);
            border-radius: 4px;
            padding: 4px 6px;
            font-size: 13px;
            height: 28px;
            transition: border-color 0.2s;
        }

        select:focus,
        input:focus {
            border-color: var(--theme-primary, var(--accent-color));
        }

        select:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: var(--theme-surface-light, #eee);
        }

        input[type="number"] {
            width: 50px;
        }

        button {
            height: 28px;
            padding: 0 12px;
            border: 1px solid var(--theme-surface-lighter, #ccc);
            background: var(--theme-surface-light, #fff);
            color: var(--theme-on-surface, #333);
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        button:hover {
            background: var(--theme-surface-lighter, #eee);
            border-color: var(--theme-primary, var(--accent-color));
        }

        button.primary {
            background: var(--theme-primary, var(--accent-color));
            color: var(--theme-on-primary, #fff);
            border-color: var(--theme-primary, var(--accent-color));
        }

        button.primary:hover {
            opacity: 0.9;
        }

        button.icon-only {
            width: 28px;
            padding: 0;
            justify-content: center;
        }

        #editor-wrapper {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .CodeMirror {
            height: 100%;
            font-family: var(--font-family-code, monospace);
            line-height: 1.6;
        }

        [data-theme-mode="dark"] .CodeMirror-scroll {
            background-color: var(--theme-background);
        }

        .statusbar {
            flex-shrink: 0;
            height: 26px;
            background-color: var(--theme-primary, #d23f31);
            color: var(--theme-on-primary, #fff);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 12px;
            font-size: 12px;
            font-family: var(--font-family-code, monospace);
        }

        .toast {
            position: fixed;
            top: 50px;
            right: 20px;
            padding: 8px 16px;
            background: var(--theme-surface, #fff);
            border-left: 4px solid var(--theme-primary, #d23f31);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            border-radius: 2px;
            z-index: 9999;
            transform: translateX(120%);
            transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            font-size: 13px;
            display: flex;
            align-items: center;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            border-left-color: var(--success-color, #34a853);
        }

        .icon {
            width: 14px;
            height: 14px;
            fill: currentColor;
        }

        .loading-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--theme-primary, #d23f31);
        }

        .loading-indicator::before {
            content: "●";
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
    </style>
</head>

<body>

    <div class="toolbar">
        <div class="toolbar-group">
            <span class="control-label">语言</span>
            <select id="langSelect">
                <option value="">Plain Text</option>
                <option value="markdown">Markdown</option>
                <option value="javascript">JavaScript</option>
                <option value="typescript">TypeScript</option>
                <option value="python">Python</option>
                <option value="java">Java</option>
                <option value="cpp">C++</option>
                <option value="htmlmixed">HTML</option>
                <option value="css">CSS</option>
                <option value="xml">XML</option>
                <option value="application/json">JSON</option>
                <option value="sql">SQL</option>
            </select>
            <span id="loadingIndicator" class="loading-indicator" style="display:none;">加载中</span>
        </div>

        <div class="divider"></div>

        <div class="toolbar-group">
            <span class="control-label">字号</span>
            <button class="icon-only" id="fontSizeDec" title="减小字号">－</button>
            <input type="number" id="fontSize" value="16" min="10" max="48" step="1">
            <button class="icon-only" id="fontSizeInc" title="增大字号">＋</button>
            <span class="control-label" style="margin-left:2px">px</span>
        </div>

        <div class="divider"></div>

        <div class="toolbar-group" style="margin-left: auto;">
            <button id="clearBtn">
                <svg class="icon" viewBox="0 0 1024 1024">
                    <path d="M899.1 869.6l-53-305.6H864c14.4 0 26-11.6 26-26V346c0-14.4-11.6-26-26-26H618V96c0-14.4-11.6-26-26-26H432c-14.4 0-26 11.6-26 26v224H160c-14.4 0-26 11.6-26 26v192c0 14.4 11.6 26 26 26h17.9l-53 305.6c-0.3 1.5-0.4 3-0.4 4.4 0 14.4 11.6 26 26 26h723c1.5 0 3-0.1 4.4-0.4 14.2-2.4 23.7-15.9 21.2-30zM204 390h276c4.4 0 8-3.6 8-8v-62h48v62c0 4.4 3.6 8 8 8h276v108H204V390z m126 464L376 568h272l46 286H330z"></path>
                </svg>
                清空
            </button>
            <button id="saveBtn" class="primary">
                <svg class="icon" viewBox="0 0 1024 1024">
                    <path d="M893.3 293.3L730.7 130.7c-7.5-7.5-16.7-13-26.7-16V112H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V320c-2.8-10-8.5-19.2-16.7-26.7zM848 848H176V176h128v224c0 17.7 14.3 32 32 32h352c17.7 0 32-14.3 32-32V176h102.1L848 301.9V848zM576 432H368V176h208v256z"></path>
                </svg>
                保存
            </button>
        </div>
    </div>

    <div id="editor-wrapper">
        <textarea id="code"></textarea>
    </div>

    <div class="statusbar">
        <span id="cursorPos">Ln 1, Col 1</span>
        <span id="langDisplay">Plain Text</span>
    </div>

    <div id="toast" class="toast">操作成功</div>

    <!-- CodeMirror 核心 -->
    <script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <!-- 核心插件 -->
    <script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/codemirror/5.65.16/addon/selection/active-line.min.js"></script>
    <script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>
    <script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>
    <!-- 代码提示核心 -->
    <script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.js"></script>
    <!-- 通用单词补全 (作为 fallback) -->
    <script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/codemirror/5.65.16/addon/hint/anyword-hint.min.js"></script>

    <script>
        const CDN_BASE = "https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/codemirror/5.65.16";

        let editor;
        let config = {
            langType: '',
            fontSize: 16,
            fontFamily: ''
        };
        let allowSwitch = true;
        const loadedScripts = new Set();

        // 语言资源配置表 (包含依赖顺序)
        const MODE_RESOURCES = {
            'markdown': {
                mode: 'markdown',
                scripts: [`${CDN_BASE}/mode/markdown/markdown.min.js`],
                hint: 'anyword' // Markdown 使用单词补全
            },
            'javascript': {
                mode: 'javascript',
                scripts: [
                    `${CDN_BASE}/mode/javascript/javascript.min.js`,
                    `${CDN_BASE}/addon/hint/javascript-hint.min.js`
                ],
                hint: 'javascript'
            },
            'typescript': {
                mode: { name: 'javascript', typescript: true },
                scripts: [
                    `${CDN_BASE}/mode/javascript/javascript.min.js`,
                    `${CDN_BASE}/addon/hint/javascript-hint.min.js`
                ],
                hint: 'javascript'
            },
            'python': {
                mode: 'python',
                scripts: [
                    `${CDN_BASE}/mode/python/python.min.js`
                    // 使用已加载的 anyword-hint
                ],
                hint: 'anyword'
            },
            'java': {
                mode: 'text/x-java',
                scripts: [`${CDN_BASE}/mode/clike/clike.min.js`],
                hint: 'anyword'
            },
            'cpp': {
                mode: 'text/x-c++src',
                scripts: [`${CDN_BASE}/mode/clike/clike.min.js`],
                hint: 'anyword'
            },
            'htmlmixed': {
                mode: 'htmlmixed',
                scripts: [
                    `${CDN_BASE}/mode/xml/xml.min.js`,
                    `${CDN_BASE}/mode/javascript/javascript.min.js`,
                    `${CDN_BASE}/mode/css/css.min.js`,
                    `${CDN_BASE}/mode/htmlmixed/htmlmixed.min.js`,
                    `${CDN_BASE}/addon/hint/xml-hint.min.js`,
                    `${CDN_BASE}/addon/hint/html-hint.min.js`
                ],
                hint: 'html'
            },
            'css': {
                mode: 'css',
                scripts: [
                    `${CDN_BASE}/mode/css/css.min.js`,
                    `${CDN_BASE}/addon/hint/css-hint.min.js`
                ],
                hint: 'css'
            },
            'xml': {
                mode: 'xml',
                scripts: [
                    `${CDN_BASE}/mode/xml/xml.min.js`,
                    `${CDN_BASE}/addon/hint/xml-hint.min.js`
                ],
                hint: 'xml'
            },
            'application/json': {
                mode: 'application/json',
                scripts: [`${CDN_BASE}/mode/javascript/javascript.min.js`],
                hint: null // JSON 通常不需要提示，或使用 anyword
            },
            'sql': {
                mode: 'text/x-sql',
                scripts: [
                    `${CDN_BASE}/mode/sql/sql.min.js`,
                    `${CDN_BASE}/addon/hint/sql-hint.min.js`
                ],
                hint: 'sql'
            }
        };

        // UI 元素
        const langSelect = document.getElementById('langSelect');
        const fontSizeInput = document.getElementById('fontSize');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const cursorPosEl = document.getElementById('cursorPos');
        const langDisplayEl = document.getElementById('langDisplay');
        const toastEl = document.getElementById('toast');

        // SDK 初始化
        window.addEventListener('pluginSdkReady', async () => {
            const sdk = window.pluginSdk;
            const themeMode = sdk.themeMode || 'light';
            document.documentElement.setAttribute('data-theme-mode', themeMode);

            const savedConfig = await sdk.loadConfig() || {};
            config.langType = sdk.langType || savedConfig.langType || '';
            config.fontSize = savedConfig.fontSize || 16;
            allowSwitch = (sdk.allowSwitch !== undefined) ? sdk.allowSwitch : true;

            // 字体配置
            config.fontFamily = savedConfig.fontFamily || sdk.styleVar['font-family-code'] ||
                'Consolas, Monaco, "Andale Mono", "Ubuntu Mono", monospace';

            initUI();
            await initEditor(themeMode);
            loadContent();
        });

        function initUI() {
            langSelect.value = config.langType;
            if (!allowSwitch) {
                langSelect.disabled = true;
                langSelect.title = "语言切换已被锁定";
            }
            fontSizeInput.value = config.fontSize;

            // 事件监听
            langSelect.addEventListener('change', (e) => setLanguage(e.target.value));

            // 字号控制
            const updateFont = (size) => {
                size = Math.max(10, Math.min(64, parseInt(size) || 16));
                fontSizeInput.value = size;
                setFontSize(size);
            };

            fontSizeInput.addEventListener('change', (e) => updateFont(e.target.value));
            document.getElementById('fontSizeDec').addEventListener('click', () => updateFont(config.fontSize - 1));
            document.getElementById('fontSizeInc').addEventListener('click', () => updateFont(config.fontSize + 1));

            // 按钮操作
            document.getElementById('saveBtn').addEventListener('click', saveContent);
            document.getElementById('clearBtn').addEventListener('click', () => {
                if (confirm('确认清空所有内容？')) {
                    editor.setValue('');
                    editor.focus();
                }
            });

            // 快捷键
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    saveContent();
                }
            });
        }

        async function initEditor(themeMode) {
            const cmTheme = (themeMode === 'dark') ? 'dracula' : 'eclipse';

            editor = CodeMirror.fromTextArea(document.getElementById('code'), {
                mode: null, // 稍后加载
                theme: cmTheme,
                lineNumbers: true,
                lineWrapping: true,
                styleActiveLine: true,
                matchBrackets: true,
                autoCloseBrackets: true,
                indentUnit: 4,
                tabSize: 4,
                indentWithTabs: true,
                extraKeys: {
                    "Tab": (cm) => {
                        if (cm.somethingSelected()) cm.indentSelection("add");
                        else cm.replaceSelection("\t", "end");
                    },
                    "Ctrl-Space": "autocomplete" // 手动触发
                },
                hintOptions: { completeSingle: false }
            });

            setFontSize(config.fontSize);
            editor.getWrapperElement().style.fontFamily = config.fontFamily;

            // --- 核心：自动补全触发逻辑 ---
            editor.on('inputRead', (cm, change) => {
                if (change.origin !== '+input') return;

                // 排除非单词字符输入（如空格、分号等）
                if (change.text[0].match(/\w|\./)) {
                    // 只有当 hint 功能已正确加载并配置时才调用
                    if (cm.options.hintOptions && cm.options.hintOptions.hint) {
                        cm.showHint({ completeSingle: false });
                    }
                }
            });

            editor.on('cursorActivity', updateCursorPos);
            updateStatusBar();

            // 初始加载
            if (config.langType) {
                await loadModeResources(config.langType);
            }
        }

        async function loadContent() {
            try {
                const text = await window.pluginSdk.getText();
                if (text) {
                    editor.setValue(text);
                    editor.clearHistory();
                }
            } catch (e) {}
        }

        async function saveContent() {
            try {
                const val = editor.getValue();
                const ok = await window.pluginSdk.setText(val);
                if (ok) showToast('保存成功', 'success');
                else showToast('保存失败', 'error');
            } catch (e) {
                showToast('保存出错: ' + e.message, 'error');
            }
        }

        async function setLanguage(lang) {
            if (!allowSwitch && lang !== config.langType) return;
            config.langType = lang;
            await loadModeResources(lang);
            updateStatusBar();
            saveConfig();
        }

        // --- 核心：按需加载资源与 Hint 配置 ---
        async function loadModeResources(lang) {
            // 重置
            if (!lang) {
                editor.setOption('mode', null);
                editor.setOption('hintOptions', { completeSingle: false }); // 清除 hint
                return;
            }

            const resource = MODE_RESOURCES[lang];
            if (!resource) return; // 未知语言，不做处理

            loadingIndicator.style.display = 'inline-flex';

            try {
                // 1. 并行加载脚本
                await Promise.all(resource.scripts.map(loadScript));

                // 2. 设置语言模式
                editor.setOption('mode', resource.mode);

                // 3. 设置智能提示 (Hint)
                let hintFunc = null;
                if (resource.hint && CodeMirror.hint[resource.hint]) {
                    hintFunc = CodeMirror.hint[resource.hint];
                } else if (resource.hint === 'anyword') {
                    // 兜底：如果指定anyword或脚本加载失败，尝试用 anyword
                    hintFunc = CodeMirror.hint.anyword;
                }

                if (hintFunc) {
                    editor.setOption('hintOptions', {
                        hint: hintFunc,
                        completeSingle: false
                    });
                } else {
                    // 清除 hint 以免报错
                    editor.setOption('hintOptions', { completeSingle: false });
                }

            } catch (err) {
                showToast(`资源加载失败: ${lang}`, 'error');
                console.error(err);
            } finally {
                loadingIndicator.style.display = 'none';
                editor.refresh();
            }
        }

        function loadScript(url) {
            if (loadedScripts.has(url)) return Promise.resolve();
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = url;
                script.async = true;
                script.onload = () => { loadedScripts.add(url); resolve(); };
                script.onerror = () => reject(new Error(url));
                document.body.appendChild(script);
            });
        }

        function setFontSize(size) {
            config.fontSize = size;
            editor.getWrapperElement().style.fontSize = size + 'px';
            editor.refresh();
            saveConfig();
        }

        function updateCursorPos() {
            const pos = editor.getCursor();
            const count = editor.getValue().length;
            cursorPosEl.textContent = `Ln ${pos.line + 1}, Col ${pos.ch + 1} | Len ${count}`;
        }

        function updateStatusBar() {
            const opt = langSelect.options[langSelect.selectedIndex];
            langDisplayEl.textContent = opt ? opt.text : 'Plain Text';
        }

        function saveConfig() {
            window.pluginSdk.saveConfig({
                langType: config.langType,
                fontSize: config.fontSize
            });
        }

        function showToast(msg, type = 'info') {
            toastEl.textContent = msg;
            toastEl.className = 'toast show ' + type;
            setTimeout(() => toastEl.classList.remove('show'), 2000);
        }
    </script>
</body>

</html>
